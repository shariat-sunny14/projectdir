{% extends 'base_form/main_base/main_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load get_notification_data %}
{% block extra_link %}
<!--========== CSS ==========-->
<link rel="stylesheet" href="{% static 'item_pos_style/css/item_pos_style.css' %}">
{% endblock %}
<!--========== CONTENTS start==========-->
{% block body %}
<!-- loader start -->
<section>
    <div class="loader-body">
        <div class="loader">
            <div class="upper ball"></div>
            <div class="right ball"></div>
            <div class="lower ball"></div>
            <div class="left ball"></div>
        </div>
    </div>
</section>
<!-- loader end -->
<main>
    <section style="display: flex; background: #f6f6f6bf;">
        <!-- main pos body -->
        <section class="container-fluid" style="margin-top: 0.5rem; margin-bottom:0.5rem;">
            <section style="border: 1px solid rgba(0, 0, 0, .125); border-top: none; border-radius: 0.3rem;">
                <div style="border: 1px solid rgba(0, 0, 0, .125);
                    margin-bottom: 0.5rem;
                    border-left: none;
                    border-right: none;
                    border-top-left-radius: 0.3rem;
                    border-top-right-radius: 0.3rem;
                    background: #455697;">
                    <!-- Main Heading -->
                    <div class="row">
                        <div class="col col-md-4 col-md-6 dashboar-head" style="display:flex; align-items: center;">
                            <div class="d-sm-flex align-items-center mb-2" style="height: auto; width: 100%; margin-left: 1rem;">
                                <div class="col-md-1" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: flex-start; align-items: center;">
                                    <i class='bx bx-credit-card text-white req-head-icon'></i>
                                    <h1 class="h3 text-white req-head">Billing</h1>
                                </div>
                                <!--  -->
                                <div class="col-md-11" style="display: flex; padding-right: 10px; justify-content: flex-end; flex-wrap: wrap; align-content: center; align-items: center;">
                                    <!--  -->
                                    <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                        {% if del_chal_access %}
                                            {% with org_id_str=user.org_id|stringformat:"s" branch_id_str=user.branch_id|stringformat:"s" %}
                                                {% with org_branch_key=org_id_str|add:"_"|add:branch_id_str %}
                                                    {% with invoice_data=grouped_invoice|get_invoice_pending_item:org_branch_key %}
                                                        <span id="delChalanNotify" onClick="navigateTo('/delivery_chalan_services/')" class="btnNotify">
                                                            {% if invoice_data %}
                                                                {{ invoice_data|get_invoice_pending_item:"pen_del_chalan_count"|default:"0"|format_99plus_count }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </span>
                                                    {% endwith %}
                                                {% endwith %}
                                            {% endwith %}
                                            <button type="button" onClick="navigateTo('/delivery_chalan_services/')" title="Delivery Chalan"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bxs-truck icon-front'></i> Chalan
                                            </button>
                                        {% endif %}
                                    </div>
                                    <!--  -->
                                    {% with user_org_str=user.org_id|stringformat:"s" %}
                                        <!--  -->
                                        <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                            {% if stock_recon_access %}
                                                {% if user.is_staff %}
                                                    <span id="trans_notify" onClick="navigateTo('/stock_reconciliation_service/')" class="btnNotify">
                                                        {{ grouped_stock_recon|get_total_notifications:user_org_str|default:"0"|format_99plus_count }}
                                                    </span>
                                                {% endif %}
                                                <button type="button" onClick="navigateTo('/stock_reconciliation_service/')" title="Stock Reconciliation"
                                                    class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                    style="display: flex; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                    <i class='bx bxs-book-content icon-front'></i>Stock Reconciliation
                                                </button>
                                            {% endif %}
                                        </div>
                                        <!--  -->
                                        <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                            {% if store_trans_access %}
                                                {% if user.is_staff %}
                                                    <span id="trans_notify" onClick="navigateTo('/stock_store_transfer_list_services/')" class="btnNotify">
                                                        {{ grouped_trans|get_total_notifications:user_org_str|default:"0"|format_99plus_count }}
                                                    </span>
                                                {% endif %}
                                                <button type="button" onClick="navigateTo('/stock_store_transfer_list_services/')" title="Store Transfer List"
                                                    class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                    style="display: flex; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                    <i class='bx bx-transfer icon-front'></i> Store Transfer List
                                                </button>
                                            {% endif %}
                                        </div>
                                        <!--  -->
                                        {% if cus_reg_access %}
                                            <button type="button" onClick="navigateTo('/customer_registration_services/')" title="Customer Registrations"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bxs-user-plus icon-front' ></i> Reg.
                                            </button>
                                        {% endif %}
                                        <!-- M. R. Rec. -->
                                        <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                            {% if manu_ret_rec_access %}
                                                {% if user.is_staff %}
                                                    <span id="mretrec_notify" onClick="navigateTo('/manual_return_receive_service/')" class="btnNotify">
                                                        {{ grouped_mretrec|get_total_notifications:user_org_str|default:"0"|format_99plus_count }}
                                                    </span>
                                                {% endif %}
                                                <button type="button" onClick="navigateTo('/manual_return_receive_service/')" title="Manually Item Return Receice"
                                                    class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                    style="display: flex;  font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                    <i class='bx bx-rotate-left icon-front' ></i> Manual Return Rec.
                                                </button>
                                            {% endif %}
                                        </div>
                                        <!--  -->
                                        <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                            {% if lp_rec_access %}
                                                {% if user.is_staff %}
                                                    <span id="lp_notify" onClick="navigateTo('/local_purchase_approval_list/')" class="btnNotify">
                                                        {{ grouped_lp|get_total_notifications:user_org_str|default:"0"|format_99plus_count }}
                                                    </span>
                                                {% endif %}
                                                <button type="button" onClick="navigateTo('/local_purchase_list_service/')" title="Local Purchase (LP) Receive"
                                                    class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                    style="display: flex; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                    <i class='bx bxs-backpack icon-front'></i> LP Received
                                                </button>
                                            {% endif %}
                                        </div>
                                        <!--  -->
                                        {% if lp_ret_access %}
                                            <button type="button" onClick="navigateTo('/local_purchase_return_list/')" title="Local Purchase (LP) Return"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bxs-package icon-front'></i> LP Return
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        <div class="bill-access-notifyBtn" style="display: flex; margin: 5px; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;">
                                            {% if grn_access %}
                                                {% if user.is_staff %}
                                                    <span id="grn_notify" onClick="navigateTo('/stock_receive_without_grn_list/')" class="btnNotify">
                                                        {{ grouped_grn|get_total_notifications:user_org_str|default:"0"|format_99plus_count }}
                                                    </span>
                                                {% endif %}
                                                <button type="button" onClick="navigateTo('/stock_receive_without_grn_list/')" title="Good Receive Note (GRN) List"
                                                    class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                    style="display: flex; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                    <i class='bx bx-file icon-front'></i> GRN List
                                                </button>
                                            {% endif %}
                                        </div>
                                        <!--  -->
                                        {% if pou_access %}
                                            <button type="button" onClick="navigateTo('/post_order_update_services/')" title="Invoice Update"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bx-edit icon-front'></i> Inv. Update
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        {% if can_due_access %}
                                            <button type="button" onClick="navigateTo('/due_refund_cancel_services/')" title="Item Cancel, Due Collection, Refund"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bx-x-circle icon-front'></i> Cancel/ Due Coll./ Refund
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        {% if sales_rep_access %}
                                            <button type="button" onClick="navigateTo('/sales_report_services/')" title="Sales Report"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bx-dollar icon-front'></i> Sales Coll.
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        {% if coll_rep_access %}
                                            <button type="button" onClick="navigateTo('/collections_reports/')" title="Collection Report"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bx-trending-down icon-front'></i> Collection
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        {% if due_rep_access %}
                                            <button type="button" onClick="navigateTo('/due_reports/')" title="Due Report"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn">
                                                <i class='bx bx-alarm icon-front'></i> Due Coll.
                                            </button>
                                        {% endif %}
                                        <!--  -->
                                        {% if inv_list_access %}
                                            <button type="button" onClick="navigateTo('/invoice_list/')" title="Invoice List"
                                                class="btn billingBtnBgHover col-ms-3 text-white btn-xs item_payment_btn"
                                                style="display: flex; margin: 5px; font-weight: bolder; box-shadow: 4px 2px 5px 2px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff;">
                                                <i class='bx bxs-file-blank icon-front'></i> Invoice
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--  -->
                <section style="display: flex; width: 100%;">
                    <!--  -->
                    <!-- favorite list navbar -->
                    <section id="id_myfavBtn" style="display: block;">
                        <div style="height: 99%;">
                            <button class="btn text-white vertical-text myFavBtn" type="button">
                                Favorite List
                            </button>
                        </div>
                    </section>
                    <section id="id_myfavList"
                        style="width: 30%; display: none; margin-left: 0.3rem; margin-bottom: 0.5rem; background: rgb(212, 220, 255); border: 1px solid rgb(182 196 255); border-radius: 0.25rem;">
                        <!--  -->
                        <section>
                            <div>
                                <div class="favlist-header">
                                    <h5 class="fav-title" id="id_fav_title">Favorite List</h5>
                                    <button type="button" class="btn-close text-white"></button>
                                </div>
                                <div class="favlist-body" style="height: 130vh;">
                                    <div class="fav-itemTable">
                                        <table id="listOfItem" class="table table-striped table-hover" style="width: 100%;">
                                            <thead class="text-center fav-table-header" style="border-style: none;">
                                                <tr>
                                                    <th colspan="3"
                                                        style="text-align:center; background: #d4dcff !important;">
                                                        <input type="search" id="searchfavlist"
                                                            class="form-control search_control fav-search-input"
                                                            style="background:#fffab6;" placeholder="Searching Item ..."
                                                            autocomplete="off">
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="favItemTB" class="table-body-row favItemTbody" style="border-style: none !important;">
                                                <!-- load ajax value -->

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </section>
                    <!--  -->
                    <!-- form body -->
                    <section style="width: 100%; margin-left: 0.5rem; margin-right: 0.5rem;">
                        <form action="" id="pos-form">
                            <!-- billing mode radio button -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="radioBtnAlign" style="display: none;">
                                                                            <div class="form-check form-check-manual"
                                                                                style="margin-right: 1rem;">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="1"
                                                                                    name="general_bill"
                                                                                    id="id_general_bill"
                                                                                    onclick="resetInputFields();"
                                                                                    checked>
                                                                                <label class="form-check-label"
                                                                                    for="id_general_bill">
                                                                                    General Billing
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-manual">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="0"
                                                                                    name="b2b_clients"
                                                                                    id="id_b2b_clients" disabled>
                                                                                <label class="form-check-label"
                                                                                    for="id_b2b_clients">
                                                                                    B2B Clients
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="radioBtnAlign">
                                                                            <div class="form-check form-check-manual"
                                                                                style="margin-right: 1rem;">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="0"
                                                                                    name="non_register"
                                                                                    id="id_non_register">
                                                                                <label class="form-check-label"
                                                                                    for="id_non_register">
                                                                                    Non Register
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-manual">
                                                                                <input class="form-check-input" type="radio" value="1"
                                                                                    name="register" id="id_register" checked>
                                                                                <label class="form-check-label"
                                                                                    for="id_register">
                                                                                    Register
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- billing register buyer && B2B client searching -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="col-sm-12" style="display: flex;">
                                    <!--  -->
                                    <div class="col-sm-6">
                                        <div id="client_searchBody" style="display: none; margin-right: 0.3rem;">
                                            <div class="card main_pos_card">
                                                <div class="row cash_point_row">
                                                    <div class="col-sm-12">
                                                        <div class="card pos_card">
                                                            <div class="card-body pos_card_body">
                                                                <div class="row cash_point_row">
                                                                    <!--  -->
                                                                    <div class="card pos_card" id="client_searchInput"
                                                                        style="display: none;">
                                                                        <div class="card-body pos_card_body">
                                                                            <div class="row cash_point_row">
                                                                                <!--  -->
                                                                                <div
                                                                                    style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;  margin-bottom: 0.2rem;">
                                                                                    <div class="col-sm-10">
                                                                                        <fieldset>
                                                                                            <input type="text"
                                                                                                class="form-control pos_inputbox"
                                                                                                id="clients_name"
                                                                                                placeholder="Search B2B Clients"
                                                                                                style="background: #fffab6;">
                                                                                        </fieldset>
                                                                                    </div>
                                                                                </div>
                                                                                <!--  -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                    <div class="col-sm-6" style="margin-left: 0.4rem;">
                                        <div id="reg_searchBody" style="display: block;">
                                            <div class="card main_pos_card">
                                                <div class="row cash_point_row">
                                                    <div class="col-sm-12">
                                                        <div class="card pos_card">
                                                            <div class="card-body pos_card_body">
                                                                <div class="row cash_point_row">
                                                                    <!--  -->
                                                                    <div class="card pos_card" id="reg_searchInput"
                                                                        style="display: block;">
                                                                        <div class="card-body pos_card_body">
                                                                            <div class="row cash_point_row">
                                                                                <!--  -->
                                                                                <div
                                                                                    style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;  margin-bottom: 0.2rem;">
                                                                                    <div class="col-sm-10">
                                                                                        <input type="text"
                                                                                            class="form-control pos_inputbox"
                                                                                            id="register_customer"
                                                                                            placeholder="Search by CN / Name / Phone No"
                                                                                            style="background: #fffab6;">
                                                                                    </div>
                                                                                </div>
                                                                                <!--  -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                </div>
                            </section>
                            <!-- B2B Clients Information -->
                            <section id="b2b_clients_info" style="margin-bottom: 0.2rem; display: none;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-4">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_no" title="Client No"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Cl. No:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="hidden" class="form-control pos_inputbox" id="id_reg_id" name="reg_id" readonly>
                                                                                    <input type="hidden" class="form-control pos_inputbox" id="id_supplier_id" name="supplier_id" readonly>
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off"
                                                                                        id="id_client_no" placeholder="Client No" readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-8">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_name" title="Client Name"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Cl. Name:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_client_name"
                                                                                        name="client_name" placeholder="Client Name" readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-5">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_contact"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Contact:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="number"
                                                                                        class="form-control pos_inputbox"
                                                                                        autocomplete="off"
                                                                                        id="id_contact" name="contact"
                                                                                        readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-7">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_address"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Address:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <textarea type="text"
                                                                                        class="form-control pos_inputbox"
                                                                                        style="height: 1.55rem;"
                                                                                        autocomplete="off"
                                                                                        id="id_client_address"
                                                                                        name="client_address"
                                                                                        readonly></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <!-- org/cash point/branch/last inv no print btn -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="cash_point" title="Cash Point"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Cash Point:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <select id="cash_point" name="cash_point" class="form-select pos_inputbox">
                                                                                        <!--  -->
        
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_org" title="Organization Name"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Organization:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <select id="id_org" name="org" class="form-select pos_inputbox">
                                                                                        {% for org in org_list %}
                                                                                        <option value="{{ org.org_id }}"
                                                                                            id="{{ org.org_id }}">
                                                                                            {{ org.org_name }}
                                                                                        </option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_branchs" class="col-sm-2 col-form-label">
                                                                                    Branchs:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <select id="id_branchs" name="branchs" class="form-select pos_inputbox">
                                                                                        <!-- branch List -->
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        {% for sale in sale_data %}
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-evenly; align-items: center;">
                                                                                <label for="last_inv_no" class="col-sm-client-label col-form-label">
                                                                                    Last Inv.:
                                                                                </label>
                                                                                <div class="col-sm-client-input" style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center;">
                                                                                    <div class="col-sm-8">
                                                                                        <input type="text"
                                                                                            class="form-control pos_inputbox"
                                                                                            value="{{sale.inv_id}}" id="last_inv_no"
                                                                                            readonly>
                                                                                    </div>
                                                                                    <div class="col-sm-4" style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
                                                                                        <button type="button"
                                                                                            class="btn btn-primary text-white btn-xs last_invshowprntBtm view-data"
                                                                                            data-id="{{ sale.inv_id }}"
                                                                                            data-not-allow="{{ sale.is_carrcost_notapp|lower }}">Print</button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <section>
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-8">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="customer_name"
                                                                            class="col-sm-2 col-form-label">
                                                                            Customer's:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                value="General Customer" id="customer_name"
                                                                                name="customer_name" autocomplete="off"
                                                                                required>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_house_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            House No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_house_no"
                                                                                name="house_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_road_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Road No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_road_no" autocomplete="off"
                                                                                name="road_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_sector_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Sector No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_sector_no" name="sector_no"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_side_off_factory" style="color: #f15900; font-weight: 700;"
                                                                            class="col-sm-2 col-form-label">
                                                                             Side Office/Factory:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_side_off_factory" name="side_off_factory"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="mobile_number"
                                                                            class="col-sm-2 col-form-label">
                                                                            Mobile:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="number"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="mobile_number"
                                                                                name="mobile_number" required>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_area"
                                                                            class="col-sm-2 col-form-label">
                                                                            Area:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_area"
                                                                                name="area">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_floor_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Floor No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_floor_no"
                                                                                name="floor_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_order_no" style="color: #f15900; font-weight: 700;"
                                                                            class="col-sm-2 col-form-label">
                                                                            Order No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_order_no"
                                                                                name="order_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <!-- Credit Balance -->
                                                                    <div class="row cash_point_row" id="id_sales_type"
                                                                        style="display: none;">
                                                                        <label for="credit_balance"
                                                                            class="col-sm-2 text-danger col-form-label"
                                                                            style="font-weight: bolder;">
                                                                            Credit Bal. :
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <!--  -->
                                                                            <input type="number" id="credit_balance"
                                                                                name="credit_balance" value=""
                                                                                class="form-control pos_inputbox"
                                                                                style="display: none;">
                                                                            <span id="id_credit_balance" class="form-control item_inputbox text-success credit_balance">0.00</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-sm-4">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-12">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="gender"
                                                                            class="col-sm-2 col-form-label">Gender:</label>
                                                                        <div class="col-sm-8">
                                                                            <select id="gender" name="gender" class="form-select reg_wise_disable pos_inputbox"
                                                                                aria-label="Default select example">
                                                                                <option value="" selected disabled>
                                                                                    Choose Gender ...
                                                                                </option>
                                                                                <option value="Male">Male</option>
                                                                                <option value="Female">Female</option>
                                                                                <option value="Others">Others</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="emergency_person"
                                                                            class="col-sm-2 col-form-label">
                                                                            Emer. Person:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control pos_inputbox"
                                                                                id="emergency_person"
                                                                                name="emergency_person"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_emergency_phone"
                                                                            class="col-sm-2 col-form-label">
                                                                            Emer. Phone:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="number" class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_emergency_phone" name="emergency_phone">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row" id="id_sales_type">
                                                                        <label for="id_reg_balances"
                                                                            class="col-sm-2 text-danger col-form-label"
                                                                            style="font-weight: bolder;">
                                                                            Balance :
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <!--  -->
                                                                            <input type="hidden" id="id_reg_balances" name="reg_balances" value="" class="form-control pos_inputbox">
                                                                            <span id="reg_balances" class="form-control item_inputbox text-success credit_balance">0.00</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </section>
                            <!-- address/ add new items -->
                            <section style="margin-top: 0.3rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-8"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-12">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_address"
                                                                                    class="col-sm-1 col-form-label">
                                                                                    Address:
                                                                                </label>
                                                                                <div class="col-sm-10">
                                                                                    <textarea type="text" class="form-control reg_wise_disable pos_inputbox" id="id_address" name="address" autocomplete="off"
                                                                                        style="height: 2rem;"></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-4" style="display: flow; align-content: center; align-items: center;">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="row cash_point_row">
                                                                            <div style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: flex-end; align-items: center;">
                                                                                <!--  -->
                                                                                <div class="itemBtn col-sm-6" style="display: flex; width: fit-content; flex-direction: row; flex-wrap: nowrap; justify-content: flex-end;">
                                                                                    <button id="addNewRegBtn" type="button" class="btn btn-success text-white btn-xs newItemAddBtm" style="margin-top: 0px;">
                                                                                        Add New Customer
                                                                                    </button>
                                                                                </div>
                                                                                <!--  -->
                                                                                <div class="itemBtn col-sm-4" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: flex-end;">
                                                                                    <button id="addItemPosBtn" type="button" class="btn btn-warning text-white btn-xs newItemAddBtm">
                                                                                        Add New Items
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- driver carriers searching -->
                            <section id="b2b_clients_info" style="margin-top: 0.3rem; margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-4"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-12">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_carriers" class="col-sm-2 col-form-label" style="display: flex; font-size: 11.5px; flex-direction: row; justify-content: flex-end;">
                                                                                    Carriers:
                                                                                </label>
                                                                                <div class="col-md-cary">
                                                                                    <input type="search" class="form-control pos_inputbox" autocomplete="off" style="margin-top: 0px; height: 2rem; background: #fffab6;"
                                                                                        id="id_carriers" placeholder="Search Carrier's/Driver Name ...">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-8">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_driver_name" class="col-sm-2 col-form-label">
                                                                                    Carrier's Name:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="hidden" id="id_driver_id" name="driver_id">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_driver_name" name="driver_name">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_driver_mobile" class="col-sm-2 col-form-label">
                                                                                    Carrier's Mobile:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_driver_mobile" name="driver_mobile">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- driver carriers searching -->
                            <section>
                                <div class="col-xl-12">
                                    <div class="table-body item_table_body">
                                        <table id="item_add" class="table table-striped" style="width: 100%;">
                                            <tbody class="table-body-row" style="text-align:center;" id="POSaddItemTB">
                                                <tr style="border-style: hidden!important;">
                                                    <td
                                                        style="display: flex; text-align: left; justify-content: center; border-style: none; flex-direction: row; flex-wrap: wrap; align-content: center; align-items: center;">
                                                        <div class="col-sm-12 div_id_pos_item_name"
                                                            style="display: flex; justify-content: center; align-items: center;">
                                                            <div class="col-sm-8">
                                                                <!--  -->
                                                                <div class="col-sm-12">
                                                                    <!--  -->
                                                                    <div class="item_search-body">
                                                                        <div class="search-icon">
                                                                            <i class='bx bx-search'
                                                                                style="margin-top: 3px; color: aliceblue;"></i>
                                                                        </div>
                                                                        <!--  -->
                                                                        <!-- searching item list for pos -->
                                                                        <input type="search" id="positem_name"
                                                                            placeholder="Search..." value=""
                                                                            class="pos-control pos_item input_datalist pos_searchBox"
                                                                            autocomplete="off">
                                                                        <div class="speech-icon">
                                                                            <i class='bx bxs-microphone speech'></i>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!--  -->
                                                            <div class="col-sm-4">
                                                                <select id="id_filter_suppliers" name="filter_suppliers"
                                                                    class="form-select pos_inputbox">
                                                                    <!--  -->

                                                                </select>
                                                            </div>

                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <section>
                                <div class="col-xl-12">
                                    <div class="table-body item_table_body">
                                        <div class="d-flex w-100" id="POS-field">
                                            <table class="table table-striped" style="width: 100%;" id="mul_item_tbl">
                                                <thead class="text-center table-header_itemlist">
                                                    <tr style="border-style: hidden!important;">
                                                        <th style="text-align:center; width: 3%;"></th>
                                                        <th style="text-align:center; width: 3%;">Sl</th>
                                                        <th style="text-align:center;">Item No</th>
                                                        <th style="text-align:center; width: 25%;">Item Name</th>
                                                        <th style="text-align:center;">Type</th>
                                                        <th style="text-align:center; width: 10%;">Supplier</th>
                                                        <th style="text-align:center;">Stock</th>
                                                        <th style="text-align:center; width: 6%;">Qty</th>
                                                        <th style="text-align:center;">UoM</th>
                                                        <th style="text-align:center; width: 8%;">Discount</th>
                                                        <!-- <th style="text-align:center; width: 8%; display: none;" id="dupItemRateTbRow">Dup. Rate</th> -->
                                                        <th style="text-align:center; width: 8%;">S.Rate</th>
                                                        <th style="text-align:center; width: 8%;">Total</th>
                                                        <th style="text-align:center; width: 3%;">
                                                            opt.
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody id="mytbody">

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <section style="margin-bottom: 10px;">
                                <div class="row cash_point_row">
                                    <div class="col-sm-8">
                                        <div class="card main_pos_card">
                                            <div class="card-body pos_card_body">
                                                <div class="col-xl-12">
                                                    <div class="table-body item_table_body">
                                                        <table id="" class="table  paymode_table" style="width: 100%;">
                                                            <table id="" class="table  paymode_table"
                                                                style="width: 100%;">
                                                                <tbody>
                                                                    <tr style="border-style: hidden!important;">
                                                                        <td class="col-sm-12"
                                                                            style="display: flex; text-align:center; width: 100%; border-style: hidden!important;">
                                                                            <label for="discount_amt"
                                                                                class="col-sm-4 dis-label">
                                                                                Discount Amt:
                                                                            </label>
                                                                            <div class="col-sm-4" id="dis_input">
                                                                                <input type="number"
                                                                                    class="form-control disc_input pos_inputbox"
                                                                                    name="discount_amt"
                                                                                    id="discount_amt" value="0">
                                                                            </div>
                                                                            <!--  -->
                                                                            <label for="discount_perc"
                                                                                class="col-sm-4 dis-perc"
                                                                                style="text-align:center;width: 5%;">%</label>
                                                                            <div class="col-sm-4">
                                                                                <input type="number"
                                                                                    class="form-control disc_input pos_inputbox"
                                                                                    name="discount_perc"
                                                                                    id="discount_perc" value=""
                                                                                    readonly>
                                                                            </div>
                                                                        </td>
                                                                        <!--  -->
                                                                        <!--  -->
                                                                        <td style="text-align:center;width: 10%;">
                                                                            Tot Item:
                                                                        </td>
                                                                        <td style="text-align:center;width: 15%;">
                                                                            <div class="col-sm-12">
                                                                                <input type="text"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="tot_count_serial"
                                                                                    name="tot_count_serial"
                                                                                    style="text-align:center" readonly>
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 8%;">
                                                                            Tot Qty:
                                                                        </td>
                                                                        <td style="text-align:center;width: 15%;">
                                                                            <div class="col-sm-12" id="auto_sumQty">
                                                                                <input type="text"
                                                                                    class="form-control sum_qty_total pos_inputbox"
                                                                                    name="sum_qty" id="sum_qty"
                                                                                    style="text-align:center" value=""
                                                                                    readonly>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <!--  -->
                                                            <table id="" class="table  paymode_table"
                                                                style="width: 100%;">
                                                                <tbody>
                                                                    <tr style="display: flex; margin-right: 0px;">
                                                                        <td class="remarks-label"
                                                                            style="width: 11.5%; margin-right: 10px; border-style: hidden!important;">
                                                                            Remarks:
                                                                        </td>
                                                                        <td
                                                                            style="text-align:center; width: 87%; border-style: hidden!important;">
                                                                            <div class="col-sm-12">
                                                                                <input type="text"
                                                                                    style="width: 100.3%; margin-left: 3px;"
                                                                                    id="remarks" name="remarks"
                                                                                    class="form-control pos_inputbox"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <!--  -->
                                                            <table id="" class="table paymode_table"
                                                                style="width: 100%;">
                                                                <tbody>
                                                                    <tr>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Pay Mode
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Collection Mode
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            Pay Amt
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Given Amt
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Change Amt
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Opt.
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                                <tbody>
                                                                    <tr style="border-style: hidden!important;">
                                                                        <td style="text-align:center;width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <select id="pay_mode" name="pay_mode" class="form-select pos_inputbox" aria-label="Default select example">
                                                                                    <option value="1">Cash</option>
                                                                                    <option value="2">Cheque</option>
                                                                                    <option value="3">Debit Card</option>
                                                                                    <option value="4">Credit Card</option>
                                                                                    <option value="5">Bkash</option>
                                                                                    <option value="6">Nagad</option>
                                                                                    <option value="7">Upay</option>
                                                                                    <option value="8">UCash</option>
                                                                                    <option value="9">Bank Deposit</option>
                                                                                </select>
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <select id="Collection_mode"
                                                                                    name="Collection_mode"
                                                                                    class="form-select pos_inputbox"
                                                                                    aria-label="Default select example">
                                                                                    <option value="1">Collection
                                                                                    </option>
                                                                                    <option value="4"
                                                                                        id="adjustOption_pos">
                                                                                        Adjust Credit</option>
                                                                                </select>
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12" id="payment_input">
                                                                                <input type="number" class="form-control pos_inputbox"
                                                                                    id="payment_amt" name="payment_amt" step="0.01"
                                                                                    value="0" style="text-align:center" autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            <div class="col-sm-12" id="given_input">
                                                                                <input type="number"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="given_amt" name="given_amt"
                                                                                    style="text-align:center"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            <div class="col-sm-12 change_amt_status">
                                                                                <input type="number"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="change_amt" name="change_amt"
                                                                                    style="text-align:center" readonly
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center;width: 10%;">
                                                                            <div style="display: flex; margin-top: 3px; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: center; align-content: center;">
                                                                                <button type="button" onclick="calcFun()" class="btn btn-primary text-white btn-xs calcBtn">
                                                                                    Calc
                                                                                </button>
                                                                                <!--  -->
                                                                                <button type="button" id="addMultiPay" class="btn btn-warning text-white btn-xs payAddBtn">
                                                                                    <i class='bx bx-plus-medical'></i>
                                                                                </button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                                <!--  -->
                                                            </table>
                                                            <!--  -->
                                                            <table id="otherType" class="table paymode_table"
                                                                style="width: 100%; display: none;">
                                                                <tbody>
                                                                    <tr>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            CQ/CC/DC/DD/MB/OP
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Mobile Number
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            Reference
                                                                        </td>
                                                                        <td style="text-align:center;width: 20%;">
                                                                            Bank Name
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                                <tbody>
                                                                    <tr style="border-style: hidden!important;">
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <input type="text"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="card_info" name="card_info"
                                                                                    style="text-align:center"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <input type="number"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="pay_mob_number"
                                                                                    name="pay_mob_number"
                                                                                    style="text-align:center"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <input type="text"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="pay_reference"
                                                                                    name="pay_reference"
                                                                                    style="text-align:center"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                        <td style="text-align:center; width: 20%;">
                                                                            <div class="col-sm-12">
                                                                                <input type="text"
                                                                                    class="form-control pos_inputbox"
                                                                                    id="bank_name" name="bank_name"
                                                                                    style="text-align:center"
                                                                                    autocomplete="off">
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <!--  -->
                                                            <table id="multiple_payment" class="table paymode_table table-striped"style="margin-top: 0.5rem; width: 100%;">
                                                                <thead class="text-center multi_pay_head">
                                                                    <tr>
                                                                        <th style="text-align:center;">
                                                                            Pay Mode
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Collection Mode
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Pay Amt
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Given Amt
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Change Amt
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Acc.No
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Mobile
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Reference
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Bank Name
                                                                        </th>
                                                                        <th style="text-align:center;">
                                                                            Opt.
                                                                        </th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="payment_row" class="table-body-row" style="text-align:center;">

                                                                </tbody>
                                                            </table>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                    <!--  -->
                                    <div class="col-sm-4">
                                        <div class="card main_pos_card">
                                            <div class="card-body pos_card_body" style="margin-top: 5px;">
                                                <div class="row cash_point_row">
                                                    <label for="total_bills" class="col-sm-2-mody col-form-label">
                                                        Total Bill:
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden"
                                                            class="form-control paymentDtl pos_inputbox"
                                                            id="total_bills" name="actual_amount" value="0">
                                                        <span class="form-control paymentDtl pos_inputbox"
                                                            id="actual_amount">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row" id="vatCal">
                                                    <label for="total_vat" class="col-sm-2-mody col-form-label">
                                                        Total VAT (%):
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="number" placeholder="Enter Vat Tax (%)" style="background: #fffab6;"
                                                            class="form-control paymentDtl pos_inputbox" value=""
                                                            id="total_vat" name="total_vat">
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row">
                                                    <label for="id_total_vat" class="col-sm-2-mody col-form-label">
                                                        Total VAT amt (+):
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden"
                                                            class="form-control paymentDtl pos_inputbox" value="0"
                                                            id="id_total_vat" name="vat_amount">
                                                        <span class="form-control paymentDtl pos_inputbox"
                                                            id="vat_amount">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row">
                                                    <label for="tot_dis_minus" class="col-sm-2-mody col-form-label">
                                                        Total Discount (-):
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden"
                                                            class="form-control paymentDtl pos_inputbox" value="0"
                                                            id="tot_dis_minus" name="total_discount">
                                                        <span class="form-control paymentDtl pos_inputbox"
                                                            id="total_discount">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row">
                                                    <label for="payable_bill" class="col-sm-2-mody  col-form-label">
                                                        Total Amount:
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden"
                                                            class="form-control paymentDtl pos_inputbox"
                                                            id="payable_bill" value="0" name="total_amount">
                                                        <span class="form-control paymentDtl pos_inputbox"
                                                            id="total_amount">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row">
                                                    <label for="id_receivable_amt" class="col-sm-2-mody col-form-label">
                                                        Total Pay Amt:
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden" value="0" id="id_hand_on_cash_amt" name="hand_on_cash_amt">
                                                        <!--  -->
                                                        <input type="hidden" class="form-control paymentDtl pos_inputbox" value="0" id="id_receivable_amt" name="receivable_amt">
                                                        <span class="form-control paymentDtl pos_inputbox"
                                                            id="receivable_amt">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row">
                                                    <label for="due_value"
                                                        class="col-sm-2-mody text-danger col-form-label">
                                                        Due Amount:
                                                    </label>
                                                    <div class="col-sm-7">
                                                        <input type="hidden" style="color: #dc3545 !important;"
                                                            class="form-control paymentDtl pos_inputbox" id="due_value"
                                                            value="0" name="due_amount" readonly>
                                                        <span class="form-control paymentDtl pos_inputbox" style="color: #dc3545 !important;"
                                                            id="due_amount">0.00</span>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row" id="carryin_cost">
                                                    <label for="rent_other_expense"
                                                        class="col-sm-2-mody col-form-label required">
                                                        Carrying Cost:
                                                    </label>
                                                    <div class="col-sm-7"
                                                        style="display: flex; flex-direction: row; align-items: center;">
                                                        <input type="number" style="height: 1.51rem;"
                                                            class="form-control paymentDtl pos_inputbox" id="rent_other_expense" name="rent_other_expense"
                                                            placeholder="Cost .." title="Carrying Cost" autocomplete="off" required>
                                                        <!--  -->
                                                        <div class="form-check form-check-inline" style="width: 35%;">
                                                            <label class="form-check-label" for="id_buyer"
                                                                style="font-size: 11.5px;">Buyer</label>
                                                            <input class="form-check-input" type="radio" name="buyer"
                                                                id="id_buyer" value="1" checked>
                                                        </div>
                                                        <div class="form-check form-check-inline" style="width: 35%;">
                                                            <label class="form-check-label" for="id_seller"
                                                                style="font-size: 11.5px;">Seller</label>
                                                            <input class="form-check-input" type="radio" name="seller"
                                                                id="id_seller" value="0">
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <div class="row cash_point_row" id="carryin_cost_not_apply" style="padding: 5px; display: flex; justify-content: flex-start; align-items: center;">
                                                    <div class="col-sm-12" style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; flex-wrap: nowrap;">
                                                        <div class="col-sm-6" style="display: flex;">
                                                            <label for="id_notapp_carr_cost" class="col-sm-10 col-form-label required" title="Not Applicable Carrying Cost"
                                                                style="font-size: 11.5px; display: flex; flex-direction: row; justify-content: flex-end;">
                                                                Not App. Car. Cost:
                                                            </label>
                                                            <div class="notAppCheckbox"
                                                                style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: flex-start;">
                                                                <div class="form-check" style="margin-left: 0.5rem;">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        name="notapp_carr_cost" id="id_notapp_carr_cost"
                                                                        style="cursor: pointer;" value="1">
                                                                </div>
                                                                <!--  -->
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-6" style="display: flex;">
                                                            <label for="id_is_modified_items" class="col-sm-10 col-form-label required" title="Not Applicable Carrying Cost"
                                                                style="font-size: 11.5px; display: flex; flex-direction: row; justify-content: flex-end;">
                                                                Is Modified Items:
                                                            </label>
                                                            <div class="notAppCheckbox"
                                                                style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: flex-start;">
                                                                <div class="form-check" style="margin-left: 0.5rem;">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        name="is_modified_items" id="id_is_modified_items"
                                                                        style="cursor: pointer;" value="1">
                                                                </div>
                                                                <!--  -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section style="margin-top: 1rem; margin-bottom: 1rem;">
                                <div class="payment-submitBtn">
                                    <button type="button" style="text-align:center; width: 5rem;" id="resetButton"
                                        onclick="resetAndRemoveRows()"
                                        class="btn btn-danger col-sm-4 text-white btn-xs item_payment_btn">
                                        Clear
                                    </button>
                                    <button type="button" style="text-align:center; width: 8rem;"
                                        onClick="navigateTo('/item_pos_billing/')"
                                        class="btn btn-primary col-sm-4 text-white btn-xs item_payment_btn">
                                        New Invoice
                                    </button>
                                    <button type="submit" style="text-align:center; width: 8rem;" id="check_out"
                                        class="btn btn-success col-sm-4 text-white btn-xs item_payment_btn">
                                        Save & Print
                                    </button>
                                </div>
                            </section>
                        </form>
                    </section>
                </section>
                <!--  -->
            </section>
        </section>
    </section>
</main>
<!--  -->
<script>
    $(document).ready(function () {
        $('#payment_amt').on('input', function () {
            var payment_amt = parseFloat($(this).val().trim()) || 0;
            var payable_bill = parseFloat($('#payable_bill').val().trim()) || 0;
    
            if (payment_amt > payable_bill) {
                toastr.warning("Payment amount cannot exceed the payable bill.");
                $(this).val(payable_bill); // Set value to max allowable amount
            }
        });
    });
    //<!--  -->
    $(document).ready(function () {
        var uniquePayModeNames = new Set();
    
        // Payment mode mapping
        var payModeMap = {
            1: 'Cash',
            2: 'Cheque',
            3: 'Debit Card',
            4: 'Credit Card',
            5: 'Bkash',
            6: 'Nagad',
            7: 'Upay',
            8: 'UCash',
            9: 'Bank Deposit'
        };

        var collModeMap = {
            1: 'Collection',
            4: 'Adjust Credit',
        };
    
        $('#addMultiPay').click(function () {
            var pay_mode = $('#pay_mode').val();
            var Collection_mode = $('#Collection_mode').val();
            var payment_amt = parseFloat($('#payment_amt').val().trim()) || 0; // Convert to number
            var given_amt = $('#given_amt').val().trim();
            var change_amt = $('#change_amt').val().trim();
            var card_info = $('#card_info').val();
            var pay_mob_number = $('#pay_mob_number').val().trim();
            var pay_reference = $('#pay_reference').val();
            var bank_name = $('#bank_name').val();
            var payable_bill = parseFloat($('#payable_bill').val().trim()) || 0;
    
            var pay_mode_name = payModeMap[pay_mode] || 'Unknown'; // Fallback to "Unknown" if invalid
            var coll_mode_name = collModeMap[Collection_mode] || 'Unknown'; // Fallback to "Unknown" if invalid
    
            if (payment_amt === 0){
                toastr.warning("Payment Zero '0' Not Allowed!...");
                return false;
            }

            if (payable_bill === 0){
                toastr.warning("When Total Bill Zero '0' then Payable Amount Not Allowed!...");
                return false;
            }

            // Recalculate the total of all multi_payment_amt values
            var total_multi_payment_amt = 0;
            $('input[name="multi_payment_amt[]"]').each(function () {
                var sum_tot_value = parseFloat($(this).val()) || 0; // Ensure a number, default to 0
                total_multi_payment_amt += sum_tot_value;
                //cash_on_hand
                $('[name="sum_cash_on_hand"]').val(total_multi_payment_amt).trigger('change');
            });

            var total_payment_amt = total_multi_payment_amt + payment_amt;
            
            //console.log('total_payment_amt:', total_payment_amt);

            // Check if the total amount exceeds the payable bill
            if (payable_bill < total_payment_amt) {
                toastr.warning('Payable Amount greater than Total Bill not allowed!...');
                return false;  // Prevent appending the row if condition is met
            }

            //=================================================================

            if (uniquePayModeNames.has(pay_mode)) {
                toastr.warning('Pay Mode Already in the List.');
                return false;
            }
            // Add the supplier name to the Set
            uniquePayModeNames.add(pay_mode);
    
            // Create a new table row dynamically
            var tr = $('<tr>');
            tr.append('<td><input type="hidden" name="multi_pay_mode[]" value="' + pay_mode + '">' + pay_mode_name + '</td>');
            tr.append('<td><input type="hidden" name="multi_collection_mode[]" value="' + Collection_mode + '">' + coll_mode_name + '</td>');
            tr.append('<td><input type="hidden" name="multi_payment_amt[]" value="' + payment_amt + '"><span class="items_supplier_name">' + payment_amt + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_given_amt[]" value="' + given_amt + '"><span class="items_supplier_name">' + given_amt + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_change_amt[]" value="' + change_amt + '"><span class="items_supplier_name">' + change_amt + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_card_info[]" value="' + card_info + '"><span class="items_supplier_name">' + card_info + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_pay_mob_number[]" value="' + pay_mob_number + '"><span class="items_supplier_name">' + pay_mob_number + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_pay_reference[]" value="' + pay_reference + '"><span class="items_supplier_name">' + pay_reference + '</span></td>');
            tr.append('<td><input type="hidden" name="multi_bank_name[]" value="' + bank_name + '"><span class="items_supplier_name">' + bank_name + '</span></td>');
            tr.append('<td><button type="button" class="btn btn-danger btn-xs deleteBtn paydeletedBtn"><i class="bx bx-trash"></i></button></td>');
    
            // Append the row to the table
            $('#multiple_payment tbody').append(tr);

            // Clear the payment_amt input field
            $('#payment_amt').val('0'); // Clears the input field
            $('#given_amt').val('');
            $('#change_amt').val('');
            $('#card_info').val('');
            $('#pay_mob_number').val('');
            $('#pay_reference').val('');
            $('#bank_name').val('');

            calc();
        });

        function updateRowColors() {
            $('#multiple_payment tbody tr').each(function (index) {
                $(this).css('background-color', index % 2 === 0 ? '#ffffff' : '#f2f2f2');
            });
        }
        
        // Call function when a row is added
        $('#addMultiPay').click(function () {
            updateRowColors();
        });
    
        // Event delegation for dynamically added delete buttons
        $('#multiple_payment').on('click', '.deleteBtn', function () {
            var tr = $(this).closest('tr');
            var pay_mode = tr.find('input[name="multi_pay_mode[]"]').val();

            // Remove the pay_mode from the set when the row is deleted
            uniquePayModeNames.delete(pay_mode);

            tr.remove();
            updateRowColors();
            calc();
        });
    });

    //======================================================================

    function fetchAndDisplayClientsTrns(regisID, orgID) {
        if (regisID && orgID) {
            $.ajax({
                url: "{% url 'get_clients_trans_summary_report' %}",
                type: 'GET',
                data: {
                    reg_id: regisID,
                    org_id: orgID
                },
                dataType: 'json',
                success: function (response) {
                    var total_OP_DebitAmt = 0;
                    var total_OP_CreditAmt = 0;
                    var total_trns_DebitAmt = 0;
                    var total_trns_CreditAmt = 0;
                    var balance = 0;
    
                    if (Array.isArray(response.combined_data)) {
                        response.combined_data.forEach(function (transaction) {
                            total_OP_DebitAmt += parseFloat(transaction.op_debit_amt || 0);
                            total_OP_CreditAmt += parseFloat(transaction.op_credit_amt || 0);
                            total_trns_DebitAmt += parseFloat(transaction.trns_debit_amt || 0);
                            total_trns_CreditAmt += parseFloat(transaction.trns_credit_amt || 0);
                        });
    
                        balance = (total_OP_DebitAmt + total_trns_DebitAmt) - (total_OP_CreditAmt + total_trns_CreditAmt);
                        $('#id_reg_balances').val(balance.toFixed(2));  // Corrected to use .val() for input field
                        $('#reg_balances').text(balance.toFixed(2));
                    } else {
                        $('#id_reg_balances').val('0.00');
                        $('#reg_balances').text('0.00');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching transactions:', status, error);
                }
            });
        } else {
            console.warn('Required IDs are missing.');
        }
    }
    //
    $(document).ready(function () {
        $(document).on('click', '#addNewRegBtn', function () {
            lineloaderstart();
            modal_xl("Add New Registration POS", "{% url 'add_new_reg_pos' %}");
            lineloaderstop();
        });
        ///
        $(document).on('click', '#addItemPosBtn', function () {
            lineloaderstart();
            modal_lg("Add New Items Setup Pos", "{% url 'add_items_in_pos_billing' %}");
            lineloaderstop();
        });
    });

    // driver searching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearDriversInput() {
            $('#id_carriers').val('').focus();
        }

        $('#id_carriers').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_get_drivers_list_pos/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (drivers) {
                            return { name: drivers.driver_name.toString(), id: drivers.driver_id }; // Return an object with name and id
                        }));
                    }
                });
            },
            updater: function (drivers) {
                var selectedDriverId = drivers.id;

                $.ajax({
                    url: '/select_drivers_details_pos/',
                    data: { selectedDriver: selectedDriverId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedDriverDtl = response.data;

                        // Assign selected data to the corresponding text input fields
                        $('#id_driver_id').val(selectedDriverDtl[0].driver_id);
                        $('#id_driver_name').val(selectedDriverDtl[0].driver_name);
                        $('#id_driver_mobile').val(selectedDriverDtl[0].phone);

                        clearDriversInput();
                    }
                });

                // Return the selected item name to fill the input field
                return drivers.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
        });
    });
    //
    //
    document.getElementById('searchfavlist').addEventListener('input', function () {
        const searchQuery = this.value.toLowerCase();
        loadFavoriteItems(searchQuery);
    });

    function loadFavoriteItems(searchQuery = '') {
        fetch(`/get_fav_item_list/?search=${encodeURIComponent(searchQuery)}`)
            .then(response => response.json())
            .then(data => {
                const favItemTB = document.getElementById('favItemTB');
                favItemTB.innerHTML = ''; // Clear existing rows

                data.fav_items.forEach(item => {
                    const row = document.createElement('tr');

                    const deleteCell = document.createElement('td');
                    deleteCell.style.width = '10%';
                    deleteCell.style.textAlign = 'center';
                    deleteCell.style.borderStyle = 'none';
                    deleteCell.innerHTML = `<button type='button' id='${item.fav_id}' class='btn btn-xs delFavListBtn'><i class='bx bx-trash delBtn'></i></button>`;

                    const nameCell = document.createElement('td');
                    nameCell.style.width = '80%';
                    nameCell.style.textAlign = 'left';
                    nameCell.style.borderStyle = 'none';
                    nameCell.textContent = item.item_name;

                    const checkboxCell = document.createElement('td');
                    checkboxCell.style.width = '10%';
                    checkboxCell.style.textAlign = 'center';
                    checkboxCell.style.borderStyle = 'none';
                    checkboxCell.innerHTML = `<input type='checkbox' id='${item.item_id}' class='form-check-input' style='width: 1.2rem; height: 1.2rem; cursor: pointer; border-color: royalblue;'>`;

                    row.appendChild(deleteCell);
                    row.appendChild(nameCell);
                    row.appendChild(checkboxCell);

                    favItemTB.appendChild(row);

                    // Add event listener to delete button
                    deleteCell.querySelector('button').addEventListener('click', function () {
                        deleteFavoriteItem(item.fav_id, row);
                    });

                    // Add event listener to checkbox
                    checkboxCell.querySelector('input').addEventListener('change', function () {
                        if (this.checked) {
                            addItemToTable(item.item_id); // Use item.item_id here
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching favorite items:', error);
            });
    }

    function addItemToTable(itemId) {
        $.ajax({
            url: '/select_item_list_with_sumtotal_stock/',
            type: 'GET',
            dataType: 'json',
            data: {
                selectedItem: itemId,
                store_id: $('#cash_point').val(), // Assuming you're using a field with this ID for the store ID
                b2b_client_supp_id: $('#id_supplier_id').val(),
                org_id: $('#id_org').val(),
            },
            success: function (response) {
                if (response.data && response.data.length > 0) {
                    const item = response.data[0]; // Get the first item in the response data array

                    const positem_name = item.item_name; // Extract the item name
                    const extended_stock = parseFloat(item.extended_stock) || 0;
                    const stock_qty = parseFloat(item.stock_qty).toFixed(2) || 0;
                    const reOrderQtyFloat = parseFloat(item.re_order_qty) || 0;

                    var itemPrice = (item.item_price !== '' && item.item_price != null) ? item.item_price : 0;

                    var lowStockColor = stock_qty < reOrderQtyFloat ? '#FF5722' : '';
                    var lowStockbold = stock_qty < reOrderQtyFloat ? 'bold' : '';

                    // Check if the item has already been added
                    if ($('#POS-field table tbody tr[data-item-name="' + positem_name + '"]').length > 0) {
                        toastr.warning('Item Already in the List.');
                        return false;
                    }

                    // Add the item to the table (existing logic)
                    const tableBody = document.querySelector('#POS-field table tbody');

                    // Create a new row for the selected item
                    const tr = document.createElement('tr');
                    tr.style.borderStyle = 'hidden';
                    tr.style.color = `${lowStockColor}`;
                    tr.style.fontWeight = `${lowStockbold}`;
                    tr.setAttribute('data-item-name', item.item_name); // Store the item name in a data attribute

                    // Add the row's content (as shown in your previous code)
                    tr.innerHTML = `
                        <td style="text-align:center;"><button type='button' class='btn btn-xs addFavBtn favListSubmit'><i class='bx bxs-chevrons-left addFavIcon' title='Add to Favorite List'></i></button></td>
                        <td style="text-align:center;">&nbsp;</td>
                        <td style="text-align:center;">${item.item_no}<input type="hidden" value="${item.item_no}" class="inputbox_tdrow" name="item_no[]" readonly><input type="hidden" value="${item.item_id}" class="inputbox_tdrow multiple_input" name="item_id[]" readonly></td>
                        <td style="position: relative; text-align: left;" class="posItemsName_id"><input type="text" style="color: ${lowStockColor}; font-weight: ${lowStockbold};" value="${item.item_name}" class="form-control pos_salesDisInput" name="item_names[]" readonly autocomplete="off"></td>
                        <td style="text-align:center;">${item.item_type_name}<input type="hidden" value="${item.item_type_name}" class="inputbox_tdrow" name="item_type[]" readonly><input type="hidden" value="${item.store_id}" class="inputbox_tdrow multiple_input" name="store_id[]" readonly></td>
                        <td style="text-align:center;">${item.item_Supplier}<input type="hidden" value="${item.item_Supplier}" class="inputbox_tdrow" name="item_store_name[]" readonly></td>
                        <td style="text-align:left; font-size: 0.9rem; color: #df6700; font-weight: bolder;">${stock_qty}<input type="hidden" value="${stock_qty}" class="inputbox_tdrow" id="stock_qty" name="stock_qty[]" readonly></td>
                        <td style="text-align:center;" id="mulInputQty"><input type="number" value="0" class="form-control text-center qty1 pos_salesDisInput" id="sales_qty" name="sales_qty[]" oninput="validity.valid || (value=\'\');" step="0.01" autocomplete="off" style="width: 95%;" required></td>
                        <td style="text-align:center; width: 7%;"><select class="form-control pos_salesDisInput item_uoms_select" name="item_uoms[]" style="width: 96%;"></select></td>
                        <td style="text-align:center;" class="item_w_dis"><input type="number" value="0" class="form-control text-center pos_salesDisInput item_w_dis_input" name="item_w_dis[]" max="numberHere" oninput="validity.valid || (value=\'\');" autocomplete="off" style="width: 95%;"><input type="hidden" value="0" class="form-control text-center pos_inputbox" name="gross_dis[]" style="width: 95%;"><input type="hidden" value="0" class="form-control text-center pos_inputbox" name="gross_vat_tax[]" style="width: 95%;"></td>
                        <!-- <td style="text-align:center; display: none;"><input type="number" class="form-control text-center pos_salesDisInput item_sales_price" oninput="validity.valid||(value='');" value="0" name="dup_item_price[]" autocomplete="off" step="0.01" style="width: 95%;" required></td> -->
                        <td style="text-align:center;" id="SpriceInput"><input type="number" value="${itemPrice}" class="form-control text-center pos_salesDisInput item_sales_price" oninput="validity.valid||(value='');" name="item_price[]" autocomplete="off" step="0.01" style="width: 95%;" required></td>
                        <td style="text-align:center;" class="product_total"></td>
                        <td style="text-align:center;"><button type="button" class="btn btn-danger text-white btn-xs itemAdd_del_btn">X</button></td>
                    `;

                    // Append the new row to the table
                    tableBody.appendChild(tr);

                    // After appending the row, call the calc function
                    calc();

                    // Update serial numbers for all rows
                    updateSerialNumbers();
                    toggleItemModifyFields();

                    $('#POS-field table tbody').on('input change blur', '.item_w_dis_input', function () {
                        var value = $(this).val();
            
                        if (value.trim().length === 0) {
                            $(this).val('0');
                        }
                        calc();
                    }).on('focus', '.item_w_dis_input', function () {
                        var value = $(this).val();
                        if (value.trim() === '0') {
                            $(this).val('');
                        }
                    });

                    // Handling blur events for item_sales_price
                    $('#POS-field table tbody').on('input', '.item_sales_price', function () {
                        var value = $(this).val().trim();
                    
                        // Allow manual entry of float numbers, only highlight in red if the input is empty or invalid
                        if (value.length === 0 || isNaN(value)) {
                            $(this).css('background-color', 'red');
                        } else {
                            $(this).css('background-color', '#fff');
                        }
                    }).on('change blur', '.item_sales_price', function () {
                        var value = $(this).val().trim();
                    
                        // Check if the value is empty or zero
                        if (value.length === 0 || parseFloat(value) === 0) {
                            $(this).val('0');
                            $(this).css('background-color', 'red');
                        } else {
                            // Format the value to two decimal places if it's valid
                            if (!isNaN(parseFloat(value))) {
                                $(this).val(parseFloat(value).toFixed(2));  // Format to 2 decimal places
                            }
                            $(this).css('background-color', '#fff');
                        }
                    
                        calc();
                    }).on('focus', '.item_sales_price', function () {
                        var value = $(this).val().trim();
                    
                        if (parseFloat(value) === 0) {
                            $(this).val('');
                            $(this).css('background-color', 'red');
                        }
                    });

                    // Update UoM options asynchronously
                    updateUoMOptions(item.item_uom, tr);

                    // Update UoM options
                    function updateUoMOptions(selectedUoM, row) {
                        var org_id = $('#id_org').val();
                        $.ajax({
                            url: '/get_list_of_item_uom/',
                            method: 'GET',
                            data: { org_id: org_id },
                            success: function (data) {
                                // Wrap 'row' in a jQuery object
                                var select = $(row).find('.item_uoms_select');
                                select.empty();
                    
                                if (!data.iuom_list || data.iuom_list.length === 0) {
                                    console.warn('No UoM options found.');
                                    select.append('<option value=""></option>');
                                    return;
                                }
                    
                                $.each(data.iuom_list, function (index, uom) {
                                    var selected = uom.item_uom_name === selectedUoM ? 'selected' : '';
                                    select.append(`<option value="${uom.item_uom_id}" ${selected}>${uom.item_uom_name}</option>`);
                                });
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching UoM options:', error);
                            }
                        });
                    }

                } else {
                    toastr.warning('Item Not Found In The Stock List. Please Stock This Item First & Try Again.');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching item details:', error);
            }
        });

        // Function to update the serial numbers
        function updateSerialNumbers() {
            $('#POS-field table tbody tr').each(function (index) {
                $(this).find('td:nth-child(2)').text(index + 1); // Update the serial number column
            });
        }
    }

    $(document).ready(function () {
        loadFavoriteItems();
    
        // Event delegation for dynamically created inputs within the table body
        $('#POS-field table tbody')
            .on('input change blur', '.item_w_dis_input', function () {
                let value = $(this).val();
                if (value.trim().length === 0) {
                    $(this).val('0'); // Set default value if empty
                }
                calc(); // Recalculate totals
            })
            .on('focus', '.item_w_dis_input', function () {
                let value = $(this).val();
                if (value.trim() === '0') {
                    $(this).val(''); // Clear input if value is '0'
                }
            })
            .on('input keypress keyup keydown', '[name="sales_qty[]"], [name="item_price[]"], [name="item_w_dis[]"]', calc)
            .on('blur', 'input[name="sales_qty[]"]', function () {
                let value = $(this).val();
                if (value === "") {
                    $(this).val(); // Set default qty if left empty
                }
                calc(); // Recalculate totals
            })
            //
            .on('input change blur', '.qty1', function () {
                let value = $(this).val();
                if (value.trim().length === 0) {
                    $(this).val(''); // Set default value if empty
                }
                calc(); // Recalculate totals
            })
            .on('focus', '.qty1', function () {
                let value = $(this).val();
                if (value.trim() === '0') {
                    $(this).val(''); // Clear input if value is '0'
                }
            })
            //
            .on('click', '.itemAdd_del_btn', function () {
                $(this).closest('tr').remove(); // Remove the row
                calc(); // Recalculate totals
            });
    });

    //
    function deleteFavoriteItem(fav_id, row) {
        fetch(`/delete_fav_item/${fav_id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // Get the CSRF token
            },
        })
            .then(response => {
                if (response.ok) {
                    // Remove the row from the table
                    row.remove();
                } else {
                    console.error('Failed to delete favorite item:', response.statusText);
                }
            })
            .catch(error => {
                console.error('Error deleting favorite item:', error);
            });
    }

    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadFavoriteItems(); // Load favorite items on page load
    });

    //
    function fetchAndDisplayCreditTransactions(supplierId, branchId) {
        if (supplierId || branchId) {
            $.ajax({
                url: "{% url 'get_credit_transactions' %}",
                type: 'GET',
                data: {
                    'supplier_id': supplierId,
                    'branch_id': branchId,
                },
                dataType: 'json',
                success: function (response) {

                    var totalDebitAmt = 0;
                    var totalCreditAmt = 0;

                    // Populate the table body with the new data
                    response.forEach(function (transaction, index) {

                        // Add debit payment to totalDebitAmt
                        if (!isNaN(transaction.debit_payment)) {
                            totalDebitAmt += parseFloat(transaction.debit_payment);
                        }

                        // Add credit payment to totalCreditAmt
                        if (!isNaN(transaction.credit_payment)) {
                            totalCreditAmt += parseFloat(transaction.credit_payment);
                        }
                    });

                    // Calculate the balance
                    var balance = totalDebitAmt - totalCreditAmt;

                    $('#id_credit_balance').text(balance.toFixed(0));
                    $('#credit_balance').val(balance.toFixed(0));
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching credit transactions:', status, error);
                }
            });
        }
    }

    //register customer searching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearRegCustomerInput() {
            $('#register_customer').val('').focus();
        }
    
        $('#register_customer').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_registration_for_billing/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (register) {
                            return { 
                                name: register.full_name.toString(),
                                customerNo: register.customer_no.toString(),
                                mobileNumber: register.mobile_number.toString(),
                                id: register.reg_id,
                            };
                        }));
                    }
                });
            },
            updater: function (register) {
                var selectedRegisterId = register.id;
                var orgID = $('#id_org').val();
    
                $.ajax({
                    url: '/select_registrations_details/',
                    data: { selectedRegister: selectedRegisterId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedRegisterDtl = response.data;
    
                        // Assign selected data to the corresponding text input fields
                        $('#id_reg_id').val(selectedRegisterDtl.reg_id);
                        $('#customer_name').val(selectedRegisterDtl.full_name);
                        $('#mobile_number').val(selectedRegisterDtl.mobile_number);
                        $('#gender').val(selectedRegisterDtl.gender);
                        $('#id_address').val(selectedRegisterDtl.address);
                        $('#emergency_person').val(selectedRegisterDtl.emergency_person);
                        $('#id_emergency_phone').val(selectedRegisterDtl.emergency_mobile);
    
                        clearRegCustomerInput();

                        if (selectedRegisterId && orgID) {
                            fetchAndDisplayClientsTrns(selectedRegisterId, orgID);
                        }
                    }
                });
    
                // Return the selected item name to fill the input field
                return register.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
            matcher: function (item) {
                // Custom matcher to filter based on name, customerNo, or mobileNumber
                var query = this.query.toLowerCase();
                return item.name.toLowerCase().includes(query) ||
                       item.customerNo.toLowerCase().includes(query) ||
                       item.mobileNumber.toLowerCase().includes(query);
            }
        });
    });

    // client seraching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearB2bClientInput() {
            $('#clients_name').val('').focus();
        }

        $('#clients_name').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_b2b_clients_for_billing/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (b2bClient) {
                            return { name: b2bClient.supplier_name.toString(), id: b2bClient.supplier_id }; // Return an object with name and id
                        }));
                    }
                });
            },
            updater: function (b2bClient) {
                var selectedb2bClientId = b2bClient.id;

                $.ajax({
                    url: '/select_b2b_clients_details/',
                    data: { selectedb2bClient: selectedb2bClientId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedb2bClientDtl = response.data;

                        // Assign selected data to the corresponding text input fields
                        $('#id_supplier_id').val(selectedb2bClientDtl[0].supplier_id);
                        $('#id_client_no').val(selectedb2bClientDtl[0].supplier_no);
                        $('#id_client_name').val(selectedb2bClientDtl[0].supplier_name);
                        $('#customer_name').val(selectedb2bClientDtl[0].supplier_name);
                        $('#id_contact').val(selectedb2bClientDtl[0].phone);
                        $('#mobile_number').val(selectedb2bClientDtl[0].phone);
                        $('#id_client_address').val(selectedb2bClientDtl[0].address);
                        $('#id_address').val(selectedb2bClientDtl[0].address);

                        clearB2bClientInput();

                        var supplierId = selectedb2bClientId;
                        var branchId = $('#id_branchs').val();
                        if (supplierId || branchId) {
                            fetchAndDisplayCreditTransactions(supplierId, branchId);
                        }
                    }
                });

                // Return the selected item name to fill the input field
                return b2bClient.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
        });
    });
    //======================================================================

    // get url wise drivers list
    //$(document).ready(function () {
    //    // Initial population of driver options based on the selected organization and branch
    //    updateDriversOptions();

    //    // Add change event listener to the organization and branch dropdowns
    //    $('#id_org').change(function () {
    //        updateDriversOptions();
    //    });

    //    $('#id_branchs').change(function () {
    //        updateDriversOptions();
    //    });

    //    function updateDriversOptions() {
    //        var selectedOrgId = $('#id_org').val();
    //        var selectedBranchID = $('#id_branchs').val();

    //        if (selectedOrgId && selectedBranchID) {
    //            $.ajax({
    //                url: '/get_drivers_options/',  // Replace with your actual URL for fetching driver options
    //               method: 'GET',
    //                data: {
    //                    id_org: selectedOrgId,
    //                    id_branch: selectedBranchID
    //                },
    //                success: function (data) {
    //                    // Clear existing options
    //                    $('#id_drivers').empty();

    //                    // Add default option
    //                    $('#id_drivers').append('<option value="" selected disabled>Choose Carriers ...</option>');

    //                    // Add fetched driver options
    //                    $.each(data.drivers_list, function (index, driver) {
    //                        $('#id_drivers').append('<option value="' + driver.driver_id + '">' + driver.driver_name + '</option>');
    //                    });
    //                },
    //                error: function (error) {
    //                    console.error('Error fetching drivers options:', error);
    //                }
    //            });
    //        } else {
    //            // Clear the drivers dropdown if either organization or branch is not selected
    //            $('#id_drivers').empty();
    //        }
    //    }
    //});


    //
    $(document).ready(function () {

        $('#id_org').change(function () {
            OrgWiseUpdateFilterOptions();
        });

        OrgWiseUpdateFilterOptions();

        function OrgWiseUpdateFilterOptions() {
            var selectedOrgId = $('#id_org').val();

            // Branch option value
            $.ajax({
                url: '/get_branch_options/',
                method: 'GET',
                data: { org_id: selectedOrgId },
                success: function (data) {
                    $('#id_branchs').empty();
                    $.each(data.branch_list, function (index, branch) {
                        $('#id_branchs').append('<option value="' + branch.branch_id + '">' + branch.branch_name + '</option>');
                    });
                    $('#id_branchs').trigger('change');
                },
                error: function (error) {
                    console.error('Error fetching branch options:', error);
                }
            });

            // supplier options update Function
            $.ajax({
                url: '/get_list_of_supplier/',
                method: 'GET',
                data: { org_id: selectedOrgId },
                success: function (data) {
                    //<!--  -->
                    $('#id_filter_suppliers').empty();
                    $('#id_filter_suppliers').append('<option value="1" selected>All Supplier</option>');
                    $.each(data.supp_list, function (index, supp) {
                        $('#id_filter_suppliers').append('<option value="' + supp.supplier_id + '" id="' + supp.supplier_id + '">' + supp.supplier_name + '</option>');
                    });
                    $('#id_filter_suppliers').trigger('change');
                },
                error: function (error) {
                    console.error('Error fetching suppliers:', error);
                }
            });
        }

        //
        $.ajax({
            url: "{% url 'get_user_stores' %}",
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.stores) {
                    var select = $('#cash_point');
                    select.empty();
                    $.each(response.stores, function (index, store) {
                        select.append($('<option>', {
                            value: store.store_id,
                            id: store.store_id,
                            text: store.store_name
                        }));
                    });

                    // After populating user stores, trigger the change event for cash_point
                    $('#cash_point').trigger('change');
                } else {
                    console.error('Error fetching user stores');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    });

    // Function to run when the document is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        // radio button 
        // client
        var generalRadioButton = document.getElementById('id_general_bill');
        var clientRadioButton = document.getElementById('id_b2b_clients');

        // registration
        var registerRadioButton = document.getElementById('id_register');
        var nonRegRadioButton = document.getElementById('id_non_register');
        // ==============================================

        // client search body
        var clientSearchBody = document.getElementById('client_searchBody');
        var clientSalesTypeBody = document.getElementById('id_sales_type');

        // client Search Input
        var clientSearchInput = document.getElementById('client_searchInput');
        var b2bClientsInfo = document.getElementById('b2b_clients_info');
        // ==============================================

        var regSearchBody = document.getElementById('reg_searchBody');
        var regSearchInput = document.getElementById('reg_searchInput');
        // ==============================================


        //Clients body display block
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'block';
                clientSearchInput.style.display = 'block';
                b2bClientsInfo.style.display = 'block';
                clientSalesTypeBody.style.display = 'flex';
            }
        });

        //Clients body display none
        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'none';
                clientSearchInput.style.display = 'none';
                b2bClientsInfo.style.display = 'none';
                clientSalesTypeBody.style.display = 'none';
            }
        });


        //register body display block
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'block';
                regSearchInput.style.display = 'block';
            }
        });


        //register body display none
        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'none';
                regSearchInput.style.display = 'none';
            }
        });
        
        // Call the function for register and non-register radio buttons
        //toggleReadonlyState('id_register', true);   // Makes the elements readonly when "register" is checked
        //toggleReadonlyState('id_non_register', false);  // Removes readonly when "non-register" is checked

        //============================ button click wise value change ============================
        //client genaral butthon
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                generalRadioButton.value = "0";
                clientRadioButton.value = "1";
            }
        });

        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                clientRadioButton.value = "0";
                generalRadioButton.value = "1";
            }
        });

        //register non register butthon
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                nonRegRadioButton.value = "0";
                registerRadioButton.value = "1";
            }
        });

        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                registerRadioButton.value = "0";
                nonRegRadioButton.value = "1";
            }
        });

        //saller buyer butthon

        var buyerRadioButton = document.getElementById('id_buyer');
        var sellerRadioButton = document.getElementById('id_seller');

        sellerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                buyerRadioButton.value = "0";
                sellerRadioButton.value = "1";
                calc();
            }
        });

        buyerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                sellerRadioButton.value = "0";
                buyerRadioButton.value = "1";
                calc();
            }
        });
    });

    // Function to toggle the readonly state of elements
    //function toggleReadonlyState(radioBtnId, shouldBeReadonly) {
        // Select the radio button and all elements that should be made readonly
    //    var radioButton = document.getElementById(radioBtnId);
    //    var readonlyElements = document.querySelectorAll('.reg_wise_disable');

        // Add event listener to the radio button
    //    radioButton.addEventListener('change', function () {
    //        readonlyElements.forEach(function (element) {
    //            if (radioButton.checked && shouldBeReadonly) {
    //                element.setAttribute('readonly', true);
    //            } else {
    //                element.removeAttribute('readonly');
    //            }
    //        });
    //    });
    //}


    // Item form reset
    function resetInputFields() {
        $('#id_supplier_id').val('');
        $('#id_client_no').val('');
        $('#id_client_name').val('');
        $('#customer_name').val('');
        $('#id_contact').val('');
        $('#mobile_number').val('');
        $('#id_client_address').val('');
        $('#id_address').val('');
        $('#credit_balance').val('');
        $('#id_credit_balance').text('0.00');
    }

    // id_non_register, id_register, id_general_bill, id_b2b_clients, id_buyer, id_seller click to change
    function toggleCheck(primaryId, secondaryId) {
        document.getElementById(primaryId).addEventListener('change', function () {
            document.getElementById(secondaryId).checked = false;
        });

        document.getElementById(secondaryId).addEventListener('change', function () {
            document.getElementById(primaryId).checked = false;
        });
    }

    toggleCheck('id_non_register', 'id_register');
    toggleCheck('id_general_bill', 'id_b2b_clients');
    toggleCheck('id_buyer', 'id_seller');
    //toggleCheck('id_is_cash', 'id_is_credit');
    //<!--  -->

    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearAndFocusInput() {
            $('#positem_name').val('').focus();
            $('#positem_name').trigger('input');
        }

        // favorite function start
        // Function to get CSRF token from the cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Get the CSRF token
        const csrfToken = getCookie('csrftoken');

        // Add event listener for the favorite icon click
        $('#POS-field').on('click', '.favListSubmit', function (e) {
            e.preventDefault();
            var row = $(this).closest('tr');
            var item_id = row.find('input[name="item_id[]"]').val();

            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: '/save_favorite_item/',  // URL for saving favorite item
                type: 'POST',
                data: {
                    'item_id': item_id,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function (response) {
                    if (response.status === 'success') {
                        loadFavoriteItems();
                        toastr.success(response.message);
                    } else if (response.status === 'exists') {
                        toastr.warning(response.message);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Failed to add item to favorites.');
                }
            });
        });
        // Add event listener for the favorite icon click end
        // favorite function start end

        // Speech recognition feature
        $('.speech').on('click', function () {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Your browser does not support Speech Recognition');
                return;
            }
    
            var recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.start();
    
            recognition.onresult = function (event) {
                var voiceInput = event.results[0][0].transcript;
                var $inputField = $('#positem_name');
                $inputField.val(voiceInput).focus();
    
                // Trigger the typeahead manually
                $inputField.typeahead('lookup', voiceInput);
            };
        });

        $('#positem_name').typeahead({
            source: function (query, result) {
                var selected_store_id = $('#cash_point').val();
                var selected_supplier_id = $('#id_filter_suppliers').val();
                var b2bClientSuppId = $('#id_supplier_id').val();
                var selectedOrgId = $('#id_org').val();

                $.ajax({
                    url: '/get_item_list_with_sumtotal_stock/',
                    data: {
                        query: query,
                        store_id: selected_store_id,
                        filter_suppliers: selected_supplier_id,
                        b2b_client_supp_id: b2bClientSuppId,
                        org_id: selectedOrgId,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        var items = data.data.map(function (item) {
                            return {
                                name: item.item_name.toString(),
                                type: item.item_type_name.toString(),
                                uom: item.item_uom.toString(),
                                Supplier: item.item_Supplier.toString(),
                                qty: item.stock_qty.toString(),
                                price: item.item_price || 'N/A',
                                itemNo: item.item_no.toString(),
                                id: item.item_id,
                            };
                        });

                        result(items);

                        // Adjust widths after results are rendered
                        adjustWidthsBasedOnFavListState(); 
                        //results are rendered
                    }
                });
            },
            items: 150,
            displayText: function (item) {
                const itemId = item.id ? item.id : '';
                const name = item.name ? item.name : '';
                const type = item.type ? item.type : '';
                const uom = item.uom ? item.uom : '';
                const Supplier = item.Supplier ? item.Supplier : '';
                const qty = item.qty ? item.qty : '';
                const price = item.price ? item.price : '';
                const itemNo = item.itemNo ? item.itemNo : '';

                return `
                    <span style="display: none;">${itemId}</span>
                    <span style="display: none;">${itemNo}</span>
                    <strong class="itemName">
                        <i class="bx bxs-baguette itemNameIcon"></i>
                        <span class="itemNameBody">${name}</span>
                    </strong>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${type}</span>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${uom}</span>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${Supplier}</span>
                    <i class="bx bxs-layer itemOtherIcon"></i>
                    <span class="itemQtyName" style="color: #784900; font-weight: bolder;">${qty}</span>
                    <i class="bx bx-dollar itemOtherIcon"></i>
                    <span class="itemPriceName" style="color: #00076c; font-weight: bolder;">${price}</span>
                `;
            },
            highlighter: function (item) {
                return `<div style="display: flex;">${item}</div>`;
            },
            updater: function (item) {

                var selecteditemId = item.id;

                $.ajax({
                    url: '/select_item_list_with_sumtotal_stock/',
                    data: {
                        selectedItem: selecteditemId,
                        store_id: $('#cash_point').val(), // Pass the store_id with the selected item ID
                        b2b_client_supp_id: $('#id_supplier_id').val(),
                        org_id: $('#id_org').val(),
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedItemDetails = response.data;
                    
                        // Assign selected data to variables
                        var { org_id, store_id, item_id, item_name: positem_name, item_no, item_type_name: item_type, 
                              item_uom, item_Supplier, extended_stock, re_order_qty, 
                              stock_qty, item_price } = selectedItemDetails[0];
                    
                        var favIcon = `<button type='button' class='btn btn-xs addFavBtn favListSubmit'>
                                        <i class='bx bxs-chevrons-left addFavIcon' title='Add to Favorite List'></i></button>`;
                    
                        // Check if the item is already in the list
                        if ($('#POS-field table tbody tr[data-item-name="' + positem_name + '"]').length > 0) {
                            toastr.warning('Item Already in the List.');
                            clearAndFocusInput();
                            return false;
                        }
                    
                        // Ensure extracted values are defined
                        if ([store_id, item_id, item_no, positem_name, item_type, item_uom, item_Supplier,
                             extended_stock, re_order_qty, stock_qty, item_price].some(value => value === undefined)) {
                            return false;
                        }
                    
                        var itemPrice = item_price ? item_price : 0;
                    
                        // Determine color and weight based on stock levels
                        var lowStock = parseFloat(stock_qty) < parseFloat(re_order_qty);
                        var stockStyle = lowStock ? 'color: #FF5722; font-weight: bold;' : '';


                        // Create a new row for the selected item
                        tr = $(`<tr style="border-style: hidden!important; ${stockStyle}"></tr>`);
                        tr.attr('data-item-name', positem_name); // Store the item name in a data attribute

                        // Add the row's content
                        tr.append('<td style="text-align:center;">' + favIcon + '</td>');
                        tr.append('<td style="text-align:center;">&nbsp;</td>');
                        // item_no, stock_id, positem_name input field
                        tr.append('<td style="text-align:center;">' + item_no + '<input type="hidden" value="' + item_no + '" class="inputbox_tdrow" name="item_no[]" readonly><input type="hidden" value="' + item_id + '" class="inputbox_tdrow multiple_input" name="item_id[]" readonly></td>');
                        tr.append(`<td style="position: relative; text-align: left;" class="posItemsName_id"><input type="text" style="${stockStyle}" value="${positem_name}" class="form-control pos_salesDisInput" name="item_names[]" readonly autocomplete="off"></td>`);
                        tr.append('<td style="text-align:center;">' + item_type + '<input type="hidden" value="' + item_type + '" class="inputbox_tdrow" name="item_type[]" readonly><input type="hidden" value="' + store_id + '" class="inputbox_tdrow multiple_input" name="store_id[]" readonly></td>');
                        tr.append('<td style="text-align:center;">' + item_Supplier + '<input type="hidden" value="' + item_Supplier + '" class="inputbox_tdrow" name="item_store_name[]" readonly></td>');
                        tr.append('<td style="text-align:left; font-size: 0.9rem; color: #df6700; font-weight: bolder;">' + stock_qty.toFixed(2) + '<input type="hidden" value="' + stock_qty.toFixed(2) + '" class="inputbox_tdrow" id="stock_qty" name="stock_qty[]" readonly></td>');
                        tr.append('<td style="text-align:center;" id="mulInputQty"><input type="number" value="0" class="form-control text-center qty1 pos_salesDisInput" id="sales_qty" name="sales_qty[]" oninput="validity.valid || (value=\'\');" step="0.01" autocomplete="off" style="width: 95%;" required></td>');
                        tr.append('<td style="text-align:center; width: 7%;"><select class="form-control pos_salesDisInput item_uoms_select" name="item_uoms[]" style="width: 96%;"></select></td>');
                        //individual discount and also gross discount distribussion //individual gross vat tax amount distribussion
                        tr.append('<td style="text-align:center;" class="item_w_dis"><input type="number" value="0" class="form-control text-center pos_salesDisInput item_w_dis_input" name="item_w_dis[]" max="numberHere" min="0" oninput="validity.valid||(value=\'\');" autocomplete="off" style="width: 95%;"><input type="hidden" value="0" class="form-control text-center pos_inputbox" name="gross_dis[]" style="width: 95%;"><input type="hidden" value="0" class="form-control text-center pos_inputbox" name="gross_vat_tax[]" style="width: 95%;"></td>');
                        tr.append('<td style="text-align:center;" id="SpriceInput"><input type="number" value="' + itemPrice + '" class="form-control text-center pos_salesDisInput item_sales_price" oninput="validity.valid || (value=\'\');" step="0.01" name="item_price[]" autocomplete="off" style="width: 95%;" required></td>');
                        tr.append('<td style="text-align:center;" class="product_total"></td>');
                        tr.append('<td style="text-align:center;"><button type="button" class="btn btn-danger text-white btn-xs itemAdd_del_btn">X</button></td>');

                        // Append the new row to the table
                        $('#POSUP_field table tbody').append(tr);
                    
                        
                    
                        // Append the row to the table
                        $('#POS-field table tbody').append(tr);
                    
                        // Add event listeners for dynamic elements
                        tr.find('[name="sales_qty[]"], [name="item_price[]"], [name="item_w_dis[]"]').on('input keypress keyup keydown', calc);
                    
                        // Set sales_qty to 1 if empty on blur
                        tr.find('[name="sales_qty[]"]').on('blur', function () {
                            if (!$(this).val()) $(this).val();
                            calc();
                        });
                    
                        // Remove row on delete button click
                        tr.find('.itemAdd_del_btn').on('click', function () {
                            $(this).closest('tr').remove();
                            calc();
                        });

                        // Update UoM options asynchronously
                        updateUoMOptions(item_uom, tr);
                    
                        // Update UoM options
                        function updateUoMOptions(selectedUoM, row) {
                            var org_id = $('#id_org').val();
                            $.ajax({
                                url: '/get_list_of_item_uom/',
                                method: 'GET',
                                data: { org_id: org_id },
                                success: function (data) {
                        
                                    var select = row.find('.item_uoms_select');
                                    select.empty();
                        
                                    if (!data.iuom_list || data.iuom_list.length === 0) {
                                        console.warn('No UoM options found.');
                                        select.append('<option value=""></option>');
                                        return;
                                    }
                        
                                    $.each(data.iuom_list, function (index, uom) {
                                        var selected = uom.item_uom_name === selectedUoM ? 'selected' : '';
                                        select.append(`<option value="${uom.item_uom_id}" ${selected}>${uom.item_uom_name}</option>`);
                                    });
                                },
                                error: function (xhr, status, error) {
                                    console.error('Error fetching UoM options:', error);
                                }
                            });
                        }

                        $('#POS-field table tbody').on('input', '.item_sales_price', function () {
                            var value = $(this).val().trim();
                        
                            // Allow manual entry of float numbers, only highlight in red if the input is empty or invalid
                            if (value.length === 0 || isNaN(value)) {
                                $(this).css('background-color', 'red');
                            } else {
                                $(this).css('background-color', '#fff');
                            }
                        }).on('change blur', '.item_sales_price', function () {
                            var value = $(this).val().trim();
                        
                            // Check if the value is empty or zero
                            if (value.length === 0 || parseFloat(value) === 0) {
                                $(this).val('0');
                                $(this).css('background-color', 'red');
                            } else {
                                // Format the value to two decimal places if it's valid
                                if (!isNaN(parseFloat(value))) {
                                    $(this).val(parseFloat(value).toFixed(2));  // Format to 2 decimal places
                                }
                                $(this).css('background-color', '#fff');
                            }
                        
                            calc();
                        }).on('focus', '.item_sales_price', function () {
                            var value = $(this).val().trim();
                        
                            if (parseFloat(value) === 0) {
                                $(this).val('');
                                $(this).css('background-color', 'red');
                            }
                        });
                    
                        // Recalculate totals
                        calc();
                        clearAndFocusInput();
                        toggleItemModifyFields();
                        updateSerialNumbers();
                    }
                });

            },
        });

        //<!-- ====================================================================== -->
        const inputFieldPOSitem = document.getElementById('positem_name');

        // Set focus to the input field
        inputFieldPOSitem.focus();

        // Function to update the serial numbers
        function updateSerialNumbers() {
            $('#POS-field table tbody tr').each(function (index) {
                $(this).find('td:nth-child(2)').text(index + 1); // Update the serial number column
            });
        }

        //=========== Show/Hide the Favorite List when the button is clicked =====================
        // Function to adjust widths based on favorite list state
        function adjustWidthsBasedOnFavListState() {
            var favList = $('#id_myfavList');
            if (favList.css('display') === 'block') {
                updateWidths("23rem", "4rem", "3rem");
            } else {
                updateWidths("32rem", "6rem", "4rem");
            }
        }

        // Function to update widths
        function updateWidths(itemNameWidth, itemOtherNameWidth, itemQtyNameWidth) {
            $('.itemName').css('width', itemNameWidth);
            $('.itemOtherName').css('width', itemOtherNameWidth);
            $('.itemQtyName').css('width', itemQtyNameWidth);
        }

        // Function to set visibility of elements based on stored state
        function setVisibility() {
            var favListDisplay = localStorage.getItem('favListDisplay');
            var favBtnDisplay = localStorage.getItem('favBtnDisplay');

            $('#id_myfavList').css('display', favListDisplay ? favListDisplay : 'none');
            $('#id_myfavBtn').css('display', favBtnDisplay ? favBtnDisplay : 'block');

            // Adjust widths after setting visibility
            adjustWidthsBasedOnFavListState();
        }

        // Initial call to set visibility when the page loads
        setVisibility();

        // Show the Favorite List and hide the button when clicked
        $('#id_myfavBtn').click(function () {
            $('#id_myfavList').css('display', 'block');
            $('#id_myfavBtn').css('display', 'none');

            // Adjust widths
            updateWidths("23rem", "4rem", "3rem");

            // Store the state in localStorage
            localStorage.setItem('favListDisplay', 'block');
            localStorage.setItem('favBtnDisplay', 'none');
        });

        // Hide the Favorite List when the close button is clicked and show the button again
        $('.btn-close').click(function () {
            $('#id_myfavList').css('display', 'none');
            $('#id_myfavBtn').css('display', 'block');

            // Reset widths
            updateWidths("32rem", "6rem", "4rem");

            // Store the state in localStorage
            localStorage.setItem('favListDisplay', 'none');
            localStorage.setItem('favBtnDisplay', 'block');
        });
        //=========== Show/Hide the Favorite List when the button is clicked =====================
    });
    //<!--  -->


    // Helper function to check if a date is within 6 months
    function isWithin6Months(expDate) {
        // Parse the item.item_exp_date to a Date object
        var expDateObj = new Date(expDate);

        // Calculate the date 6 months from now
        var sixMonthsFromNow = new Date();
        sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);

        return expDateObj <= sixMonthsFromNow;
    }

    // calculation
    function calc() {
        var actual_amount = 0;
        var total_amount = 0;
        $('#POS-field table tbody tr').each(function () {
            let item_price = parseFloat($(this).find('[name="item_price[]"]').val()) || 0;
            let sales_qty = parseFloat($(this).find('[name="sales_qty[]"]').val()) || 0;
            let item_w_dis = parseFloat($(this).find('[name="item_w_dis[]"]').val()) || 0;
            
            let total = item_price * sales_qty;
            let g_total = total - item_w_dis;
            
            $(this).find('.product_total').text(g_total.toLocaleString('en-US'));
            actual_amount += g_total;
        });
        
        $('#actual_amount').text(actual_amount.toFixed(0).toLocaleString('en-US'));
        $('[name="actual_amount"]').val(actual_amount.toFixed(0));
        
        var vat_value = parseFloat($('[name="total_vat"]').val()) || 0;
        var vat_tax_amt = (actual_amount * vat_value) / 100;
        vat_tax_amt = vat_tax_amt || 0;
        
        $('#vat_amount').text(vat_tax_amt.toFixed(0));
        $('[name="vat_amount"]').val(vat_tax_amt.toFixed(0));
        
        var disc_amt = parseFloat($('[name="discount_amt"]').val()) || 0;
        $('#total_discount').text(disc_amt.toFixed(0).toLocaleString('en-US'));
        $('[name="total_discount"]').val(disc_amt.toFixed(0));
        
        var disc_per_amt = actual_amount ? (disc_amt / actual_amount) * 100 : 0;
        $('#discount_perc').text(disc_per_amt.toFixed(0).toLocaleString('en-US'));
        $('[name="discount_perc"]').val(disc_per_amt.toFixed(0));
        
        var total_itemQty = parseFloat($('[name="tot_count_serial"]').val()) || 1;
        var gross_dis_amt = disc_amt / total_itemQty;
        $('[name="gross_dis[]"]').val(gross_dis_amt.toFixed(3));
        
        var gross_vat_tax_amt = vat_tax_amt / total_itemQty;
        $('[name="gross_vat_tax[]"]').val(gross_vat_tax_amt.toFixed(3));
        
        var is_buyer = $('#id_buyer').val() === '1';
        var cost_buyer_amt = parseFloat($('[name="rent_other_expense"]').val()) || 0;
        var amt = (actual_amount + vat_tax_amt - disc_amt) + (is_buyer ? cost_buyer_amt : 0);
        
        $('#total_amount').text(amt.toFixed(0).toLocaleString('en-US'));
        $('[name="total_amount"]').val(amt.toFixed(0));
        
        var coll_multi_payment_amt = 0;
        $('input[name="multi_payment_amt[]"]').each(function () {
            coll_multi_payment_amt += parseFloat($(this).val()) || 0;
        });
        
        $('#receivable_amt').text(coll_multi_payment_amt.toFixed(0));
        $('[name="receivable_amt"]').val(coll_multi_payment_amt);
        
        //var coll_multi_handoncash_amt = 0;
        //$('input[name="multi_pay_mode[]"]').each(function () {
        //    if (['1', '5', '6', '7', '8'].includes($(this).val())) {
        //        coll_multi_handoncash_amt += parseFloat($(this).closest('tr').find('input[name="multi_payment_amt[]"]').val()) || 0;
        //    }
        //});

        var coll_multi_handoncash_amt = 0;

        $('input[name="multi_pay_mode[]"]').each(function () {
            var payMode = $(this).val().trim(); // Trim to avoid accidental spaces
            var payAmt = parseFloat($(this).closest('tr').find('input[name="multi_payment_amt[]"]').val()) || 0;

            if (payMode === "1") { // Direct comparison instead of array check
                coll_multi_handoncash_amt += payAmt;
            }
        });
        
        $('[name="hand_on_cash_amt"]').val(coll_multi_handoncash_amt);
        
        var payment_amt = parseFloat($('[name="payment_amt"]').val()) || 0;
        $('[name="given_amt"]').val(payment_amt.toFixed(0));
        var given = parseFloat($('[name="given_amt"]').val()) || 0;
        if (given > 0){
            var change_amt = given - payment_amt;
            $('#change_amt').text(change_amt.toFixed(0).toLocaleString('en-US'));
            $('[name="change_amt"]').val(change_amt.toFixed(0));   
        }
        
        var due_amt = amt - coll_multi_payment_amt;
        $('#due_amount').text(due_amt.toFixed(0));
        $('[name="due_amount"]').val(due_amt.toFixed(0));
        
        var sum_qty = 0;
        $('.qty1').each(function () {
            sum_qty += parseFloat($(this).val()) || 0;
        });
        $('.sum_qty_total').val(sum_qty);
        
        var count_tot_item = $('#mytbody').children('tr').length;
        $('#tot_count_serial').text(count_tot_item.toLocaleString('en-US'));
        $('[name="tot_count_serial"]').val(count_tot_item);
        
        var reward_points = parseFloat($('[name="total_amount"]').val()) || 0;
        var reward_point_bal = reward_points >= 100 ? Math.floor(reward_points / 100) : 0;
        $('[name="reward_point"]').val(reward_point_bal.toFixed(2));
    }

    // auto input tax vat work
    $(function () {
        $('#carryin_cost').find('input[name="rent_other_expense"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#vatCal').find('input[name="total_vat"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#dis_input').find('input[name="discount_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#payment_input').find('input[name="payment_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#given_input').find('input[name="given_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#mulInputQty').find('input[name="sales_qty"]').on('input keypress keyup keydown', function () {
            calc()
        })
    })

    // set defualt value
    $('#discount_amt').on('input change blur', function () {
        var value = $(this).val();
        if (value.trim().length === 0) {
            $(this).val('0');
            calc();
        }
    }).on('focus', function () {
        var value = $(this).val();
        if (value.trim() === '0') {
            $(this).val('');
        }
    });

    $('#payment_amt').on('input change blur', function () {
        var value = $(this).val();
        if (value.trim().length === 0) {
            $(this).val('0');
            calc();
        }
    }).on('focus', function () {
        var value = $(this).val();
        if (value.trim() === '0') {
            $(this).val('');
        }
    });

    // store_name from local storage
    $(document).ready(function () {
        // Get the select element
        var selectElement = document.getElementById('cash_point');

        // Attach an event listener to the select element
        selectElement.addEventListener('change', function (event) {
            // Get the selected store_name
            var selectedStoreName = event.target.options[event.target.selectedIndex].text;

            // Store the selected store_name in local storage
            localStorage.setItem('selectedStoreName', selectedStoreName);
        });

        // To retrieve the store_name from local storage
        var storedStoreName = localStorage.getItem('selectedStoreName');
        if (storedStoreName) {
            // Set the value of the select element if there's a stored value
            // Loop through options to find the matching store_name and set it as selected
            for (var i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].text === storedStoreName) {
                    selectElement.selectedIndex = i;
                    break;
                }
            }
        }
    });

    // add multiple input field add with value
    $(document).ready(function () {
        $('#check_out').click(function () {
            if ($('#POS-field table tbody tr').length <= 0) {
                toastr.warning("Add at least 1 product first!..");
                return false;
            }
        });
    
        $('#pos-form').on('keydown', function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                return false;
            }
        });
    
        $('#pos-form').submit(function (e) {
            e.preventDefault();
            var coll_multi_payment_amt = 0;
            var multi_collection_modes = 0;
            var coll_payment_amt = parseFloat($('#payment_amt').val().trim()) || 0;
        
            $('input[name="multi_payment_amt[]"]').each(function () {
                var coll_sum_value = parseFloat($(this).val()) || 0;
                coll_multi_payment_amt += coll_sum_value;
            });
    
            $('input[name="multi_collection_mode[][]"]').each(function () {
                multi_collection_modes = parseFloat($(this).val()) || 0;
            });
        
            console.log('coll_multi_payment_amt:', coll_multi_payment_amt);
            
            if (coll_payment_amt > 0) {
                $('#addMultiPay').trigger('click');
            }
            
            $('#check_out').prop('disabled', true).html('<i class="bx bx-loader-circle"></i> Processing...');
    
            setTimeout(() => {
                var zeroValueInputs = $('.item_sales_price, .qty1').filter(function () {
                    return $(this).val() === '0' || $(this).val() === '';
                });
                
                if (zeroValueInputs.length > 0) {
                    toastr.warning("Sales Quantity & Price of zero ('0') is not allowed. Please enter a valid value.");
                    zeroValueInputs.css('background-color', 'red');
                    zeroValueInputs.on('input', function () {
                        if ($(this).val() !== '0' && $(this).val() !== '') {
                            $(this).css('background-color', '');
                        }
                    });
                    $('#check_out').prop('disabled', false).html('Save & Print');
                    return;
                }
    
                var org_id = $('#id_org').val();
                var register = $('#id_reg_id').val();
                var coll_mode = $('#Collection_mode').val();
                var creditBalance = parseFloat($('#id_reg_balances').val()) || 0;
                var my_balance = creditBalance + coll_multi_payment_amt;
    
                if (multi_collection_modes === 4) {
                    if (!register) {
                        toastr.warning("Register Clients Not Found. Please Select Client First.");
                        $('#check_out').prop('disabled', false).html('Save & Print');
                        return false;
                    }
                    if (isNaN(coll_multi_payment_amt) || coll_multi_payment_amt <= 0) {
                        toastr.warning("Invalid Payment Amount.");
                        $('#check_out').prop('disabled', false).html('Save & Print');
                        return false;
                    }
                    if (my_balance > 0) {
                        toastr.warning("Insufficient Balance!");
                        $('#check_out').prop('disabled', false).html('Save & Print');
                        return false;
                    }
                }
    
                lineloaderstart();
    
                $.ajax({
                    headers: {
                        "X-CSRFToken": '{{csrf_token}}'
                    },
                    url: "{% url 'save_pos_billing' %}",
                    data: new FormData($('#pos-form')[0]),
                    cache: false,
                    contentType: false,
                    processData: false,
                    method: 'POST',
                    type: 'POST',
                    dataType: 'json',
                    success: function (resp) {
                        if (resp.status == 'success') {
                            document.getElementById("pos-form").reset();
                            $('#mytbody').empty();
                            var receiptUrl = "{% url 'receipt_modal' %}?id=" + resp.invoice_id + "&org_id=" + org_id;
                            modal_lg("Receipt", receiptUrl);
        
                            $('#modal_lg').on('hide.bs.modal', function () {
                                location.reload();
                            });
        
                            toastr.success("Bill Submission Successful!..");
                        } else {
                            toastr.error(resp.msg || "An error occurred", 'error');
                            console.error(resp);
                        }
                        lineloaderstop();
                    },
                    error: function () {
                        toastr.error("Network error! Please try again.");
                        $('#check_out').prop('disabled', false).html('Save & Print');
                    },
                    complete: function () {
                        setTimeout(function () {
                            $('#check_out').prop('disabled', false).html('Save & Print');
                        }, 3000);
                    }
                });
            }, 1000);
        });
    });
    

    $(document).ready(function () {
        $('.view-data').click(function (e) {
            e.preventDefault();
            var id = $(this).attr('data-id');
            var org_id = $('#id_org').val();
            //var isNotAllow = $(this).attr('data-not-allow');

            if (id) {
                lineloaderstart();
                // Include org_id in the URL
                var receiptUrl = "{% url 'receipt_modal' %}?id=" + id + "&org_id=" + org_id;
                modal_lg("Transaction's Receipt", receiptUrl);
                lineloaderstop();

                //if (isNotAllow === 'false') { // Ensure it's a string comparison for "false"
                //    $('#modal_lg').on('hide.bs.modal', function () {
                //        lineloaderstart();
                //        var chalanUrl = "{% url 'chalan_modal' %}?id=" + id + "&org_id=" + org_id;
                //        modal_lg("Delivery_Chalan", chalanUrl);

                //        // Stop loader when the chalan modal is shown
                //        $('#modal_lg').on('shown.bs.modal', function () {
                //            lineloaderstop();
                //        });

                //        // Remove the event handler to avoid multiple bindings
                //        $('#modal_lg').off('hide.bs.modal');
                //    });
                //}
            } else {
                console.error("Data id is undefined");
            }
        });
    });

    // input field hide && show based on selection
    $('#pay_mode').on('change', function () {
        const selectedValue = $(this).val();
        
        // Show the #otherType element if selectedValue is between 2 and 8
        if (selectedValue >= "2" && selectedValue <= "9") {
            $("#otherType").show();
        } else {
            $("#otherType").hide();
        }
    });

    // payment calc button
    function calcFun() {
        var calc_tot_bill = $('[name="due_amount"]').val()
        $('[name="payment_amt"]').val(parseFloat(calc_tot_bill))
        calc()
    }

    // reset form and table items
    function resetAndRemoveRows() {
        // main loader
        lineloaderstart();
        // main loader
        document.getElementById("pos-form").reset();
        //
        var node = document.getElementById("mytbody");
        while (node.hasChildNodes()) {
            node.removeChild(node.lastChild);
        }
        // Assuming you have an ID for the span element
        var elementIds = ['actual_amount', 'vat_amount', 'total_discount', 'total_amount', 'receivable_amt', 'due_amount'];
        // Reset the content of the span
        elementIds.forEach(function (id) {
            var element = document.getElementById(id);
            if (element) {
                element.innerHTML = '0.00'; // or assign a default value
            }
        });

        // main loader
        lineloaderstop();
        // main loader
    }

    //loader 
    window.addEventListener("load", () => {
        const loader = document.querySelector(".loader");
        const loaderBody = document.querySelector(".loader-body");

        setTimeout(() => {
            loader.style.display = "none"; // Hide the loader
            loaderBody.style.display = "none"; // Hide the loader-body
        }, 1100); // Hide the loader after 0.75 seconds
    });

    //Total VAT (%) 0, (-), 1 to 100 value only entry restricted
    const totalVatInput = document.getElementById('total_vat');

    totalVatInput.addEventListener('input', function () {
        let value = parseFloat(totalVatInput.value);

        if (isNaN(value)) {
            totalVatInput.value = '';
        } else {
            if (value < 1) {
                totalVatInput.value = '1';
            } else if (value > 100) {
                totalVatInput.value = '100';
            }
        }
    });

    // Pay Amt restrict negative values in an input field
    const paymentAmtInput = document.getElementById('payment_amt');

    paymentAmtInput.addEventListener('input', function () {
        let value = parseFloat(paymentAmtInput.value);

        if (isNaN(value) || value < 0) {
            paymentAmtInput.value = '0';
        }
    });

    // not apply carring cost
    $(document).ready(function () {
        function toggleFields() {
            var isDisabled = $('#id_notapp_carr_cost').is(':checked');

            // Disable or enable fields based on checkbox status
            $('#rent_other_expense').prop('disabled', isDisabled);
            $('#id_buyer').prop('disabled', isDisabled);
            $('#id_seller').prop('disabled', isDisabled);
            //$('#id_carriers').prop('disabled', isDisabled);
            //$('#id_driver_id').prop('disabled', isDisabled);
            //$('#id_driver_name').prop('disabled', isDisabled);
            //$('#id_driver_mobile').prop('disabled', isDisabled);
        }

        // Run the function on page load to apply the correct state
        toggleFields();
        toggleItemModifyFields();

        // Listen for changes to the checkbox to toggle fields dynamically
        $('#id_notapp_carr_cost').on('change', function () {
            toggleFields();
        });
        //
        $('#id_is_modified_items').on('change', function () {
            toggleItemModifyFields();
        });
    });

    function toggleItemModifyFields() {
        var isItemModiChecked = $('#id_is_modified_items').is(':checked');

        // Toggle readonly for item names based on checkbox status
        $('input[name="item_names[]"]').prop('readonly', !isItemModiChecked);

        // Toggle visibility of duplicate sale price inputs
        if (isItemModiChecked) {
            $('#dupItemRateTbRow').show(); // Show the header row for duplicate rates
            $('input[name="dup_item_price[]"]').closest('td').show(); // Show the duplicate sale price inputs
        } else {
            $('#dupItemRateTbRow').hide(); // Hide the header row for duplicate rates
            $('input[name="dup_item_price[]"]').closest('td').hide(); // Hide the duplicate sale price inputs
        }
    }
</script>
{% endblock %}