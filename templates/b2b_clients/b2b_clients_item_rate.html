{% extends 'base_form/main_base/main_base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_link %}
<!--========== CSS ==========-->
<link rel="stylesheet" href="{% static 'b2b_clients/css/b2b_clients.css' %}">
{% endblock %}
<!--========== CONTENTS start==========-->
{% block body %}
<main>
    <section>
        <div class="container-fluid">
            <!-- Main Heading -->
            <div class="row">
                <div class="col col-md-4 col-md-6 dashboar-head">
                    <div class="d-sm-flex align-items-center mb-2" style="display: flex;">
                        <i class='bx bx-poll text-success req-head-icon'></i>
                        <h1 class="h3 text-success req-head">B2B Clients Items Rate Setup</h1>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--  -->
    <form action="" method="" id="itemRate_form">
        <!-- hidden input id -->
        <input type="hidden" id="id_supplier_id" name="supplier_id" value="">
        <input type="hidden" id="id_item_id" name="item_id" value="">
        <input type="hidden" id="id_b2b_clitr_id" name="b2b_clitr_id" value="">
        <section>
            <div class="card po_card" style="margin-left: 0.5rem; margin-bottom: 1rem;">
                <div class="card-body">
                    <div class="report-filter">
                        <!-- Date Range Filter -->
                        <div class="date-range">
                            <div class="row date_range-body" style="display:flex; font-size: 0.8rem;">
                                <div class="date_range-element" style="display:flex">
                                    <!--  -->
                                    <div class="row store_row col-sm-6"
                                        style="flex-grow: 1; display: flex; justify-content: left;">
                                        <label for="id_filter_org" class="col-auto col-form-label">
                                            Organization:
                                        </label>
                                        <div class="col-sm-4">
                                            <select id="id_filter_org" name="filter_org"
                                                class="form-select store_Selectbox" aria-label="Default select example">
                                                {% for org in org_list %}
                                                <option id="{{org.org_id}}" value="{{org.org_id}}">
                                                    {{org.org_name}}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <!--  -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--  -->
        <section>
            <!-- loader start -->
            <section class="loader-section">
                <div class="loader-body">
                    <div class="loader">
                        <div class="upper ball"></div>
                        <div class="right ball"></div>
                        <div class="lower ball"></div>
                        <div class="left ball"></div>
                    </div>
                </div>
            </section>
            <!-- loader end -->
            <div class="row row_item_setup">
                <div class="col-sm-6">
                    <!-- List of Clients -->
                    <div class="card main-card" style="margin-left: 8.5px;">
                        <div class="card-body card-body_item_setup">
                            <div class="itemfilter_container">
                                <div class="filter_head">
                                    <h2 class="text-success">List of Clients</h2>
                                </div>
                                <!--  -->
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="card main-card">
                                            <div class="card-body card-body_item_setup">
                                                <!--  -->
                                                <div class="clientRate_TB" style="overflow-x: auto;">
                                                    <table id="CLTable" class="table table-striped table-hover"
                                                        style="width: 100%;">
                                                        <thead class="text-center table-header_itemlist">
                                                            <tr>
                                                                <th style="text-align:center; width: 20%;">Client No.
                                                                </th>
                                                                <th style="text-align:center; width: 65%;">Client Name
                                                                </th>
                                                            </tr>
                                                            <tr>
                                                                <th colspan="3"
                                                                    style="text-align:center; background: #fff !important;">
                                                                    <input type="search" id="clientssearch"
                                                                        class="form-control search_control item_inputbox"
                                                                        style="margin-left: 4px; background:#fffab6;"
                                                                        placeholder="Searching ..." autocomplete="off">
                                                                </th>
                                                            </tr>
                                                        </thead>

                                                        <tbody id="client_Tbody" class="table-body-row"
                                                            style="text-align:center; cursor: pointer;">
                                                            <!--  -->

                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- List of items -->
                    <div class="card main-card" style="margin-left: 8.5px; margin-top: 1rem;">
                        <div class="card-body card-body_item_setup">
                            <div class="itemfilter_container">
                                <div class="clients_head">
                                    <h2 class="text-primary">List of items</h2>
                                </div>
                                <!--  -->
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="card main-card">
                                            <div class="card-body card-body_item_setup">
                                                <!--  -->
                                                <div class="client_ItemTB" style="overflow-x: auto;">
                                                    <table id="CLItmTable" class="table table-striped table-hover"
                                                        style="width: 100%;">
                                                        <thead class="text-center table-header_itemlist">
                                                            <tr>
                                                                <th style="text-align:center; width: 20%;">Items No.
                                                                </th>
                                                                <th style="text-align:center; width: 65%;">Items Name
                                                                </th>
                                                            </tr>
                                                            <tr>
                                                                <th colspan="3"
                                                                    style="text-align:center; background: #fff !important;">
                                                                    <input type="search" id="itemSearch"
                                                                        class="form-control search_control item_inputbox"
                                                                        style="margin-left: 4px; background:#fffab6;"
                                                                        placeholder="Searching ..." autocomplete="off">
                                                                </th>
                                                            </tr>
                                                        </thead>

                                                        <tbody id="cl_ItemTbody" class="table-body-row"
                                                            style="text-align:center; cursor: pointer;">
                                                            <!--  -->

                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Items Details Information -->
                <!--  -->
                <div class="col-sm-6">
                    <div class="card main-card" style="margin-left: 8.5px;">
                        <div class="card-body card-body_item_setup">
                            <div class="itemfilter_container">
                                <div class="clients_item_Dtlhead">
                                    <h2 class="text-primary">Items/Clients Details Information</h2>
                                </div>
                                <!--  -->
                                <div class="row row_item_setup">
                                    <div class="col-sm-12">
                                        <div class="card main-card">
                                            <div class="card-body card-body_item_setup">
                                                <div class="row row_item_setup">
                                                    <div class="item_setupflag div_id_is_active"
                                                        style="display: flex; justify-content: right;">
                                                        <label class="form-check-label text-danger setupflag_label" style="margin-right: 0.5rem;"
                                                            for="id_is_active">
                                                            Active?
                                                        </label>
                                                        <input class="form-check-input" type="checkbox"
                                                            id="id_is_active" name="is_active" value="1" disabled>
                                                    </div>
                                                    <!--  -->
                                                    <div class="col-sm-4">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row div_id_item_no">
                                                                    <label for="id_item_no"
                                                                        class="col-sm-6 col-form-label font_size_filter">
                                                                        Item No:
                                                                    </label>

                                                                    <div class="col-sm-6">
                                                                        <input type="text" value=""
                                                                            class="form-control item_inputbox"
                                                                            id="id_item_no" name="item_no"
                                                                            autocomplete="off" readonly>
                                                                    </div>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--  -->
                                                    <div class="col-sm-8">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row div_id_item_name">
                                                                    <label for="id_item_name"
                                                                        class="col-sm-3 col-form-label font_size_filter">
                                                                        Item Name:
                                                                    </label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text"
                                                                            class="form-control item_inputbox"
                                                                            id="id_item_name" name="item_name"
                                                                            autocomplete="off" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--  -->
                                                <!-- 2nd row first -->
                                                <div class="row row_item_setup">
                                                    <div class="col-sm-12">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row div_id_uom_name">
                                                                    <label for="id_org"
                                                                        class="col-sm-s1 col-form-label font_size_filter">
                                                                        Org Name:
                                                                    </label>
                                                                    <div class="col-sm-s10">
                                                                        <!--  -->
                                                                        <input type="text" class="form-control item_inputbox"
                                                                            id="id_org" name="org" autocomplete="off" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 2nd row -->
                                                <div class="row row_item_setup">
                                                    <div class="col-sm-4">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row div_id_item_type_no">
                                                                    <label for="id_item_type_no"
                                                                        class="col-sm-6 col-form-label font_size_filter">
                                                                        Item Type:
                                                                    </label>
                                                                    <div class="col-sm-6">
                                                                        <input type="text" id="id_item_type_no"
                                                                            name="item_type_no"
                                                                            class="form-control item_inputbox" readonly>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--  -->
                                                    <div class="col-sm-8">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row">
                                                                    <div class="col-sm-12">
                                                                        <input type="text" class="form-control item_inputbox"
                                                                            id="id_item_type_name" name="item_type_name" autocomplete="off" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 3rd row -->
                                                <div class="row row_item_setup">
                                                    <div class="col-sm-4">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row div_id_item_no">
                                                                    <label for="id_item_no"
                                                                        class="col-sm-6 col-form-label font_size_filter">
                                                                        Sales Price:
                                                                    </label>
                                                                    <div class="col-sm-6">
                                                                        <input type="number" autocomplete="none"
                                                                            class="form-control item_inputbox"
                                                                            id="id_sales_price" name="sales_price" readonly>
                                                                    </div>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--  -->
                                                    <div class="col-sm-8">
                                                        <div class="card main-card">
                                                            <div class="card-body item_setup_sub">
                                                                <div class="row cash_point_row">
                                                                    <label for="id_uom_name"
                                                                        class="col-sm-3 col-form-label font_size_filter">
                                                                        UoM Name:
                                                                    </label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control item_inputbox"
                                                                            id="id_uom_name" name="uom_name" autocomplete="off" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- client details info -->
                                <div class="card main-card" style="margin-left: 8.5px;">
                                    <div class="card-body card-body_item_setup">
                                        <div class="itemfilter_container">
                                            <!--  -->
                                            <div class="row row_item_setup">
                                                <div class="col-sm-12">
                                                    <div class="card main-card">
                                                        <div class="card-body card-body_item_setup">
                                                            <div class="row row_item_setup">
                                                                <!--  -->
                                                                <div class="row row_item_setup">
                                                                    <div class="col-sm-4">
                                                                        <div class="card main-card">
                                                                            <div class="card-body item_setup_sub">
                                                                                <div class="row cash_point_row">
                                                                                    <label for="id_supplier_no"
                                                                                        class="col-sm-6 col-form-label font_size_filter">
                                                                                        Client No:
                                                                                    </label>
                                                                                    <div class="col-sm-6">
                                                                                        <input type="text" class="form-control item_inputbox"
                                                                                            id="id_supplier_no" name="supplier_no"
                                                                                            autocomplete="off" readonly>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="col-sm-8">
                                                                        <div class="card main-card">
                                                                            <div class="card-body item_setup_sub">
                                                                                <div class="row cash_point_row">
                                                                                    <label for="id_supplier_name"
                                                                                        class="col-sm-4 col-form-label font_size_filter">
                                                                                        Client Name:
                                                                                    </label>
                                                                                    <div class="col-sm-8">
                                                                                        <input type="text" class="form-control item_inputbox"
                                                                                            id="id_supplier_name" name="supplier_name"
                                                                                            autocomplete="off" readonly>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Item New Rate info -->
                                <div class="card main-card" style="margin-left: 8.5px;">
                                    <div class="card-body card-body_item_setup">
                                        <div class="itemfilter_container">
                                            <!--  -->
                                            <div class="row row_item_setup">
                                                <div class="col-sm-12">
                                                    <div class="card main-card">
                                                        <div class="card-body card-body_item_setup">
                                                            <div class="row row_item_setup">
                                                                <!--  -->
                                                                <div class="row row_item_setup">
                                                                    <div class="col-sm-12">
                                                                        <div class="card main-card">
                                                                            <div class="card-body item_setup_sub">
                                                                                <div class="row cash_point_row">
                                                                                    <label for="id_b2b_client_rate"
                                                                                        class="col-sm-4 col-form-label font_size_filter">
                                                                                        B2B Client Rate:
                                                                                    </label>
                                                                                    <div class="col-sm-6">
                                                                                        <input type="number" class="form-control item_inputbox" style="text-align: center;"
                                                                                            id="id_b2b_client_rate" name="b2b_client_rate" autocomplete="off">
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- submit button -->
                                <div class="submit_button" style="margin-top: 2rem; margin-bottom: 1rem;">
                                    <button type="submit" class="btn btn-success btn-sm"style="margin-right: 10px;">
                                        Save & Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--  -->
    </form>
</main>
<script>
    $(document).ready(function () {
        // Function to fetch clients list
        function fetchClientsList() {
            var orgFilter = $('#id_filter_org').val();
            var searchQuery = $('#clientssearch').val();
            var itemSearchQuery = $('#itemSearch').val();

            // Show the loader
            $('.loader-section').show();

            //================== client List ==================
            // Make the AJAX request
            $.ajax({
                url: "{% url 'get_b2b_clients_list' %}",
                type: 'GET',
                data: {
                    'org_filter': orgFilter,
                    'supp_search_query': searchQuery
                },
                dataType: 'json',
                success: function (response) {
                    // Hide the loader
                    $('.loader-section').hide();

                    // Clear the existing table body
                    $('#client_Tbody').empty();

                    // Populate the table body with the new data
                    response.data.forEach(function (client) {
                        var row = $('<tr>').attr("data-supplier-id", client.supplier_id).append(
                            $('<td>').text(client.supplier_no),
                            $('<td>').css("text-align", "left").text(client.supplier_name),
                        ).addClass("client-row");
                        $('#client_Tbody').append(row);
                    });

                    // Highlight selected row if applicable
                    highlightSelectedRowOnInit();

                    // Call handleClientRowSelection after adding rows
                    handleClientRowSelection();

                    // Check if there is a selected supplier ID in local storage and populate details
                    var selectedItemRSuppId = localStorage.getItem("selectedItemRSuppId");
                    if (selectedItemRSuppId) {
                        populateSupplierDetails(selectedItemRSuppId);
                    }
                },
                error: function (xhr, status, error) {
                    // Hide the loader
                    $('.loader-section').hide();
                    console.error('Error fetching clients list:', status, error);
                }
            });


            //================== Item list ==================
            // Make the AJAX request
            $.ajax({
                url: "{% url 'get_list_of_client_item_data' %}",
                type: 'GET',
                data: {
                    'org_filter': orgFilter,
                    'item_search_query': itemSearchQuery
                },
                dataType: 'json',
                success: function (response) {
                    // Hide the loader
                    $('.loader-section').hide();

                    // Clear the existing table body
                    $('#cl_ItemTbody').empty();

                    // Populate the table body with the new data
                    response.forEach(function (item) { // Removed .data here
                        var row = $('<tr>').attr("data-item-id", item.item_id).append(
                            $('<td>').text(item.item_no),
                            $('<td>').css("text-align", "left").text(item.item_name)
                        ).addClass("item-row");
                        $('#cl_ItemTbody').append(row);
                    });

                    // Highlight selected row if applicable
                    highlightItemSelectedRowOnInit();

                    // Call handleClientItemRowSelection after adding rows
                    handleClientItemRowSelection();

                    // Check if there is a selected Item ID in local storage and populate details
                    var selectedItemId = localStorage.getItem("selectedItemId");
                    if (selectedItemId) {
                        populateItemDetails(selectedItemId);
                        populateB2bClientItemRateDetails(selectedItemId);
                    }
                },
                error: function (xhr, status, error) {
                    // Hide the loader
                    $('.loader-section').hide();
                    console.error('Error fetching Item list:', status, error);
                }
            });
        }

        // Bind fetchClientsList function to input events
        $('#id_filter_org, #clientssearch, #itemSearch').on('change keyup', function () {
            fetchClientsList();
        });

        // Bind an event handler to the change event of #id_filter_org
        $('#id_filter_org').on('change', function () {
            // Remove the "selected-row" class from all elements with the class ".client-row"
            $('.client-row').removeClass('selected-row');
            $('.item-row').removeClass('selected-row');

            // Clear the supplier details
            supp_populateTable({});
            item_populateTable({});
            b2bClientItemRate({});

            // Clear the selected supplier ID from local storage
            localStorage.removeItem("selectedItemRSuppId");
            localStorage.removeItem("selectedItemId");

            // Check if there is a selected supplier ID in local storage and populate details
            var selectedItemRSuppId = localStorage.getItem("selectedItemRSuppId");
            if (selectedItemRSuppId) {
                populateSupplierDetails(selectedItemRSuppId);
            }

            // Check if there is a selected Item ID in local storage and populate details
            var selectedItemId = localStorage.getItem("selectedItemId");
            if (selectedItemId) {
                populateItemDetails(selectedItemId);
                populateB2bClientItemRateDetails(selectedItemId);
            }
        });

        // Initial fetch
        fetchClientsList();


        $(function () {
            $('#itemRate_form').submit(function (e) {
                e.preventDefault();
                var formData = new FormData($(this)[0]);
        
                $.ajax({
                    headers: {
                        "X-CSRFToken": '{{csrf_token}}'
                    },
                    url: "{% url 'save_update_b2b_client_item_rate' %}",
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    method: 'POST',
                    type: 'POST',
                    dataType: 'json',
                    success: function (resp) {
                        if (resp.success) {
                            toastr.success(resp.msg);
                            $('.loader-section').show();
                            // Hide loader
                            setTimeout(function () {
                                $('.loader-section').hide();
                            }, 1100);
                            // Check if there is a selected supplier ID in local storage and populate details
                            var selectedItemRSuppId = localStorage.getItem("selectedItemRSuppId");
                            if (selectedItemRSuppId) {
                                populateSupplierDetails(selectedItemRSuppId);
                            }
        
                            // Check if there is a selected Item ID in local storage and populate details
                            var selectedItemId = localStorage.getItem("selectedItemId");
                            if (selectedItemId) {
                                populateItemDetails(selectedItemId);
                                populateB2bClientItemRateDetails(selectedItemId);
                            }
                        } else {
                            toastr.error(resp.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error('An error occurred while processing your request.');
                    }
                });
            });
        });
    });

    // Function to handle row selection
    function handleClientRowSelection() {
        // Attach click event listener to all client rows
        $(document).on("click", ".client-row", function () {
            var clickedClientId = $(this).data("supplier-id"); // Get the supplier ID from the clicked row

            // Remove highlighting from other rows
            $(".client-row").removeClass("selected-row");

            // Highlight the selected row
            $(this).addClass("selected-row");

            // Save the selected supplier ID to local storage
            localStorage.setItem("selectedItemRSuppId", clickedClientId);

            // Call the function to populate the table with supplier details
            populateSupplierDetails(clickedClientId);

            // Populate b2b client item rate details for the selected item and supplier
            var selectedItemId = localStorage.getItem("selectedItemId");
            if (selectedItemId) {
                populateB2bClientItemRateDetails(selectedItemId);
            }
        });
    }

    function handleClientItemRowSelection() {
        //<!-- for item selection -->
        $(document).on("click", ".item-row", function () {
            var clickedItemId = $(this).data("item-id"); // Get the supplier ID from the clicked row

            // Remove highlighting from other rows
            $(".item-row").removeClass("selected-row");

            // Highlight the selected row
            $(this).addClass("selected-row");

            // Save the selected supplier ID to local storage
            localStorage.setItem("selectedItemId", clickedItemId);

            // Call the function to populate the table with supplier details
            populateItemDetails(clickedItemId);
            
            // Populate b2b client item rate details for the selected item and supplier
            var selectedItemRSuppId = localStorage.getItem("selectedItemRSuppId");
            if (selectedItemRSuppId) {
                populateB2bClientItemRateDetails(clickedItemId);
            }
        });
    }

    // Function to populate the table with supplier details
    function populateSupplierDetails(supplierId) {
        if (supplierId) {
            $.ajax({
                type: "GET",
                url: "/get_supplier_lists/" + supplierId + "/",
                dataType: "json",
                success: function (data) {
                    supp_populateTable(data);
                },
                error: function (xhr, status, error) {
                    console.log("AJAX Error:", error);
                    //toastr.warning("Failed to fetch Supplier details");
                }
            });
        }
    }

    // Function to populate the table with supplier details
    function supp_populateTable(data) {
        // Clear existing supplier details
        $('#id_supplier_id').val("");
        $('#id_supplier_no').val("");
        $('#id_supplier_name').val("");

        // Populate with new data if available
        if (data.hasOwnProperty('supplier_Dtls') && data.supplier_Dtls.length > 0) {
            var supplier = data.supplier_Dtls[0]; // Assuming only one supplier detail is returned
            $('#id_supplier_id').val(supplier.supplier_id);
            $('#id_supplier_no').val(supplier.supplier_no);
            $('#id_supplier_name').val(supplier.supplier_name);
        }
    }

    // Function to populate the table with items details
    function populateItemDetails(itemsId) {
        if (itemsId) {
            $.ajax({
                type: "GET",
                url: "/get_item_lists/" + itemsId + "/",
                dataType: "json",
                success: function (data) {
                    item_populateTable(data);
                },
                error: function (xhr, status, error) {
                    console.log("AJAX Error:", error);
                    //toastr.warning("Failed to fetch Supplier details");
                }
            });
        }
    }

    // Function to populate the table with supplier details
    function item_populateTable(data) {
        // Clear existing supplier details
        $('#id_item_id').val("");
        $('#id_item_no').val("");
        $('#id_item_name').val("");
        $('#id_org').val("");
        $('#id_item_type_no').val("");
        $('#id_item_type_name').val("");
        $('#id_sales_price').val("");
        $('#id_uom_name').val("");
        $('#id_is_active').prop('checked', false);

        // Populate with new data if available
        if (data.hasOwnProperty('item_dtls') && data.item_dtls.length > 0) {
            var item = data.item_dtls[0]; // Assuming only one supplier detail is returned
            $('#id_item_id').val(item.item_id);
            $('#id_item_no').val(item.item_no);
            $('#id_item_name').val(item.item_name);
            $('#id_org').val(item.org_name);
            $('#id_item_type_no').val(item.item_type_no);
            $('#id_item_type_name').val(item.type_name);
            $('#id_sales_price').val(item.sales_price);
            $('#id_uom_name').val(item.item_uom_name);
            
            // Check the checkbox based on the is_active property
            $('#id_is_active').prop('checked', item.is_active === true);
        }
    }

    // Function to populate the table with b2b items client rate details
    function populateB2bClientItemRateDetails(clickedItemId) {
        var orgId = $('#id_filter_org').val(); // Assuming this gets the organization ID
        var supplierId = localStorage.getItem("selectedItemRSuppId"); // This needs to be set somewhere in the code
    
        $.ajax({
            type: "GET",
            url: "/get_b2b_client_item_rate/" + clickedItemId + "/",
            data: {
                'filter_org': orgId,
                'supplier_id': supplierId
            },
            dataType: "json",
            success: function (data) {
                b2bClientItemRate(data);
            },
            error: function (xhr, status, error) {
                console.log("AJAX Error:", error);
            }
        });
    }

    // Function to populate the table with b2b client item rate details
    function b2bClientItemRate(data) {
        $('#id_b2b_clitr_id').val("");
        $('#id_b2b_client_rate').val("");

        // Populate with new data if available
        if (data.hasOwnProperty('b2bitem_dtls') && data.b2bitem_dtls.length > 0) {
            var b2bclientItemRate = data.b2bitem_dtls[0]; // Assuming only one supplier detail is returned
            $('#id_b2b_clitr_id').val(b2bclientItemRate.b2b_clitr_id);
            $('#id_b2b_client_rate').val(b2bclientItemRate.b2b_client_rate);
        }
    }

    // Function to highlight selected row on initialization
    function highlightSelectedRowOnInit() {
        var selectedItemRSuppId = localStorage.getItem("selectedItemRSuppId");
        if (selectedItemRSuppId) {
            $(".client-row").each(function () {
                if ($(this).data("supplier-id").toString() === selectedItemRSuppId) {
                    $(this).addClass("selected-row");
                    return false; // Break the loop once the match is found
                }
            });
        }
    }

    function highlightItemSelectedRowOnInit() {
        var selectedItemId = localStorage.getItem("selectedItemId");
        if (selectedItemId) {
            $(".item-row").each(function () {
                if ($(this).data("item-id").toString() === selectedItemId) {
                    $(this).addClass("selected-row");
                    return false; // Break the loop once the match is found
                }
            });
        }
    }

    //==========================================
    //loader 
    const loader = document.querySelector(".loader");
    const loaderBody = document.querySelector(".loader-body");

    // Function to show the loader
    function showTypeLoader() {
        loader.style.display = "block";
        loaderBody.style.display = "block";
        loader.style.left = "50%"; // Set left position to center
        loader.style.top = "50%"; // Set top position to center
    }

    // Function to hide the loader
    function hideTypeLoader() {
        loader.style.display = "none";
        loaderBody.style.display = "none";
    }

    // Function to check and show loader based on local storage
    function checkAndTypeShowLoader() {
        const loaderVisible = localStorage.getItem("loaderVisible");
        if (loaderVisible === "true") {
            showTypeLoader();
        }
    }

    // Event listener for radio button change
    document.querySelectorAll('input[name="typeoption"]').forEach(radio => {
        radio.addEventListener('change', function () {
            showTypeLoader(); // Show loader when radio button changes
            // Add logic to handle the radio button change if needed
            setTimeout(() => {
                hideTypeLoader(); // Hide loader after a delay (you can adjust this)
            }, 1100); // Example: hide loader after 2 seconds
        });
    });

    // Check and show loader on page load
    checkAndTypeShowLoader();

    window.addEventListener("load", () => {
        // Adjust the delay in milliseconds (e.g., 2000 for 2 seconds)
        setTimeout(() => {
            hideTypeLoader();
        }, 1100);
    });
    //loader
    //==========================================
</script>
{% endblock %}