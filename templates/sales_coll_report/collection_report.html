{% extends 'base_form/main_base/main_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block extra_link %}
<!--========== CSS ==========-->
<link rel="stylesheet" href="{% static 'sales_coll_report_style/css/sales_coll_report_style.css' %}">
{% endblock %}
<!--========== CONTENTS start==========-->
{% block body %}
<!-- loader start -->
<div class="loader"></div>
<!-- loader end -->
<main>
    <section>
        <div class="container-fluid">
            <!-- Main Heading -->
            <div class="row">
                <div class="col col-md-4 col-md-6 dashboar-head">
                    <div class="d-sm-flex align-items-center mb-2" style="height: 2rem;">
                        <i class='bx bx-collection text-success req-head-icon'></i>
                        <h1 class="h3 text-success req-head">Collections Report</h1>
                        <!--  -->
                        <div style="position: absolute; right: 2rem;">
                            <!--  -->
                            {% if billingBtn_access %}
                            <button type="button" onClick="navigateTo('/item_pos_billing/')"
                                class="btn btn-success bg-gradient col-ms-3 text-white btn-xs item_payment_btn"
                                style="display: flex; font-size: 0.8rem; font-weight: bolder; box-shadow: 4px 5px 10px 0px #43507e; border-radius: 0.7rem; border: 1.5px solid #fff; height: 1.7rem; padding: 0.5rem 1.3rem; flex-direction: row; flex-wrap: nowrap; align-items: center;">
                                Billing
                            </button>
                            {% endif %}
                            <!--  -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--  -->
    <section>
        <div class="card" style="align-items: start; margin-bottom: 0.5rem;">
            <div class="card-body col-sm-12">
                <div class="report-filter">
                    <!-- Date Range Filter -->
                    <div class="date-range">
                        <div class="row date_range-body col-sm-range" style="display:flex; font-size: 0.8rem;">
                            <div class="date_range-element col-sm-12" style="display:flex">
                                <!--  -->
                                <div class="row g-3 col-sm-5 align-items-center">
                                    <div class="col-auto">
                                        <label for="id_filter_org" class="col-form-label">Org :</label>
                                    </div>
                                    <div class="col-sm-9">
                                        <select id="id_filter_org" name="filter_org"
                                            class="form-select item_inputbox store_Selectbox"
                                            aria-label="Default select example">
                                            {% for org in org_list %}
                                            <option id="{{org.org_id}}" value="{{org.org_id}}">
                                                {{org.org_name}}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <!--  -->
                                <div class="row g-3 col-sm-4 align-items-center">
                                    <div class="col-auto">
                                        <label for="id_filter_branch" class="col-form-label">Branch :</label>
                                    </div>
                                    <div class="col-sm-8">
                                        <select id="id_filter_branch" name="filter_branch"
                                            class="form-select item_inputbox store_Selectbox"
                                            aria-label="Default select example">
                                            <!--  -->
                                        </select>
                                    </div>
                                </div>
                                <!--  -->
                                <!-- from to date -->
                                <div class="row g-3 col-sm-3 align-items-center">
                                    <div class="col-auto">
                                        <label for="start_from" class="col-form-label">From :</label>
                                    </div>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control item_inputbox datepicker" id="start_from"
                                            name="start_from" autocomplete="off" required>
                                    </div>
                                </div>
                                <!--  -->
                                <div class="row g-3 col-sm-3 align-items-center">
                                    <div class="col-auto">
                                        <label for="end_from" class="col-form-label">To :</label>
                                    </div>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control item_inputbox datepicker" id="end_from"
                                            name="end_from" autocomplete="off" required>
                                    </div>
                                </div>
                                <!-- from to date -->
                                <!--  -->
                                <div class="row g-3 col-report-Btn align-items-center">
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary invBtn btn-xs text-white collDtlsReport">
                                            Details
                                        </button>
                                        <button id="generatePDF" class="btn btn-warning invBtn btn-xs text-white">
                                            PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--  -->
    <!-- containt start -->
    <section>
        <div class="card">
            <div class="card-body" style="padding: 0.2rem 0.2rem;">
                <div class="col-xl-12">
                    <form action="" method="">
                        <div class="table-body">
                            <table id="collectionTB" class="table table-striped" style="width: 100%;">
                                <thead class="text-center table-header">
                                    <tr style="border-style: hidden!important;">
                                        <th style="text-align:center; vertical-align: middle;" rowspan="2">SL</th>
                                        <th style="text-align:center; vertical-align: middle;" rowspan="2">Inv. No</th>
                                        <th style="text-align:center; vertical-align: middle;" rowspan="2">C. Name</th>
                                        <th style="text-align:center; vertical-align: middle;" rowspan="2">Mobile</th>
                                        <th style="text-align:center; vertical-align: middle; width: 6%;" rowspan="2">Coll. P Mode</th>
                                        <th style="text-align:center; vertical-align: middle; width: 6%;" rowspan="2">Ref. P Mode</th>
                                        <th style="text-align:center;">Total Bill</th>
                                        <th style="text-align:center;">C. Cost</th>
                                        <th style="text-align:center;">Discount</th>
                                        <th style="text-align:center;">VAT Tax</th>
                                        <th style="text-align:center;">Cancel</th>
                                        <th style="text-align:center;">Net Bill</th>
                                        <th style="text-align:center;">Collection</th>
                                        <th style="text-align:center;">Due Coll.</th>
                                        <th style="text-align:center;">Tot. Coll.</th>
                                        <th style="text-align:center;">Adjust Amt.</th>
                                        <th style="text-align:center;">Refund Amt.</th>
                                        <th style="text-align:center; width: 8%;">Net Coll.</th>
                                    </tr>
                                    <tr style="border-style: hidden!important;">
                                        <th style="text-align:center;">(A)</th>
                                        <th style="text-align:center;">(B)</th>
                                        <th style="text-align:center;">(C)</th>
                                        <th style="text-align:center;">(D)</th>
                                        <th style="text-align:center;">(E)</th>
                                        <th style="text-align:center;">(A+B+D)-(C+E) (F)</th>
                                        <th style="text-align:center;">(G)</th>
                                        <th style="text-align:center;">(H)</th>
                                        <th style="text-align:center;">(G+H) (I)</th>
                                        <th style="text-align:center;">(J)</th>
                                        <th style="text-align:center;">(K)</th>
                                        <th style="text-align:center;">(I-K)</th>
                                    </tr>
                                </thead>
                                <tbody class="table-body-row">
                                    <!--  -->
                                    
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- containt end  -->
    <script>
        $(function () {
            $(document).on('click', '.collDtlsReport', function (e) {
                e.preventDefault();
                
                var OrgId = $('#id_filter_org').val();
                var branchId = $('#id_filter_branch').val();
                var startData = $('#start_from').val();
                var endData = $('#end_from').val();
                
                // Correct the query string construction
                var colldtlsReportUrl = "{% url 'collections_details_reports' %}" + 
                    "?org_id=" + encodeURIComponent(OrgId) +
                    "&branch_id=" + encodeURIComponent(branchId) +
                    "&start_from=" + encodeURIComponent(startData) +
                    "&end_from=" + encodeURIComponent(endData);
                
                window.open(colldtlsReportUrl, '_blank');
            });
        });

        //
        $(document).ready(function() {
            // Function to update table with data from API response
            function updateTable(data) {
                var tbody = $('#collectionTB tbody');
                tbody.empty(); // Clear existing table rows

                var payModeMap = {
                    1: 'Cash',
                    2: 'Cheque',
                    3: 'Debit Card',
                    4: 'Credit Card',
                    5: 'Bkash',
                    6: 'Nagad',
                    7: 'Upay',
                    8: 'UCash',
                    9: 'Bank Deposit'
                };

                // Function to format payment modes with numbering
                function formatPaymentModes(modes) {
                    return (modes || []).map((mode, index) => (index + 1) + '. ' + (payModeMap[mode] || mode)).join('<br>');
                }
                
                // Iterate over data and append rows to the table body
                $.each(data.combined_data, function(index, item) {
                    var coll_pay_mode_name = formatPaymentModes(item.coll_pay_modes);
                    var ref_pay_mode_name = formatPaymentModes(item.ref_pay_modes);
                    
                    var row = '<tr style="border-style: hidden!important;">' +
                        '<td style="text-align:center;">' + (index + 1) + '</td>' +
                        '<td style="text-align:center;">' + item.inv_id + '</td>' +
                        '<td style="text-align:left;">' + item.customer_name + '</td>' +
                        '<td style="text-align:center;">' + item.mobile_number + '</td>' +
                        '<td style="text-align:left;">' + coll_pay_mode_name + '</td>' +
                        '<td style="text-align:left;">' + ref_pay_mode_name + '</td>' +
                        '<td style="text-align:center;">' + item.total_sales + '</td>' +
                        '<td style="text-align:center;">' + item.total_cost + '</td>' +
                        '<td style="text-align:center;">' + item.total_discount + '</td>' +
                        '<td style="text-align:center;">' + item.total_vat_tax + '</td>' +
                        '<td style="text-align:center;">' + item.total_cancel_amt + '</td>' +
                        '<td style="text-align:center;">' + item.total_net_bill + '</td>' +
                        '<td style="text-align:center;">' + item.total_collection_amt + '</td>' +
                        '<td style="text-align:center;">' + item.total_due_collection_amt + '</td>' +
                        '<td style="text-align:center;">' + item.grand_collection + '</td>' +
                        '<td style="text-align:center;">' + item.total_adjust_amt + '</td>' +
                        '<td style="text-align:center;">' + item.total_refund_collection_amt + '</td>' +
                        '<td style="text-align:center;">' + item.total_net_collection + '</td>' +
                        '</tr>';
                    tbody.append(row);
                });
                
                // Add another row for total values
                var totalRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="6"></td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grandtotal_sales + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grandtotal_cost + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_discount + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_vat_tax + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_cancel_amt + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_net_bill + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_collection + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_due_collection + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_grand_collection + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_adjust_collection + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_refund_collection + '</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_net_collection + '</td>' +
                    '</tr>';
                tbody.append(totalRow);

                //
                var totalRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Sub Total Collections:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_net_collection + '</td>' +
                    '</tr>';
                tbody.append(totalRow);
                //======================== Mobile Bank Collections / Refund Descriptions Start ========================
                // Add mobile bank wise collection row for total values
                var mobileBlankstartRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="18"></td>' +
                    '</tr>';
                tbody.append(mobileBlankstartRow);

                var mobilebankdescrRow = '<tr>' +
                    '<td style="text-align:right; font-size: 1rem; font-weight: bold;" colspan="18">Mobile Bank Descriptions</td>' +
                    '</tr>';
                tbody.append(mobilebankdescrRow);
                
                // Bkash
                var BkashRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Bkash Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_bkash_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(BkashRow);
                // Nagad
                var NagadRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Nagad Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_nagad_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(NagadRow);
                // Upay
                var UpayRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Upay Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_upay_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(UpayRow);
                // UCash
                var UCashRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">UCash Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_ucash_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(UCashRow);

                // Mobile Bank Collection
                var totmobilebankRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Mobile Bank Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.mobile_bank_coll + '</td>' +
                    '</tr>';
                tbody.append(totmobilebankRow);

                // without invoice collection with mobile Bank
                var withoutinvmbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Without Invoice Collection (Mobile Bank):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_woinvcoll_mb_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvmbcollRow);

                // Registration Local Client Payment Amount (Mobile Bank)
                var withoutinvmbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Registration Local Client Payment Amount (Mobile Bank) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_regclipay_mb_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvmbcollRow);

                // Supplier/Party Payment Amount (Mobile Bank)
                var withoutinvmbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Supplier/Party Payment Amount (Mobile Bank) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_suppclipay_mb_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvmbcollRow);

                // Total Mobile Bank Collection
                var totmobilebankRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Net Mobile Bank Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.net_mobile_bank_coll + '</td>' +
                    '</tr>';
                tbody.append(totmobilebankRow);

                                            //==============mobile Bank refund ==============
                // Bkash Refund
                var BkashRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Bkash Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_bkash_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(BkashRefRow);
                // Nagad Refund
                var NagadRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Nagad Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_nagad_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(NagadRefRow);
                // Upay Refund
                var UpayRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Upay Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_upay_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(UpayRefRow);
                // UCash Refund
                var UCashRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">UCash Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_ucash_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(UCashRefRow);
                // Total Mobile Bank Refund
                var totmobilebankRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Mobile Bank Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_mobile_bank_refund + '</td>' +
                    '</tr>';
                tbody.append(totmobilebankRefRow);
                // Grand Total Mobile Bank Collections
                var grandtotmobilebankRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Grand Total Mobile Bank Collections:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_mobile_bank_coll + '</td>' +
                    '</tr>';
                tbody.append(grandtotmobilebankRow);

                var mobileBlankendRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="18"></td>' +
                    '</tr>';
                tbody.append(mobileBlankendRow);
                //======================== Mobile Bank Collections / Refund Descriptions end ========================
                
                //======================== Bank Collections / Refund Descriptions Start ========================
                // Add bank wise collection row for total values
                var bankdescrRow = '<tr>' +
                    '<td style="text-align:right; font-size: 1rem; font-weight: bold;" colspan="18">Bank Descriptions</td>' +
                    '</tr>';
                tbody.append(bankdescrRow);
                // Cheque
                var ChequeCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Cheque Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_cheque_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(ChequeCollRow);
                // Debit Card
                var DebitCardCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Debit Card Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_debit_card_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(DebitCardCollRow);
                // Credit Card
                var CreditCardCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Credit Card Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_credit_card_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(CreditCardCollRow);
                // Bank Deposit
                var BankDepositCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Bank Deposit Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_bank_deposit_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(BankDepositCollRow);

                // Total Bank Collections
                var totbankCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Bank Collections:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_bank_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(totbankCollRow);

                // without invoice collection with Bank
                var withoutinvbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Without Invoice Collection (Bank):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_woinvcoll_b_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvbcollRow);

                // Registration Local Client Payment Amount (Bank)
                var withoutinvbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Registration Local Client Payment Amount (Bank) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_regclipay_b_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvbcollRow);

                // Supplier/Party Payment Amount (Bank)
                var withoutinvbcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Supplier/Party Payment Amount (Bank) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_suppclipay_b_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvbcollRow);

                // Net Bank Collections
                var totbankCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Net Bank Collections:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.net_bank_coll_amt + '</td>' +
                    '</tr>';
                tbody.append(totbankCollRow);

                                                //============== Bank Refund ==============
                // Cheque Refund
                var ChequeRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Cheque Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_cheque_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(ChequeRefRow);
                // Debit Card Refund
                var DebitCardRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Debit Card Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_debit_card_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(DebitCardRefRow);
                // Credit Card Refund
                var CreditCardRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Credit Card Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_credit_card_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(CreditCardRefRow);
                // Bank Deposit Refund
                var BankDepositRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem;" colspan="17">Bank Deposit Refund:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem;">' + data.grand_bank_deposit_ref_amt + '</td>' +
                    '</tr>';
                tbody.append(BankDepositRefRow);
                // Total Bank Refund
                var totbankRefRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Bank Refunds:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_bank_refund_amt + '</td>' +
                    '</tr>';
                tbody.append(totbankRefRow);
                // Grand Total Bank Collections
                var grandtotbankRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Grand Total Bank Collections:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_bank_coll + '</td>' +
                    '</tr>';
                tbody.append(grandtotbankRow);
                //
                var bankBlankendRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="18"></td>' +
                    '</tr>';
                tbody.append(bankBlankendRow);
                //======================== Bank Collections / Refund Descriptions end ========================
                
                // Cash collection Description
                var bankdescrRow = '<tr>' +
                    '<td style="text-align:right; font-size: 1rem; font-weight: bold;" colspan="18">Cash Collection Descriptions</td>' +
                    '</tr>';
                tbody.append(bankdescrRow);

                // net Sub Total Collections
                var otherRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Net Sub Total Collections (Cash):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.net_sub_total_coll_cash + '</td>' +
                    '</tr>';
                tbody.append(otherRow);

                // Other Expense total values
                var otherRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Other Expense (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_other_exp_amt + '</td>' +
                    '</tr>';
                tbody.append(otherRow);

                // grand carrying payment amt
                var carryingRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Carrying / Lifting Cost (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_carrying_pay_amt + '</td>' +
                    '</tr>';
                tbody.append(carryingRow);

                // Local Purchase On Cash for total values
                var lpRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Local Purchase On Cash (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_amt + '</td>' +
                    '</tr>';
                    //data.total_bankdepositRow_amt
                tbody.append(lpRow);

                // Local Purchase return On Cash for total values
                var lprRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Local Purchase Return On Cash (+):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_ret_total_amt + '</td>' +
                    '</tr>';
                    //data.total_bankdepositRow_amt
                tbody.append(lprRow);

                // Manual Return Receive wise collection row for total values
                var MrrRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Manual Return Recieved (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_mrr_total_amt + '</td>' +
                    '</tr>';
                tbody.append(MrrRow);

                // without invoice collection with cash
                var withoutinvcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Without Invoice Collection (Cash) (+):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_woinvcoll_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvcollRow);

                // Registration Local Client Payment Amount (Cash)
                var withoutinvcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Registration Local Client Payment Amount (Cash) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_regclipay_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvcollRow);

                // Supplier/Party Payment Amount (Cash)
                var withoutinvcollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Supplier/Party Payment Amount (Cash) (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_suppclipay_amt + '</td>' +
                    '</tr>';
                tbody.append(withoutinvcollRow);

                // others branch collection receive row for total values
                var otherbrnchrecRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Daily collection received from Sub Branch: (+):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.dep_rec_sub_branch + '</td>' +
                    '</tr>';
                    //data.total_bankdepositRow_amt
                tbody.append(otherbrnchrecRow);

                // Add another row for total values
                var grandCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Net Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.grand_total_collection + '</td>' +
                    '</tr>';
                tbody.append(grandCollRow);

                // others branch payment to main branch wise collection row for total values
                var othBranchtomainbranchRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Daily collection Deposit from Main Branch: (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.deposit_main_branch + '</td>' +
                    '</tr>';
                    //data.total_bankdepositRow_amt
                tbody.append(othBranchtomainbranchRow);

                // Add another row for Bank Deposit
                var grandCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Daily Collection Bank Deposit (-):</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_daily_deposit + '</td>' +
                    '</tr>';
                tbody.append(grandCollRow);

                // Add another row for Remaining Collection from Total Net Collection
                var grandCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Remaining Collection from Total Net Collection:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_remaining_collection + '</td>' +
                    '</tr>';
                tbody.append(grandCollRow);

                // Add another row for Cash on Hand
                var grandCollRow = '<tr>' +
                    '<td style="text-align:right; font-size: 0.75rem; font-weight: bold;" colspan="17">Total Cash on Hands:</td>' +
                    '<td style="text-align:center; font-size: 0.75rem; font-weight: bold;">' + data.total_cash_on_hand + '</td>' +
                    '</tr>';
                tbody.append(grandCollRow);
            }
        
            // Function to make AJAX request and update table
            function fetchDataAndPopulateTable(startFrom, endFrom, filterOrg, filterBranch) {
                startLoader();
                // Make AJAX request to collectionsReportAPI
                $.ajax({
                    url: '/get_collections_report_values/', // Adjust the URL based on your project setup
                    type: 'POST',
                    dataType: 'json',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}' // Ensure that csrf_token is replaced with the actual CSRF token value
                    },
                    data: {
                        start_from: startFrom,
                        end_from: endFrom,
                        org_id: filterOrg,
                        branch_id: filterBranch,
                    },
                    success: function(response) {
                        // Call updateTable function with API response data
                        updateTable(response);
                        endLoader();
                    },
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            }
        
            // Set today's date as the default value for start_from and end_from inputs
            var today = new Date();
            var formattedDate = today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + ('0' + today.getDate()).slice(-2);
            $('#start_from').val(formattedDate);
            $('#end_from').val(formattedDate);
        
            // Fetch and populate table on page load with today's date
            //fetchDataAndPopulateTable(formattedDate, formattedDate);
        
            // Add event listeners for date input changes
            $('#start_from, #end_from, #id_filter_org, #id_filter_branch').change(function() {
                // Get the values of start_from and end_from when date inputs change
                var startsFrom = $('#start_from').val();
                var endsFrom = $('#end_from').val();
                var filterOrg = $('#id_filter_org').val();
                var filterBranch = $('#id_filter_branch').val();
        
                // Fetch and populate table with updated date range
                fetchDataAndPopulateTable(startsFrom, endsFrom, filterOrg, filterBranch);
            });
        });


        // loader start
        function startLoader() {
            const loader = document.querySelector(".loader");
            loader.classList.remove("loader-hidden");
        }
        
        function endLoader() {
            const loader = document.querySelector(".loader");
            loader.classList.remove("loader-hidden");
            setTimeout(() => {
                loader.classList.add("loader-hidden");
            }, 500);
        }
        //loader end

        //======================================================================================

        // get branch option org wise
        $(document).ready(function () {
            // Initial population of branch options based on the selected organization
            updateBranchOptionsfilter();

            // Event listener for the change event on #id_filter_org
            $('#id_filter_org').change(function () {
                updateBranchOptionsfilter();
            });

            function updateBranchOptionsfilter() {
                // Get the selected organization ID
                var selectedFilterOrgId = $('#id_filter_org').val();

                // Make an AJAX request to get branch options based on the selected organization
                $.ajax({
                    url: '/get_branch_options/',
                    method: 'GET',
                    data: { org_id: selectedFilterOrgId },
                    success: function (data) {
                        // Clear existing options
                        $('#id_filter_branch').empty();

                        // Add fetched branch options
                        $.each(data.branch_list, function (index, branch) {
                            $('#id_filter_branch').append('<option value="' + branch.branch_id + '">' + branch.branch_name + '</option>');
                        });

                        // Trigger change event for #id_filter_branch to automatically update its value
                        $('#id_filter_branch').trigger('change');
                    },
                    error: function (error) {
                        console.error('Error fetching branch options:', error);
                    }
                });
            }
        });

        // loader scrt
        window.addEventListener("load", () => {
            const loader = document.querySelector(".loader");

            loader.classList.add("loader-hidden");

            loader.addEventListener("transitionend", () => {
                // document.body.removeChild("loader");
            });
        });

        //Start date and End Date load data
        // Check if values are in local storage
        //const storedStartDate = localStorage.getItem('start_from');
        //const storedEndDate = localStorage.getItem('end_from');

        // Set the values of the date input fields
        //if (storedStartDate) {
        //    document.getElementById('start_from').value = storedStartDate;
        //}

        //if (storedEndDate) {
        //    document.getElementById('end_from').value = storedEndDate;
        //}

        $(document).ready(function () {
            let companyInfo;
            // Make Ajax request to get user information
            $.ajax({
                type: 'GET',
                url: '/get_user_org_informations/',  // URL mapped in your Django urlpatterns
                success: function (response) {
                    companyInfo = response;
                },
                error: function (error) {
                    console.error('Error fetching user information:', error);
                }
            });


            //======================================  XX  Report  XX    ==================================
            //<!-- report js code -->
            // Event listener for the Generate PDF button
            $('#generatePDF').on('click', function () {
                // Initialize jsPDF and the autotable plugin
                const doc = new jsPDF('landscape');

                // Get the start_from and end_from values from the input fields
                const start_from = $('#start_from').val();
                const end_from = $('#end_from').val();

                // Define the header styling
                const headerX = 5; // X position
                const headerY = 10; // Y position
                const headerFontSize = 8;
                const headerFontColor = '#333'; // Color in HEX format
                const maxHeaderWidth = 285; // Maximum width for the header

                // Function to update the header content
                function updateHeader() {
                    // Header content
                    const headerText = [
                        `${companyInfo.org_name}`,
                        `${companyInfo.address}`,
                        `Email: ${companyInfo.email}, Website: ${companyInfo.website}`,
                        `Hotline: ${companyInfo.phone}, ${companyInfo.hotline}, Fax: ${companyInfo.fax}`,
                        "From: " + start_from + " To: " + end_from,
                        "",
                        "Collection Report",
                        ""
                    ].join('\n');

                    doc.setFontSize(headerFontSize);
                    doc.setTextColor(headerFontColor);

                    let currentY = headerY;

                    // Split header text into lines and center align each line
                    headerText.split('\n').forEach((line, index) => {
                        let fontSize = headerFontSize; // Default font size
                        if (index === 0) {
                            fontSize = 12; // Customize the font size for the first line
                        } else if (index === 1) {
                            fontSize = 9;
                        } else if (index === 6) {
                            fontSize = 13;
                        }

                        doc.setFontSize(fontSize); // Set the font size for the current line

                        const textWidth = doc.getTextWidth(line);
                        const xPos = headerX + (maxHeaderWidth - textWidth) / 2; // Calculate the X position for center alignment

                        doc.text(line, xPos, currentY);
                        currentY += fontSize * 0.5; // Adjust vertical spacing
                    });
                }

                //<!-- footer start -->
                // Generate the content for the footer
                const footerText = 'Software By: TBOX, Contact: +8801309-994317,';

                // Calculate the width and height for the footer
                const footerWidth = maxHeaderWidth; // Use the same width as the header
                const footerHeight = 4; // Adjust the height as needed

                // Calculate the Y position for the footer (e.g., at the bottom of the page)
                const footerY = doc.internal.pageSize.height - footerHeight;

                // Set the font size, font color, and other styles for the footer
                const footerFontSize = 8;
                const footerFontColor = '#333'; // Color in HEX format

                doc.setFontSize(footerFontSize);
                doc.setTextColor(footerFontColor);

                //<!-- footer start -->
                doc.pageCount = 0; // Initialize the page count

                // Function to update the footer content
                function updateFooter() {
                    // Get the current date and time
                    const now = new Date();
                    const formattedDateTime = now.toLocaleString(); // Customize date and time format as needed
                    const pageNumber = doc.pageCount + 1; // Add 1 to start page numbering from 1

                    // Replace the placeholders with the actual values
                    const footer = `${footerText} - Printed By: ${companyInfo.first_name} ${companyInfo.last_name} - Printed on: ${formattedDateTime} - Page ${pageNumber}`;

                    // Add the updated footer text to the page
                    doc.text(footer, headerX, footerY, { align: 'left', maxWidth: footerWidth });
                }

                // Function to calculate the height of the header
                function calculateHeaderHeight() {
                    // Define the header content
                    const headerText = `
                        ${companyInfo.org_name}
                        ${companyInfo.address}
                        Email: ${companyInfo.email}, Website: ${companyInfo.website}
                        Hotline: ${companyInfo.phone}, ${companyInfo.hotline}, Fax: ${companyInfo.fax}
                        From: ${start_from} To: ${end_from}

                        Collection Report
                        
                    `;

                    let headerHeight = 0;

                    // Calculate the height of the header content
                    headerText.split('\n').forEach(line => {
                        headerHeight += doc.getTextDimensions(line).h + 1;
                    });

                    return headerHeight;
                }

                // Calculate the header height
                const headerHeight = calculateHeaderHeight();

                // Get the table and remove the last column (13th column)
                const table = document.getElementById('collectionTB');
                const rows = table.querySelectorAll('tr');

                // Function to calculate the table height
                function calculateTableHeight() {
                    const pageHeight = doc.internal.pageSize.height;
                    const footerHeight = 10; // Adjust this value as needed

                    return pageHeight - footerHeight - headerHeight - 20; // 20 is for spacing
                }

                // Calculate the table height
                const tableHeight = calculateTableHeight();

                // Function to generate the table
                function generateTable() {
                    // Convert the modified table to a data URL and add it to the PDF
                    doc.autoTable({
                        html: table,
                        startY: headerHeight + 10, // Start the table below the header with some spacing
                        tableHeight: tableHeight,

                        // Customize column widths using the 'columnStyles' option
                        columnStyles: {
                            0: { halign: 'right', fontStyle: 'bold' }, // Set the width of the first column
                            1: { halign: 'center' },
                            2: { cellWidth: 40, halign: 'left' },
                            3: { halign: 'center' },
                            4: { halign: 'center' },
                            5: { halign: 'center' },
                            6: { halign: 'center' },
                            7: { halign: 'center' },
                            8: { halign: 'center' },
                            9: { halign: 'center' },
                            10: { halign: 'center' },
                            11: { halign: 'center' },
                            12: { halign: 'center' },
                            13: { halign: 'center' },
                            14: { halign: 'center' },
                            15: { cellWidth: 20, halign: 'center', fontStyle: 'bold' },
                            // Add more column styles as needed
                        },

                        //<!-- footer start -->
                        didDrawPage: function (data) {
                            // Update the footer on each page
                            updateFooter();

                            // Increment the page count after updating the footer
                            doc.pageCount++;
                        },
                        //<!-- footer end -->

                        theme: 'grid', // Use the 'grid' theme for table borders
                        styles: {
                            textColor: '#333', // Text color of table content
                            fontSize: 8.5, // Font size for table content
                            cellPadding: 2,
                        },
                        alternateRowStyles: {
                            // Customize alternating row colors
                            fillColor: '#fff',
                        },
                        headStyles: {
                            // Customize table header styles
                            fontSize: 8,
                            fillColor: '#FDFDFA',
                            textColor: '#333',
                            fontStyle: 'bold',
                            lineWidth: 0.1, // Border width (adjust as needed)
                            halign: 'center',
                            //lineColor: '#F5F5F1', // Border color (adjust as needed)
                        },
                        scale: 0.9,
                    });
                }

                // Calculate the number of pages needed for the table
                const tablePages = Math.ceil(tableHeight / doc.internal.pageSize.height);

                // Generate the header only on the first page
                updateHeader();
                updateFooter();

                // Generate the table on each page
                for (let i = 0; i < tablePages; i++) {
                    if (i > 0) {
                        doc.addPage(); // Add a new page for the table
                        updateFooter(); // Update the footer on each subsequent page
                    }

                    generateTable(); // Generate the table on the current page
                }

                // Generate a data URL for the PDF
                const pdfDataUrl = doc.output('datauristring');

                // Create a new window or tab and load the PDF data URL
                const pdfWindow = window.open();
                pdfWindow.document.write('<iframe width="100%" height="100%" frameborder="0" src="' + pdfDataUrl + '" marginwidth="0" marginheight="0" style="padding: 0;"></iframe>');
                pdfWindow.document.close();

                if (!pdfWindow) {
                    alert('Please allow pop-ups to view the PDF.');
                }
            });
        });                            
    </script>
</main>
{% endblock %}