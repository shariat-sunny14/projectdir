{% extends 'base_form/main_base/main_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block extra_link %}
<!--========== CSS ==========-->
<link rel="stylesheet" href="{% static 'item_pos_style/css/item_pos_style.css' %}">
{% endblock %}
<!--========== CONTENTS start==========-->
{% block body %}
<!-- loader start -->
<section>
    <div class="loader-body">
        <div class="loader">
            <div class="upper ball"></div>
            <div class="right ball"></div>
            <div class="lower ball"></div>
            <div class="left ball"></div>
        </div>
    </div>
</section>
<!-- loader end -->
<main>
    <section style="display: flex; background: #f6f6f6bf;">
        <!-- main pos body -->
        <section class="container-fluid" style="margin-top: 0.5rem; margin-bottom:0.5rem;">
            <section style="border: 1px solid rgba(0, 0, 0, .125); border-top: none; border-radius: 0.3rem;">
                <div style="border: 1px solid rgba(0, 0, 0, .125);
                    margin-bottom: 0.5rem;
                    border-left: none;
                    border-right: none;
                    border-top-left-radius: 0.3rem;
                    border-top-right-radius: 0.3rem;
                    background: #0b5345;">
                    <!-- Main Heading -->
                    <div class="row">
                        <div class="col col-md-4 col-md-6 dashboar-head" style="display:flex; align-items: center;">
                            <div class="d-sm-flex align-items-center mb-2" style="height: 1.5rem; width: 100%; margin-left: 1rem;">
                                <div class="col-md-3" style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: flex-start; align-items: center;">
                                    <i class='bx bx-credit-card text-white req-head-icon'></i>
                                    <h1 class="h3 text-white req-head">Edit/Update Manual Delivery Chalan</h1>
                                </div>
                                <!--  -->
                                <div class="col-md-9" style="display: flex; justify-content: right;">
                                    <!--  -->
                                    {% if billingBtn_access %}
                                    <button type="button" onClick="navigateTo('/item_pos_billing/')"
                                        class="btn bg-gradient col-ms-3 text-white btn-xs item_payment_btn"
                                        style="font-weight: bolder; box-shadow: 4px 2px 5px 2px #084639; border-radius: 0.7rem; border: 1.5px solid #fff; height: 1.8rem;">
                                        Billing
                                    </button>
                                    {% endif %}
                                    <!--  -->
                                    <button type="button" onClick="navigateTo('/delivery_chalan_services/')"
                                        class="btn bg-gradient col-ms-3 text-white btn-xs item_payment_btn"
                                        style="margin-right: 1rem; font-weight: bolder; box-shadow: 4px 2px 5px 2px #084639; border-radius: 0.7rem; border: 1.5px solid #fff; height: 1.8rem;">
                                        Chalan List
                                    </button>
                                    <!--  -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--  -->
                <section style="display: flex; width: 100%;">
                    <!--  -->
                    <!-- favorite list navbar -->
                    <section id="id_myfavBtn" style="display: block;">
                        <div style="height: 99%;">
                            <button class="btn text-white vertical-text myFavBtn" type="button" style="background: #0b5345;">
                                Favorite List
                            </button>
                        </div>
                    </section>
                    <section id="id_myfavList"
                        style="width: 30%; display: none; margin-left: 0.3rem; margin-bottom: 0.5rem; background: rgb(212, 220, 255); border: 1px solid rgb(182 196 255); border-radius: 0.25rem;">
                        <!--  -->
                        <section>
                            <div>
                                <div class="favlist-header" style="background: #0b5345;">
                                    <h5 class="fav-title" id="id_fav_title">Favorite List</h5>
                                    <button type="button" class="btn-close text-white"></button>
                                </div>
                                <div class="favlist-body" style="height: 130vh;">
                                    <div class="fav-itemTable">
                                        <table id="listOfItem" class="table table-striped table-hover" style="width: 100%;">
                                            <thead class="text-center fav-table-header" style="border-style: none;">
                                                <tr>
                                                    <th colspan="3"
                                                        style="text-align:center; background: #d4dcff !important;">
                                                        <input type="search" id="searchfavlist"
                                                            class="form-control search_control fav-search-input"
                                                            style="background:#fffab6;" placeholder="Searching Item ..."
                                                            autocomplete="off">
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="favItemTB" class="table-body-row favItemTbody" style="border-style: none !important;">
                                                <!-- load ajax value -->

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </section>
                    <!--  -->
                    <!-- form body -->
                    <section style="width: 100%; margin-left: 0.5rem; margin-right: 0.5rem;">
                        <form action="" id="UPDMDELICHALAN">
                            <input type="hidden" name="id_chalan_id" value="{{chalan_data.pk}}">
                            <!-- billing mode radio button -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="radioBtnAlign" style="display: none;">
                                                                            <div class="form-check form-check-manual"
                                                                                style="margin-right: 1rem;">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="1"
                                                                                    name="general_bill"
                                                                                    id="id_general_bill"
                                                                                    onclick="resetInputFields();"
                                                                                    checked>
                                                                                <label class="form-check-label"
                                                                                    for="id_general_bill">
                                                                                    General Billing
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-manual">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="0"
                                                                                    name="b2b_clients"
                                                                                    id="id_b2b_clients" disabled>
                                                                                <label class="form-check-label"
                                                                                    for="id_b2b_clients">
                                                                                    B2B Clients
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="radioBtnAlign">
                                                                            <div class="form-check form-check-manual"
                                                                                style="margin-right: 1rem;">
                                                                                <input class="form-check-input"
                                                                                    type="radio" value="0"
                                                                                    name="non_register"
                                                                                    id="id_non_register">
                                                                                <label class="form-check-label"
                                                                                    for="id_non_register">
                                                                                    Non Register
                                                                                </label>
                                                                            </div>
                                                                            <div class="form-check form-check-manual">
                                                                                <input class="form-check-input" type="radio" value="1"
                                                                                    name="register" id="id_register" checked>
                                                                                <label class="form-check-label"
                                                                                    for="id_register">
                                                                                    Register
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- billing register buyer && B2B client searching -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="col-sm-12" style="display: flex;">
                                    <!--  -->
                                    <div class="col-sm-6">
                                        <div id="client_searchBody" style="display: none; margin-right: 0.3rem;">
                                            <div class="card main_pos_card">
                                                <div class="row cash_point_row">
                                                    <div class="col-sm-12">
                                                        <div class="card pos_card">
                                                            <div class="card-body pos_card_body">
                                                                <div class="row cash_point_row">
                                                                    <!--  -->
                                                                    <div class="card pos_card" id="client_searchInput"
                                                                        style="display: none;">
                                                                        <div class="card-body pos_card_body">
                                                                            <div class="row cash_point_row">
                                                                                <!--  -->
                                                                                <div
                                                                                    style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;  margin-bottom: 0.2rem;">
                                                                                    <div class="col-sm-10">
                                                                                        <fieldset>
                                                                                            <input type="text"
                                                                                                class="form-control pos_inputbox"
                                                                                                id="clients_name"
                                                                                                placeholder="Search B2B Clients"
                                                                                                style="background: #fffab6;">
                                                                                        </fieldset>
                                                                                    </div>
                                                                                </div>
                                                                                <!--  -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                    <div class="col-sm-6" style="margin-left: 0.4rem;">
                                        <div id="reg_searchBody" style="display: block;">
                                            <div class="card main_pos_card">
                                                <div class="row cash_point_row">
                                                    <div class="col-sm-12">
                                                        <div class="card pos_card">
                                                            <div class="card-body pos_card_body">
                                                                <div class="row cash_point_row">
                                                                    <!--  -->
                                                                    <div class="card pos_card" id="reg_searchInput"
                                                                        style="display: block;">
                                                                        <div class="card-body pos_card_body">
                                                                            <div class="row cash_point_row">
                                                                                <!--  -->
                                                                                <div
                                                                                    style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: center;  margin-bottom: 0.2rem;">
                                                                                    <div class="col-sm-10">
                                                                                        <input type="text"
                                                                                            class="form-control pos_inputbox"
                                                                                            id="register_customer"
                                                                                            placeholder="Search by CN / Name / Phone No"
                                                                                            style="background: #fffab6;">
                                                                                    </div>
                                                                                </div>
                                                                                <!--  -->
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--  -->
                                </div>
                            </section>
                            <!-- B2B Clients Information -->
                            <section id="b2b_clients_info" style="margin-bottom: 0.2rem; display: none;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-4">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_no" title="Client No"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Cl. No:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="hidden" class="form-control pos_inputbox" id="id_reg_id" name="reg_id" readonly>
                                                                                    <input type="hidden" class="form-control pos_inputbox" id="id_supplier_id" name="supplier_id" readonly>
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off"
                                                                                        id="id_client_no" placeholder="Client No" readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-8">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_name" title="Client Name"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Cl. Name:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_client_name"
                                                                                        name="client_name" placeholder="Client Name" readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-5">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_contact"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Contact:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="number"
                                                                                        class="form-control pos_inputbox"
                                                                                        autocomplete="off"
                                                                                        id="id_contact" name="contact"
                                                                                        readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-7">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_client_address"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Address:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <textarea type="text"
                                                                                        class="form-control pos_inputbox"
                                                                                        style="height: 1.55rem;"
                                                                                        autocomplete="off"
                                                                                        id="id_client_address"
                                                                                        name="client_address"
                                                                                        readonly></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <!-- org/cash point/branch/last inv no print btn -->
                            <section style="margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-12">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-4">
                                                                            <div class="row cash_point_row">
                                                                                <label for="cash_point" title="Cash Point"
                                                                                    class="col-sm-2 col-form-label">
                                                                                    Cash Point:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <select id="cash_point" name="cash_point" class="form-select pos_inputbox">
                                                                                        <!--  -->
        
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-4">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_org" title="Organization Name"
                                                                                    class="col-sm-client-label col-form-label">
                                                                                    Organization:
                                                                                </label>
                                                                                <div class="col-sm-client-input">
                                                                                    <select id="id_org" name="org" class="form-select pos_inputbox">
                                                                                        {% for org in org_list %}
                                                                                        <option value="{{ org.org_id }}"
                                                                                            id="{{ org.org_id }}">
                                                                                            {{ org.org_name }}
                                                                                        </option>
                                                                                        {% endfor %}
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-4">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_branchs" class="col-sm-2 col-form-label">
                                                                                    Branchs:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <select id="id_branchs" name="branchs" class="form-select pos_inputbox">
                                                                                        <!-- branch List -->
                                                                                    </select>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <section>
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-8">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="customer_name"
                                                                            class="col-sm-2 col-form-label">
                                                                            Customer's:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                value="General Customer" id="customer_name"
                                                                                name="customer_name" autocomplete="off"
                                                                                required>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_house_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            House No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_house_no"
                                                                                name="house_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_road_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Road No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_road_no" autocomplete="off"
                                                                                name="road_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_sector_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Sector No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_sector_no" name="sector_no"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-6">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="mobile_number"
                                                                            class="col-sm-2 col-form-label">
                                                                            Mobile:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="number"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="mobile_number"
                                                                                name="mobile_number" required>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_area"
                                                                            class="col-sm-2 col-form-label">
                                                                            Area:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_area"
                                                                                name="area">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_floor_no"
                                                                            class="col-sm-2 col-form-label">
                                                                            Floor No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_floor_no"
                                                                                name="floor_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_side_off_factory" style="color: #f15900; font-weight: 700;"
                                                                            class="col-sm-2 col-form-label">
                                                                             Side Office/Factory:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                id="id_side_off_factory" name="side_off_factory"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <!-- Credit Balance -->
                                                                    <div class="row cash_point_row" id="id_sales_type"
                                                                        style="display: none;">
                                                                        <label for="credit_balance"
                                                                            class="col-sm-2 text-danger col-form-label"
                                                                            style="font-weight: bolder;">
                                                                            Credit Bal. :
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <!--  -->
                                                                            <input type="number" id="credit_balance"
                                                                                name="credit_balance" value=""
                                                                                class="form-control pos_inputbox"
                                                                                style="display: none;">
                                                                            <span id="id_credit_balance" class="form-control item_inputbox text-success credit_balance">0.00</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-sm-4">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-12">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <label for="gender"
                                                                            class="col-sm-2 col-form-label">Gender:</label>
                                                                        <div class="col-sm-8">
                                                                            <select id="gender" name="gender" class="form-select reg_wise_disable pos_inputbox"
                                                                                aria-label="Default select example">
                                                                                <option value="" selected disabled>
                                                                                    Choose Gender ...
                                                                                </option>
                                                                                <option value="Male">Male</option>
                                                                                <option value="Female">Female</option>
                                                                                <option value="Others">Others</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="emergency_person"
                                                                            class="col-sm-2 col-form-label">
                                                                            Emer. Person:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control pos_inputbox"
                                                                                id="emergency_person"
                                                                                name="emergency_person"
                                                                                autocomplete="off">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_emergency_phone"
                                                                            class="col-sm-2 col-form-label">
                                                                            Emer. Phone:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="number" class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_emergency_phone" name="emergency_phone">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                    <!--  -->
                                                                    <div class="row cash_point_row">
                                                                        <label for="id_order_no" style="color: #f15900; font-weight: 700;"
                                                                            class="col-sm-2 col-form-label">
                                                                            Order No.:
                                                                        </label>
                                                                        <div class="col-sm-8">
                                                                            <input type="text"
                                                                                class="form-control reg_wise_disable pos_inputbox"
                                                                                autocomplete="off" id="id_order_no"
                                                                                name="order_no">
                                                                        </div>
                                                                    </div>
                                                                    <!--  -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </section>
                            <!-- address/ add new items -->
                            <section style="margin-top: 0.3rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-8"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-12">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_address"
                                                                                    class="col-sm-1 col-form-label">
                                                                                    Address:
                                                                                </label>
                                                                                <div class="col-sm-10">
                                                                                    <textarea type="text" class="form-control reg_wise_disable pos_inputbox" id="id_address" name="address" autocomplete="off"
                                                                                        style="height: 2rem;"></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-4">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="row cash_point_row">
                                                                            <div class="itemBtn" style="display: flex; width: 97%; flex-direction: row; flex-wrap: nowrap; justify-content: flex-end;">
                                                                                <button id="addItemPosBtn" type="button" class="btn btn-warning text-white btn-xs newItemAddBtm">
                                                                                    Add New Items
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- driver carriers searching -->
                            <section id="b2b_clients_info" style="margin-top: 0.3rem; margin-bottom: 0.2rem;">
                                <div class="card main_pos_card">
                                    <div class="row cash_point_row">
                                        <div class="col-sm-12">
                                            <div class="card pos_card">
                                                <div class="card-body pos_card_body">
                                                    <div class="row cash_point_row">
                                                        <div class="col-sm-4"
                                                            style="border-right: 1px solid rgba(0,0,0,.125);">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-12">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_carriers" class="col-sm-2 col-form-label" style="display: flex; font-size: 11.5px; flex-direction: row; justify-content: flex-end;">
                                                                                    Carriers:
                                                                                </label>
                                                                                <div class="col-md-cary">
                                                                                    <input type="search" class="form-control pos_inputbox" autocomplete="off" style="margin-top: 0px; height: 2rem; background: #fffab6;"
                                                                                        id="id_carriers" placeholder="Search Carrier's/Driver Name ...">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!--  -->
                                                        <div class="col-sm-8">
                                                            <div class="card pos_card">
                                                                <div class="card-body pos_card_body">
                                                                    <div class="row cash_point_row">
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_driver_name" class="col-sm-2 col-form-label">
                                                                                    Carrier's Name:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="hidden" id="id_driver_id" name="driver_id">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_driver_name" name="driver_name">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                        <div class="col-sm-6">
                                                                            <div class="row cash_point_row">
                                                                                <label for="id_driver_mobile" class="col-sm-2 col-form-label">
                                                                                    Carrier's Mobile:
                                                                                </label>
                                                                                <div class="col-sm-8">
                                                                                    <input type="text" class="form-control pos_inputbox" autocomplete="off" id="id_driver_mobile" name="driver_mobile">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!--  -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!-- driver carriers searching -->
                            <section>
                                <div class="col-xl-12">
                                    <div class="table-body item_table_body">
                                        <table id="item_add" class="table table-striped" style="width: 100%;">
                                            <tbody class="table-body-row" style="text-align:center;" id="POSaddItemTB">
                                                <tr style="border-style: hidden!important;">
                                                    <td
                                                        style="display: flex; text-align: left; justify-content: center; border-style: none; flex-direction: row; flex-wrap: wrap; align-content: center; align-items: center;">
                                                        <div class="col-sm-12 div_id_pos_item_name"
                                                            style="display: flex; justify-content: center; align-items: center;">
                                                            <div class="col-sm-8">
                                                                <!--  -->
                                                                <div class="col-sm-12">
                                                                    <!--  -->
                                                                    <div class="item_search-body">
                                                                        <div class="search-icon">
                                                                            <i class='bx bx-search'
                                                                                style="margin-top: 3px; color: aliceblue;"></i>
                                                                        </div>
                                                                        <!--  -->
                                                                        <!-- searching item list for pos -->
                                                                        <input type="search" id="positem_name"
                                                                            placeholder="Search..." value=""
                                                                            class="pos-control pos_item input_datalist pos_searchBox"
                                                                            autocomplete="off">
                                                                        <div class="speech-icon">
                                                                            <i class='bx bxs-microphone speech'></i>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!--  -->
                                                            <div class="col-sm-4">
                                                                <select id="id_filter_suppliers" name="filter_suppliers"
                                                                    class="form-select pos_inputbox">
                                                                    <!--  -->

                                                                </select>
                                                            </div>

                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <section>
                                <div class="col-xl-12">
                                    <div class="table-body item_table_body">
                                        <div class="d-flex w-100" id="POS-field">
                                            <table class="table table-striped" style="width: 100%;" id="mul_item_tbl">
                                                <thead class="text-center table-header_itemlist">
                                                    <tr style="border-style: hidden!important;">
                                                        <th style="text-align:center; width: 3%;"></th>
                                                        <th style="text-align:center; width: 3%;">Sl</th>
                                                        <th style="text-align:center; width: 10%;">Item No</th>
                                                        <th style="text-align:center; width: 30%;">Item Name</th>
                                                        <th style="text-align:center; width: 30%;">Store Name</th>
                                                        <th style="text-align:center; width: 15%;">Delivery Qty</th>
                                                        <th style="text-align:center; width: 3%;">
                                                            opt.
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody id="mytbody">

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <!--  -->
                            <!--  -->
                            <section style="margin-top: 5rem; margin-bottom: 1rem;">
                                <div class="payment-submitBtn">
                                    <button type="button" style="text-align:center; width: 5rem;" id="resetButton"
                                        onclick="resetAndRemoveRows()"
                                        class="btn btn-danger col-sm-4 text-white btn-xs item_payment_btn">
                                        Clear
                                    </button>
                                    <button type="button" style="text-align:center; width: 8rem;"
                                        onClick="navigateTo('/manual_delivery_chalan_service/')"
                                        class="btn btn-primary col-sm-4 text-white btn-xs item_payment_btn">
                                        New Delivery
                                    </button>
                                    <button type="submit" id="delivey_submission" style="text-align:center; width: 8rem;" id="check_out"
                                        class="btn btn-success col-sm-4 text-white btn-xs item_payment_btn">
                                        Save & Print
                                    </button>
                                </div>
                            </section>
                        </form>
                    </section>
                </section>
                <!--  -->
            </section>
        </section>
    </section>
</main>
<!--  -->
<script>
    $(document).on('click', '.deleteBtn', function() {
        var chanaldtl_id = $(this).data('chanaldtl_id');
        var buttonElement = $(this);
        //var itemQty = $(this).find('[name="item_price[]"]').val()
    
        $.ajax({
            type: 'DELETE',
            url: `/delete_manual_chalan_dtls/${chanaldtl_id}/`,
            headers: {
                "X-CSRFToken": '{{ csrf_token }}'
            },
            //data: {
            //    'inv_id': invoiceId
            //},
            success: function(resp) {
                if (resp.success) {
                    toastr.error(resp.msg);
                    buttonElement.closest('tr').remove();
                } else {
                    toastr.error(resp.errmsg);
                }
            },
            error: function(xhr, errmsg, err) {
                toastr.error('Error occurred while deleting: ' + err);
            }
        });
    });

    $(document).ready(function () {
        // Get the value of the hidden input field
        let chalanId = $("input[name='id_chalan_id']").val();
        let orgID = $("#id_org").val();
    
        // AJAX request to fetch data
        $.ajax({
            url: '/get_manual_delivery_info/', // URL for the Django view
            type: 'GET',
            data: { id_chalan_id: chalanId, org_id: orgID },
            success: function (response) {
                if (response.success) {
                    // Populate the input fields with the received data
                    $('#cash_point').val(response.data.cash_point || "");
                    $('#id_org').val(response.data.org_id || "");
                    $('#id_branchs').val(response.data.branch_id || "");
                    $('#id_reg_id').val(response.data.reg_id || "");
                    $('#customer_name').val(response.data.customer_name || "General Customer");
                    $('#mobile_number').val(response.data.mobile_number || "");
                    $('#gender').val(response.data.gender || "");
                    $('#id_house_no').val(response.data.house_no || "");
                    $('#id_area').val(response.data.area || "");
                    $('#id_order_no').val(response.data.order_no || "");
                    $('#id_side_off_factory').val(response.data.side_office_factory || "");
                    $('#emergency_person').val(response.data.emergency_person || "");
                    $('#id_road_no').val(response.data.road_no || "");
                    $('#id_floor_no').val(response.data.floor_no || "");
                    $('#id_emergency_phone').val(response.data.emergency_phone || "");
                    $('#id_sector_no').val(response.data.sector_no || "");
                    $('#id_address').val(response.data.address || "");
                    $('#id_driver_id').val(response.data.driver_id || "");
                    $('#id_driver_name').val(response.data.driver_name || "");
                    $('#id_driver_mobile').val(response.data.driver_mobile || "");


                    const tableBody = $('#POS-field table tbody');
                    tableBody.empty(); // Clear the table body before populating new rows

                    const items = response.data.itemdtl_data; // Delivery item details
                    const stores = response.data.stores_qty; // Store data with stock quantities

                    if (items && items.length > 0) {
                        items.forEach((item) => {
                            const itemStores = stores.filter(store => store.item_id === item.item_id);

                            // Generate store dropdown options
                            let storeDropdown = '';
                            if (itemStores.length > 0) {
                                itemStores.forEach(store => {
                                    storeDropdown += `
                                        <option value="${store.store_id}" ${store.store_id === item.deliver_store_id ? 'selected' : ''}>
                                            ${store.store_name} &nbsp;&nbsp;&nbsp; Stock Qty: ${store.stock_qty}
                                        </option>
                                    `;
                                });
                            } else {
                                storeDropdown = '<option value="">No stores available</option>';
                            }

                            // Append a new row for each item
                            const lowStockColor = item.delivery_qty < 1 ? '#FF5722' : '';
                            const lowStockBold = item.delivery_qty < 1 ? 'bold' : '';

                            const rowHTML = `
                                <tr style="border-style: hidden; color: ${lowStockColor}; font-weight: ${lowStockBold};" data-item-name="${item.item_name}">
                                    <td style="text-align:center;">
                                        <button type="button" class="btn btn-xs addFavBtn favListSubmit">
                                            <i class="bx bxs-chevrons-left addFavIcon" title="Add to Favorite List"></i>
                                        </button>
                                    </td>
                                    <td style="text-align:center;">&nbsp;</td>
                                    <td style="text-align:center;">${item.item_no || ""}
                                        <input type="hidden" value="${item.item_no || ""}" class="inputbox_tdrow" name="item_no[]" readonly>
                                        <input type="hidden" value="${item.item_id || ""}" class="inputbox_tdrow multiple_input" name="item_id[]" readonly>
                                    </td>
                                    <td style="position: relative; text-align: left;" class="posItemsName_id">
                                        ${item.item_name || ""}
                                        <input type="hidden" value="${item.item_name || ""}" class="form-control pos_salesDisInput" readonly>
                                    </td>
                                    <td style="position: relative; text-align: left;" class="posItemsName_id">
                                        <select id="id_store_id" name="store_id[]" class="form-control item_inputbox" style="z-index: 0;">
                                            ${storeDropdown}
                                        </select>
                                    </td>
                                    <td style="text-align:center;" id="mulInputQty">
                                        <input type="number" value="${item.delivery_qty || 0}" class="form-control text-center qty1 pos_salesDisInput" id="delivery_qty" name="delivery_qty[]" oninput="validity.valid || (value='');" step="0.01" autocomplete="off" style="width: 100%; background: #fffab6;" required>
                                    </td>
                                    <td style="text-align:center;">
                                        <button type="button" class="btn btn-danger text-white btn-xs deleteBtn" style="position: relative; margin-top: 0.6px; margin-bottom: 2px; padding: 0.03rem 0.35rem; font-weight: bold; margin-left: 0.15rem; margin-right: 0.2rem; z-index: 0; font-size: 0.8rem;" data-chanaldtl_id="${item.chanaldtl_id}">X</button>
                                    </td>
                                </tr>
                            `;

                            tableBody.append(rowHTML);
                        });

                        // Call any additional functions if needed
                        calc();
                        updateSerialNumbers();
                    } else {
                        toastr.warning('No items found for this Chalan.');
                    }

                } else {
                    toastr.warning(response.error || "Failed to fetch data.");
                }

                function updateSerialNumbers() {
                    $('#POS-field table tbody tr').each(function (index) {
                        $(this).find('td:nth-child(2)').text(index + 1); // Update the serial number column
                    });
                }
            },
            error: function () {
                toastr.warning("An error occurred while fetching data.");
            }
        });
    });

    //=====================================================================

    function fetchAndDisplayClientsTrns(regisID, orgID) {
        if (regisID && orgID) {
            $.ajax({
                url: "{% url 'get_clients_trans_summary_report' %}",
                type: 'GET',
                data: {
                    reg_id: regisID,
                    org_id: orgID
                },
                dataType: 'json',
                success: function (response) {
                    var total_OP_DebitAmt = 0;
                    var total_OP_CreditAmt = 0;
                    var total_trns_DebitAmt = 0;
                    var total_trns_CreditAmt = 0;
                    var balance = 0;
    
                    if (Array.isArray(response.combined_data)) {
                        response.combined_data.forEach(function (transaction) {
                            total_OP_DebitAmt += parseFloat(transaction.op_debit_amt || 0);
                            total_OP_CreditAmt += parseFloat(transaction.op_credit_amt || 0);
                            total_trns_DebitAmt += parseFloat(transaction.trns_debit_amt || 0);
                            total_trns_CreditAmt += parseFloat(transaction.trns_credit_amt || 0);
                        });
    
                        balance = (total_OP_DebitAmt + total_trns_DebitAmt) - (total_OP_CreditAmt + total_trns_CreditAmt);
                        $('#id_reg_balances').val(balance.toFixed(2));  // Corrected to use .val() for input field
                        $('#reg_balances').text(balance.toFixed(2));
                    } else {
                        $('#id_reg_balances').val('0.00');
                        $('#reg_balances').text('0.00');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching transactions:', status, error);
                }
            });
        } else {
            console.warn('Required IDs are missing.');
        }
    }
    //
    $(document).ready(function () {
        $(document).on('click', '#addItemPosBtn', function () {
            lineloaderstart();
            modal_lg("Add New Items Setup Pos", "{% url 'add_items_in_pos_billing' %}");
            lineloaderstop();
        });
    });

    // driver searching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearDriversInput() {
            $('#id_carriers').val('').focus();
        }

        $('#id_carriers').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_get_drivers_list_pos/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (drivers) {
                            return { name: drivers.driver_name.toString(), id: drivers.driver_id }; // Return an object with name and id
                        }));
                    }
                });
            },
            updater: function (drivers) {
                var selectedDriverId = drivers.id;

                $.ajax({
                    url: '/select_drivers_details_pos/',
                    data: { selectedDriver: selectedDriverId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedDriverDtl = response.data;

                        // Assign selected data to the corresponding text input fields
                        $('#id_driver_id').val(selectedDriverDtl[0].driver_id);
                        $('#id_driver_name').val(selectedDriverDtl[0].driver_name);
                        $('#id_driver_mobile').val(selectedDriverDtl[0].phone);

                        clearDriversInput();
                    }
                });

                // Return the selected item name to fill the input field
                return drivers.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
        });
    });
    //
    //
    document.getElementById('searchfavlist').addEventListener('input', function () {
        const searchQuery = this.value.toLowerCase();
        loadFavoriteItems(searchQuery);
    });

    function loadFavoriteItems(searchQuery = '') {
        fetch(`/get_fav_item_list/?search=${encodeURIComponent(searchQuery)}`)
            .then(response => response.json())
            .then(data => {
                const favItemTB = document.getElementById('favItemTB');
                favItemTB.innerHTML = ''; // Clear existing rows

                data.fav_items.forEach(item => {
                    const row = document.createElement('tr');

                    const deleteCell = document.createElement('td');
                    deleteCell.style.width = '10%';
                    deleteCell.style.textAlign = 'center';
                    deleteCell.style.borderStyle = 'none';
                    deleteCell.innerHTML = `<button type='button' id='${item.fav_id}' class='btn btn-xs delFavListBtn'><i class='bx bx-trash delBtn'></i></button>`;

                    const nameCell = document.createElement('td');
                    nameCell.style.width = '80%';
                    nameCell.style.textAlign = 'left';
                    nameCell.style.borderStyle = 'none';
                    nameCell.textContent = item.item_name;

                    const checkboxCell = document.createElement('td');
                    checkboxCell.style.width = '10%';
                    checkboxCell.style.textAlign = 'center';
                    checkboxCell.style.borderStyle = 'none';
                    checkboxCell.innerHTML = `<input type='checkbox' id='${item.item_id}' class='form-check-input' style='width: 1.2rem; height: 1.2rem; cursor: pointer; border-color: royalblue;'>`;

                    row.appendChild(deleteCell);
                    row.appendChild(nameCell);
                    row.appendChild(checkboxCell);

                    favItemTB.appendChild(row);

                    // Add event listener to delete button
                    deleteCell.querySelector('button').addEventListener('click', function () {
                        deleteFavoriteItem(item.fav_id, row);
                    });

                    // Add event listener to checkbox
                    checkboxCell.querySelector('input').addEventListener('change', function () {
                        if (this.checked) {
                            addItemToTable(item.item_id); // Use item.item_id here
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching favorite items:', error);
            });
    }

    function addItemToTable(itemId) {
        $.ajax({
            url: '/select_item_without_stock_list/',
            type: 'GET',
            dataType: 'json',
            data: {
                selectedItem: itemId,
                store_id: $('#cash_point').val(), // Assuming you're using a field with this ID for the store ID
                b2b_client_supp_id: $('#id_supplier_id').val(),
                org_id: $('#id_org').val(),
            },
            success: function (response) {
                if (response.data && response.data.length > 0) {
                    const item = response.data[0]; // Get the first item in the response data array
            
                    const positem_name = item.item_name; // Extract the item name
                    const extended_stock = parseFloat(item.extended_stock) || 0;
                    const stock_qty = parseFloat(item.stock_qty) || 0;
                    const reOrderQtyFloat = parseFloat(item.re_order_qty) || 0;
            
                    var itemPrice = (item.item_price !== '' && item.item_price != null) ? item.item_price : 0;
            
                    var lowStockColor = stock_qty < reOrderQtyFloat ? '#FF5722' : '';
                    var lowStockbold = stock_qty < reOrderQtyFloat ? 'bold' : '';
            
                    // Check if the item has already been added
                    //if ($('#POS-field table tbody tr[data-item-name="' + positem_name + '"]').length > 0) {
                    //    toastr.warning('Item Already in the List.');
                    //    return false;
                    //}
            
                    // Add the item to the table (existing logic)
                    const tableBody = document.querySelector('#POS-field table tbody');
            
                    // Create a new row for the selected item
                    const tr = document.createElement('tr');
                    tr.style.borderStyle = 'hidden';
                    tr.style.color = `${lowStockColor}`;
                    tr.style.fontWeight = `${lowStockbold}`;
                    tr.setAttribute('data-item-name', item.item_name); // Store the item name in a data attribute
            
                    // Fetch stores for the dropdown dynamically
                    $.ajax({
                        url: '/get_all_store_for_manual_delivery_chalan/',
                        data: {
                            org_id: $('#id_org').val(),
                            item_id: item.item_id, // Use the item_id from the current response
                        },
                        dataType: "json",
                        type: "GET",
                        success: function (response) {
                            if (response.store_data && response.store_data.length > 0) {
                                var stores = response.store_data;
                    
                                // Generate store dropdown options
                                var storeDropdown = "";
                                var maxStockQty = -1;
                                var maxStockStoreId = null;
                                var isAnySelected = false;
                    
                                stores.forEach(function (store) {
                                    if (store.selected) {
                                        isAnySelected = true;
                                    }
                    
                                    if (store.stock_qty > maxStockQty) {
                                        maxStockQty = store.stock_qty;
                                        maxStockStoreId = store.store_id;
                                    }
                    
                                    var selected = store.selected ? 'selected' : '';
                                    storeDropdown += `<option value="${store.store_id}" ${selected}>${store.store_name} &nbsp;&nbsp;&nbsp; Stock Qty: ${store.stock_qty}</option>`;
                                });
                    
                                // Create row content
                                var tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td style="text-align:center;">
                                        <button type='button' class='btn btn-xs addFavBtn favListSubmit'>
                                            <i class='bx bxs-chevrons-left addFavIcon' title='Add to Favorite List'></i>
                                        </button>
                                    </td>
                                    <td style="text-align:center;">&nbsp;</td>
                                    <td style="text-align:center;">${item.item_no}
                                        <input type="hidden" value="${item.item_no}" class="inputbox_tdrow" name="item_no[]" readonly>
                                        <input type="hidden" value="${item.item_id}" class="inputbox_tdrow multiple_input" name="item_id[]" readonly>
                                    </td>
                                    <td style="position: relative; text-align: left;" class="posItemsName_id">
                                        ${item.item_name}
                                        <input type="hidden" value="${item.item_name}" class="form-control pos_salesDisInput" readonly>
                                    </td>
                                    <td style="position: relative; text-align: left;" class="posItemsName_id">
                                        <select id="id_store_id" name="store_id[]" class="form-control item_inputbox" style="z-index: 0;">
                                            ${storeDropdown}
                                        </select>
                                    </td>
                                    <td style="text-align:center;" id="mulInputQty">
                                        <input type="number" value="0" class="form-control text-center qty1 pos_salesDisInput" id="delivery_qty" name="delivery_qty[]" oninput="validity.valid || (value='');" step="0.01" autocomplete="off" style="width: 100%; background: #fffab6;" required>
                                    </td>
                                    <td style="text-align:center;">
                                        <button type="button" class="btn btn-danger text-white btn-xs itemAdd_del_btn">X</button>
                                    </td>
                                `;
                    
                                // Append the new row to the table
                                tableBody.appendChild(tr);
                    
                                // Fallback: If no store was marked selected from the server, select the one with the highest stock
                                if (!isAnySelected && maxStockStoreId !== null) {
                                    $(tr).find(`select[name="store_id[]"] option[value="${maxStockStoreId}"]`).prop('selected', true);
                                }
                    
                                // After appending the row, call the calc function
                                calc();
                    
                                // Update serial numbers for all rows
                                updateSerialNumbers();
                            } else {
                                toastr.warning('No stores found for this item.');
                            }
                        },
                        error: function (error) {
                            toastr.error('Error fetching store data.');
                            console.error('Error:', error);
                        }
                    });
                } else {
                    toastr.warning('Item Not Found In The Stock List. Please Stock This Item First & Try Again.');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching item details:', error);
            }
        });

        // Function to update the serial numbers
        function updateSerialNumbers() {
            $('#POS-field table tbody tr').each(function (index) {
                $(this).find('td:nth-child(2)').text(index + 1); // Update the serial number column
            });
        }
    }

    $(document).ready(function () {
        loadFavoriteItems();
    
        // Event delegation for dynamically created inputs within the table body
        $('#POS-field table tbody')
            .on('input change blur', '.item_w_dis_input', function () {
                let value = $(this).val();
                if (value.trim().length === 0) {
                    $(this).val('0'); // Set default value if empty
                }
                calc(); // Recalculate totals
            })
            .on('focus', '.item_w_dis_input', function () {
                let value = $(this).val();
                if (value.trim() === '0') {
                    $(this).val(''); // Clear input if value is '0'
                }
            })
            .on('input keypress keyup keydown', '[name="delivery_qty[]"], [name="item_price[]"], [name="item_w_dis[]"]', calc)
            .on('blur', 'input[name="delivery_qty[]"]', function () {
                let value = $(this).val();
                if (value === "") {
                    $(this).val(); // Set default qty if left empty
                }
                calc(); // Recalculate totals
            })
            //
            .on('input change blur', '.qty1', function () {
                let value = $(this).val();
                if (value.trim().length === 0) {
                    $(this).val(''); // Set default value if empty
                }
                calc(); // Recalculate totals
            })
            .on('focus', '.qty1', function () {
                let value = $(this).val();
                if (value.trim() === '0') {
                    $(this).val(''); // Clear input if value is '0'
                }
            })
            //
            .on('click', '.itemAdd_del_btn', function () {
                $(this).closest('tr').remove(); // Remove the row
                calc(); // Recalculate totals
            });
    });

    //
    function deleteFavoriteItem(fav_id, row) {
        fetch(`/delete_fav_item/${fav_id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // Get the CSRF token
            },
        })
            .then(response => {
                if (response.ok) {
                    // Remove the row from the table
                    row.remove();
                } else {
                    console.error('Failed to delete favorite item:', response.statusText);
                }
            })
            .catch(error => {
                console.error('Error deleting favorite item:', error);
            });
    }

    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadFavoriteItems(); // Load favorite items on page load
    });

    //
    function fetchAndDisplayCreditTransactions(supplierId, branchId) {
        if (supplierId || branchId) {
            $.ajax({
                url: "{% url 'get_credit_transactions' %}",
                type: 'GET',
                data: {
                    'supplier_id': supplierId,
                    'branch_id': branchId,
                },
                dataType: 'json',
                success: function (response) {

                    var totalDebitAmt = 0;
                    var totalCreditAmt = 0;

                    // Populate the table body with the new data
                    response.forEach(function (transaction, index) {

                        // Add debit payment to totalDebitAmt
                        if (!isNaN(transaction.debit_payment)) {
                            totalDebitAmt += parseFloat(transaction.debit_payment);
                        }

                        // Add credit payment to totalCreditAmt
                        if (!isNaN(transaction.credit_payment)) {
                            totalCreditAmt += parseFloat(transaction.credit_payment);
                        }
                    });

                    // Calculate the balance
                    var balance = totalDebitAmt - totalCreditAmt;

                    $('#id_credit_balance').text(balance.toFixed(0));
                    $('#credit_balance').val(balance.toFixed(0));
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching credit transactions:', status, error);
                }
            });
        }
    }

    //register customer searching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearRegCustomerInput() {
            $('#register_customer').val('').focus();
        }
    
        $('#register_customer').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_registration_for_billing/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (register) {
                            return { 
                                name: register.full_name.toString(),
                                customerNo: register.customer_no.toString(),
                                mobileNumber: register.mobile_number.toString(),
                                id: register.reg_id,
                            };
                        }));
                    }
                });
            },
            updater: function (register) {
                var selectedRegisterId = register.id;
                var orgID = $('#id_org').val();
    
                $.ajax({
                    url: '/select_registrations_details/',
                    data: { selectedRegister: selectedRegisterId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedRegisterDtl = response.data;
    
                        // Assign selected data to the corresponding text input fields
                        $('#id_reg_id').val(selectedRegisterDtl.reg_id);
                        $('#customer_name').val(selectedRegisterDtl.full_name);
                        $('#mobile_number').val(selectedRegisterDtl.mobile_number);
                        $('#gender').val(selectedRegisterDtl.gender);
                        $('#id_address').val(selectedRegisterDtl.address);
                        $('#emergency_person').val(selectedRegisterDtl.emergency_person);
                        $('#id_emergency_phone').val(selectedRegisterDtl.emergency_mobile);
    
                        clearRegCustomerInput();

                        if (selectedRegisterId && orgID) {
                            fetchAndDisplayClientsTrns(selectedRegisterId, orgID);
                        }
                    }
                });
    
                // Return the selected item name to fill the input field
                return register.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
            matcher: function (item) {
                // Custom matcher to filter based on name, customerNo, or mobileNumber
                var query = this.query.toLowerCase();
                return item.name.toLowerCase().includes(query) ||
                       item.customerNo.toLowerCase().includes(query) ||
                       item.mobileNumber.toLowerCase().includes(query);
            }
        });
    });

    // client seraching
    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearB2bClientInput() {
            $('#clients_name').val('').focus();
        }

        $('#clients_name').typeahead({
            source: function (query, result) {
                var selected_id_org = $('#id_org').val();
                $.ajax({
                    url: '/search_b2b_clients_for_billing/',
                    data: {
                        query: query,
                        org_filter: selected_id_org,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        result($.map(data.data, function (b2bClient) {
                            return { name: b2bClient.supplier_name.toString(), id: b2bClient.supplier_id }; // Return an object with name and id
                        }));
                    }
                });
            },
            updater: function (b2bClient) {
                var selectedb2bClientId = b2bClient.id;

                $.ajax({
                    url: '/select_b2b_clients_details/',
                    data: { selectedb2bClient: selectedb2bClientId }, // Send the selected item ID to retrieve details
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedb2bClientDtl = response.data;

                        // Assign selected data to the corresponding text input fields
                        $('#id_supplier_id').val(selectedb2bClientDtl[0].supplier_id);
                        $('#id_client_no').val(selectedb2bClientDtl[0].supplier_no);
                        $('#id_client_name').val(selectedb2bClientDtl[0].supplier_name);
                        $('#customer_name').val(selectedb2bClientDtl[0].supplier_name);
                        $('#id_contact').val(selectedb2bClientDtl[0].phone);
                        $('#mobile_number').val(selectedb2bClientDtl[0].phone);
                        $('#id_client_address').val(selectedb2bClientDtl[0].address);
                        $('#id_address').val(selectedb2bClientDtl[0].address);

                        clearB2bClientInput();

                        var supplierId = selectedb2bClientId;
                        var branchId = $('#id_branchs').val();
                        if (supplierId || branchId) {
                            fetchAndDisplayCreditTransactions(supplierId, branchId);
                        }
                    }
                });

                // Return the selected item name to fill the input field
                return b2bClient.name;
            },
            items: 50, // Specify the number of items to display
            displayText: function (item) {
                return item.name; // Adjust this if you want to customize the display text
            },
        });
    });
    //======================================================================
    //
    $(document).ready(function () {

        $('#id_org').change(function () {
            OrgWiseUpdateFilterOptions();
        });

        OrgWiseUpdateFilterOptions();

        function OrgWiseUpdateFilterOptions() {
            var selectedOrgId = $('#id_org').val();

            // Branch option value
            $.ajax({
                url: '/get_branch_options/',
                method: 'GET',
                data: { org_id: selectedOrgId },
                success: function (data) {
                    $('#id_branchs').empty();
                    $.each(data.branch_list, function (index, branch) {
                        $('#id_branchs').append('<option value="' + branch.branch_id + '">' + branch.branch_name + '</option>');
                    });
                    $('#id_branchs').trigger('change');
                },
                error: function (error) {
                    console.error('Error fetching branch options:', error);
                }
            });

            // supplier options update Function
            $.ajax({
                url: '/get_list_of_supplier/',
                method: 'GET',
                data: { org_id: selectedOrgId },
                success: function (data) {
                    //<!--  -->
                    $('#id_filter_suppliers').empty();
                    $('#id_filter_suppliers').append('<option value="1" selected>All Supplier</option>');
                    $.each(data.supp_list, function (index, supp) {
                        $('#id_filter_suppliers').append('<option value="' + supp.supplier_id + '" id="' + supp.supplier_id + '">' + supp.supplier_name + '</option>');
                    });
                    $('#id_filter_suppliers').trigger('change');
                },
                error: function (error) {
                    console.error('Error fetching suppliers:', error);
                }
            });
        }

        //
        $.ajax({
            url: "{% url 'get_user_stores' %}",
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.stores) {
                    var select = $('#cash_point');
                    select.empty();
                    $.each(response.stores, function (index, store) {
                        select.append($('<option>', {
                            value: store.store_id,
                            id: store.store_id,
                            text: store.store_name
                        }));
                    });

                    // After populating user stores, trigger the change event for cash_point
                    $('#cash_point').trigger('change');
                } else {
                    console.error('Error fetching user stores');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    });

    // Function to run when the document is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        // radio button 
        // client
        var generalRadioButton = document.getElementById('id_general_bill');
        var clientRadioButton = document.getElementById('id_b2b_clients');

        // registration
        var registerRadioButton = document.getElementById('id_register');
        var nonRegRadioButton = document.getElementById('id_non_register');
        // ==============================================

        // client search body
        var clientSearchBody = document.getElementById('client_searchBody');
        var clientSalesTypeBody = document.getElementById('id_sales_type');

        // client Search Input
        var clientSearchInput = document.getElementById('client_searchInput');
        var b2bClientsInfo = document.getElementById('b2b_clients_info');
        // ==============================================

        var regSearchBody = document.getElementById('reg_searchBody');
        var regSearchInput = document.getElementById('reg_searchInput');
        // ==============================================


        //Clients body display block
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'block';
                clientSearchInput.style.display = 'block';
                b2bClientsInfo.style.display = 'block';
                clientSalesTypeBody.style.display = 'flex';
            }
        });

        //Clients body display none
        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'none';
                clientSearchInput.style.display = 'none';
                b2bClientsInfo.style.display = 'none';
                clientSalesTypeBody.style.display = 'none';
            }
        });


        //register body display block
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'block';
                regSearchInput.style.display = 'block';
            }
        });


        //register body display none
        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'none';
                regSearchInput.style.display = 'none';
            }
        });
        
        //============================ button click wise value change ============================
        //client genaral butthon
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                generalRadioButton.value = "0";
                clientRadioButton.value = "1";
            }
        });

        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                clientRadioButton.value = "0";
                generalRadioButton.value = "1";
            }
        });

        //register non register butthon
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                nonRegRadioButton.value = "0";
                registerRadioButton.value = "1";
            }
        });

        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                registerRadioButton.value = "0";
                nonRegRadioButton.value = "1";
            }
        });

        //saller buyer butthon
    });

    // Item form reset
    function resetInputFields() {
        $('#id_supplier_id').val('');
        $('#id_client_no').val('');
        $('#id_client_name').val('');
        $('#customer_name').val('');
        $('#id_contact').val('');
        $('#mobile_number').val('');
        $('#id_client_address').val('');
        $('#id_address').val('');
        $('#credit_balance').val('');
        $('#id_credit_balance').text('0.00');
    }
    //<!--  -->

    $(document).ready(function () {
        // Define a function to clear and focus the input field
        function clearAndFocusInput() {
            $('#positem_name').val('').focus();
            $('#positem_name').trigger('input');
        }

        // favorite function start
        // Function to get CSRF token from the cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Get the CSRF token
        const csrfToken = getCookie('csrftoken');

        // Add event listener for the favorite icon click
        $('#POS-field').on('click', '.favListSubmit', function (e) {
            e.preventDefault();
            var row = $(this).closest('tr');
            var item_id = row.find('input[name="item_id[]"]').val();

            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: '/save_favorite_item/',  // URL for saving favorite item
                type: 'POST',
                data: {
                    'item_id': item_id,
                    'csrfmiddlewaretoken': csrfToken,
                },
                success: function (response) {
                    if (response.status === 'success') {
                        loadFavoriteItems();
                        toastr.success(response.message);
                    } else if (response.status === 'exists') {
                        toastr.warning(response.message);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Failed to add item to favorites.');
                }
            });
        });
        // Add event listener for the favorite icon click end
        // favorite function start end

        // Speech recognition feature
        $('.speech').on('click', function () {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Your browser does not support Speech Recognition');
                return;
            }
    
            var recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.start();
    
            recognition.onresult = function (event) {
                var voiceInput = event.results[0][0].transcript;
                var $inputField = $('#positem_name');
                $inputField.val(voiceInput).focus();
    
                // Trigger the typeahead manually
                $inputField.typeahead('lookup', voiceInput);
            };
        });

        $('#positem_name').typeahead({
            source: function (query, result) {
                var selected_store_id = $('#cash_point').val();
                var selected_supplier_id = $('#id_filter_suppliers').val();
                var b2bClientSuppId = $('#id_supplier_id').val();
                var selectedOrgId = $('#id_org').val();

                $.ajax({
                    url: '/get_item_list/',
                    data: {
                        query: query,
                        store_id: selected_store_id,
                        filter_suppliers: selected_supplier_id,
                        b2b_client_supp_id: b2bClientSuppId,
                        org_id: selectedOrgId,
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        var items = data.data.map(function (item) {
                            return {
                                name: item.item_name.toString(),
                                type: item.item_type_name.toString(),
                                uom: item.item_uom.toString(),
                                Supplier: item.item_Supplier.toString(),
                                qty: item.stock_qty.toString(),
                                price: item.item_price || 'N/A',
                                itemNo: item.item_no.toString(),
                                id: item.item_id,
                            };
                        });

                        result(items);

                        // Adjust widths after results are rendered
                        adjustWidthsBasedOnFavListState(); 
                        //results are rendered
                    }
                });
            },
            items: 150,
            displayText: function (item) {
                const itemId = item.id ? item.id : '';
                const name = item.name ? item.name : '';
                const type = item.type ? item.type : '';
                const uom = item.uom ? item.uom : '';
                const Supplier = item.Supplier ? item.Supplier : '';
                const qty = item.qty ? item.qty : '';
                const price = item.price ? item.price : '';
                const itemNo = item.itemNo ? item.itemNo : '';

                return `
                    <span style="display: none;">${itemId}</span>
                    <span style="display: none;">${itemNo}</span>
                    <strong class="itemName">
                        <i class="bx bxs-baguette itemNameIcon"></i>
                        <span class="itemNameBody">${name}</span>
                    </strong>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${type}</span>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${uom}</span>
                    <i class="bx bxs-objects-horizontal-center itemOtherIcon"></i>
                    <span class="itemOtherName">${Supplier}</span>
                `;
            },
            highlighter: function (item) {
                return `<div style="display: flex;">${item}</div>`;
            },
            updater: function (item) {
                var selecteditemId = item.id;
            
                // Fetch selected item details
                $.ajax({
                    url: '/select_item_without_stock_list/',
                    data: {
                        selectedItem: selecteditemId,
                        store_id: $('#cash_point').val(),
                        b2b_client_supp_id: $('#id_supplier_id').val(),
                        org_id: $('#id_org').val(),
                    },
                    dataType: "json",
                    type: "GET",
                    success: function (response) {
                        var selectedItemDetails = response.data;
            
                        // Ensure we have valid data
                        if (!selectedItemDetails || selectedItemDetails.length === 0) {
                            toastr.error('No item details found.');
                            return;
                        }
            
                        var {
                            org_id, store_id, item_id, item_name: positem_name, item_no, item_type_name: item_type,
                            item_uom, item_Supplier, extended_stock, re_order_qty,
                            stock_qty, item_price
                        } = selectedItemDetails[0];
            
                        var favIcon = `<button type='button' class='btn btn-xs addFavBtn favListSubmit'>
                                        <i class='bx bxs-chevrons-left addFavIcon' title='Add to Favorite List'></i></button>`;
            
                        // Check if the item is already in the list
                        //if ($('#POS-field table tbody tr[data-item-name="' + positem_name + '"]').length > 0) {
                        //    toastr.warning('Item Already in the List.');
                        //    clearAndFocusInput();
                        //    return false;
                        //}
            
                        // Ensure all required values are defined
                        if ([store_id, item_id, item_no, positem_name, item_type, item_uom, item_Supplier,
                            extended_stock, re_order_qty, stock_qty, item_price].some(value => value === undefined)) {
                            toastr.error('Incomplete item details.');
                            return false;
                        }
            
                        var itemPrice = item_price || 0;
            
                        // Determine stock level styling
                        var lowStock = parseFloat(stock_qty) < parseFloat(re_order_qty);
                        var stockStyle = lowStock ? 'color: #FF5722; font-weight: bold;' : '';
            
                        // Fetch stores for the dropdown dynamically
                        $.ajax({
                            url: '/get_all_store_for_manual_delivery_chalan/',
                            data: {
                                org_id: $('#id_org').val(),
                                item_id: selecteditemId,
                            },
                            dataType: "json",
                            type: "GET",
                            success: function (response) {
                                var stores = response.store_data;
                        
                                // Build store dropdown and track selection
                                var storeDropdown = "";
                                let maxStockStore = null;
                                let maxStockQty = -1;
                                let selectedStoreId = null;
                        
                                stores.forEach(function (store) {
                                    if (store.selected) {
                                        selectedStoreId = store.store_id;
                                    }
                                    if (store.stock_qty > maxStockQty) {
                                        maxStockQty = store.stock_qty;
                                        maxStockStore = store;
                                    }
                        
                                    let selectedAttr = store.selected ? 'selected' : '';
                                    storeDropdown += `<option value="${store.store_id}" ${selectedAttr}>${store.store_name} &nbsp;&nbsp;&nbsp; Stock Qty: ${store.stock_qty}</option>`;
                                });
                        
                                // Create a new row for the selected item
                                var tr = $(`<tr style="border-style: hidden!important; ${stockStyle}"></tr>`);
                                tr.attr('data-item-name', positem_name);
                        
                                // Add content to the row
                                tr.append('<td style="text-align:center;">' + favIcon + '</td>');
                                tr.append('<td style="text-align:center;">&nbsp;</td>');
                                tr.append('<td style="text-align:center;">' + item_no +
                                    `<input type="hidden" value="${item_no}" class="inputbox_tdrow" name="item_no[]" readonly>
                                     <input type="hidden" value="${item_id}" class="inputbox_tdrow multiple_input" name="item_id[]" readonly></td>`);
                                tr.append(`<td style="position: relative; text-align: left; ${stockStyle}" class="posItemsName_id">
                                                ${positem_name}
                                                <input type="hidden" value="${positem_name}" class="form-control pos_salesDisInput" readonly>
                                           </td>`);
                                tr.append(`<td style="position: relative; text-align: left;" class="posItemsName_id">
                                                <select id="id_store_id" name="store_id[]" class="form-control item_inputbox" style="z-index: 0;">
                                                    ${storeDropdown}
                                                </select>
                                           </td>`);
                                tr.append(`<td style="text-align:center;" id="mulInputQty">
                                                <input type="number" value="0" class="form-control text-center qty1 pos_salesDisInput" id="delivery_qty" name="delivery_qty[]" 
                                                    oninput="validity.valid || (value='');" step="0.01" autocomplete="off" style="width: 100%; background: #fffab6;" required>
                                           </td>`);
                                tr.append('<td style="text-align:center;"><button type="button" class="btn btn-danger text-white btn-xs itemAdd_del_btn">X</button></td>');
                        
                                // Append row to table
                                $('#POS-field table tbody').append(tr);
                        
                                // Fallback: if none are selected, select the one with highest stock
                                if (!selectedStoreId && maxStockStore) {
                                    tr.find('select[name="store_id[]"]').val(maxStockStore.store_id);
                                }
                        
                                // Bind remove row action
                                tr.find('.itemAdd_del_btn').on('click', function () {
                                    $(this).closest('tr').remove();
                                    calc();
                                });
                        
                                // Recalculate and update serials
                                clearAndFocusInput();
                                updateSerialNumbers();
                            },
                            error: function (error) {
                                toastr.error('Error fetching store data.');
                                console.error('Error:', error);
                            }
                        });
                    },
                    error: function (error) {
                        toastr.error('Error fetching item details.');
                        console.error('Error:', error);
                    }
                });
            }
        });

        //<!-- ====================================================================== -->
        const inputFieldPOSitem = document.getElementById('positem_name');

        // Set focus to the input field
        inputFieldPOSitem.focus();

        // Function to update the serial numbers
        function updateSerialNumbers() {
            $('#POS-field table tbody tr').each(function (index) {
                $(this).find('td:nth-child(2)').text(index + 1); // Update the serial number column
            });
        }

        //=========== Show/Hide the Favorite List when the button is clicked =====================
        // Function to adjust widths based on favorite list state
        function adjustWidthsBasedOnFavListState() {
            var favList = $('#id_myfavList');
            if (favList.css('display') === 'block') {
                updateWidths("23rem", "4rem", "3rem");
            } else {
                updateWidths("32rem", "6rem", "4rem");
            }
        }

        // Function to update widths
        function updateWidths(itemNameWidth, itemOtherNameWidth, itemQtyNameWidth) {
            $('.itemName').css('width', itemNameWidth);
            $('.itemOtherName').css('width', itemOtherNameWidth);
            $('.itemQtyName').css('width', itemQtyNameWidth);
        }

        // Function to set visibility of elements based on stored state
        function setVisibility() {
            var favListDisplay = localStorage.getItem('favListDisplay');
            var favBtnDisplay = localStorage.getItem('favBtnDisplay');

            $('#id_myfavList').css('display', favListDisplay ? favListDisplay : 'none');
            $('#id_myfavBtn').css('display', favBtnDisplay ? favBtnDisplay : 'block');

            // Adjust widths after setting visibility
            adjustWidthsBasedOnFavListState();
        }

        // Initial call to set visibility when the page loads
        setVisibility();

        // Show the Favorite List and hide the button when clicked
        $('#id_myfavBtn').click(function () {
            $('#id_myfavList').css('display', 'block');
            $('#id_myfavBtn').css('display', 'none');

            // Adjust widths
            updateWidths("23rem", "4rem", "3rem");

            // Store the state in localStorage
            localStorage.setItem('favListDisplay', 'block');
            localStorage.setItem('favBtnDisplay', 'none');
        });

        // Hide the Favorite List when the close button is clicked and show the button again
        $('.btn-close').click(function () {
            $('#id_myfavList').css('display', 'none');
            $('#id_myfavBtn').css('display', 'block');

            // Reset widths
            updateWidths("32rem", "6rem", "4rem");

            // Store the state in localStorage
            localStorage.setItem('favListDisplay', 'none');
            localStorage.setItem('favBtnDisplay', 'block');
        });
        //=========== Show/Hide the Favorite List when the button is clicked =====================
    });
    //<!--  -->


    // Helper function to check if a date is within 6 months
    function isWithin6Months(expDate) {
        // Parse the item.item_exp_date to a Date object
        var expDateObj = new Date(expDate);

        // Calculate the date 6 months from now
        var sixMonthsFromNow = new Date();
        sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);

        return expDateObj <= sixMonthsFromNow;
    }

    // calculation
    function calc() {
        var actual_amount = 0;
    
        $('#POS-field table tbody tr').each(function () {
            // Item-wise calculations
            var item_price = parseFloat($(this).find('[name="item_price[]"]').val()) || 0;
            var delivery_qty = parseFloat($(this).find('[name="delivery_qty[]"]').val()) || 0;
            var item_w_dis = parseFloat($(this).find('[name="item_w_dis[]"]').val()) || 0;
    
            var total = item_price * delivery_qty;
            var g_total = total - item_w_dis;
    
            $(this).find('.product_total').text(g_total.toLocaleString('en-US'));
            actual_amount += g_total;
        });
    
        // Update actual amount
        $('#actual_amount').text(actual_amount.toLocaleString('en-US'));
        $('[name="actual_amount"]').val(actual_amount.toFixed(2));
    
        // VAT calculations
        var vat_value = parseFloat($('[name="total_vat"]').val()) || 0;
        var vat_tax_amt = actual_amount * (vat_value / 100);
    
        $('#vat_amount').text(vat_tax_amt.toLocaleString('en-US'));
        $('[name="vat_amount"]').val(vat_tax_amt.toFixed(2));
    
        // Discount calculations
        var disc_amt = parseFloat($('[name="discount_amt"]').val()) || 0;
        $('#total_discount').text(disc_amt.toLocaleString('en-US'));
        $('[name="total_discount"]').val(disc_amt.toFixed(2));
    
        var disc_per_amt = (disc_amt / actual_amount) * 100 || 0;
        $('#discount_perc').text(disc_per_amt.toFixed(2).toLocaleString('en-US'));
        $('[name="discount_perc"]').val(disc_per_amt.toFixed(2));
    
        // Gross discount and VAT per item
        var total_itemQty = parseFloat($('[name="tot_count_serial"]').val()) || 1; // Avoid division by zero
        var gross_dis_amt = disc_amt / total_itemQty;
        $('[name="gross_dis[]"]').val(gross_dis_amt.toFixed(3));
    
        var gross_vat_tax_amt = vat_tax_amt / total_itemQty;
        $('[name="gross_vat_tax[]"]').val(gross_vat_tax_amt.toFixed(3));
    
        // Total amount
        var is_buyer = $('#id_buyer').val() === '1';
        var cost_buyer_amt = parseFloat($('[name="rent_other_expense"]').val()) || 0;
        var amt = actual_amount + vat_tax_amt - disc_amt;
    
        if (is_buyer) {
            amt += cost_buyer_amt;
        }
    
        $('#total_amount').text(amt.toLocaleString('en-US'));
        $('[name="total_amount"]').val(amt.toFixed(2));
    
        // Payment and receivable calculations
        var total_payment = parseFloat($('[name="payment_amt"]').val()) || 0;
        $('#receivable_amt').text(total_payment.toLocaleString('en-US'));
        $('[name="receivable_amt"]').val(total_payment.toFixed(2));
    
        // Given and change amounts
        var given = parseFloat($('[name="given_amt"]').val()) || 0;
        var change_amt = given - total_payment;
        $('#change_amt').text(change_amt.toLocaleString('en-US'));
        $('[name="change_amt"]').val(change_amt.toFixed(2));
    
        // Due amount
        var due_amt = amt - total_payment;
        $('#due_amount').text(due_amt.toLocaleString('en-US'));
        $('[name="due_amount"]').val(due_amt.toFixed(2));
    
        // Total sales quantity
        var total_qty = 0;
        $(".qty1").each(function () {
            total_qty += parseFloat($(this).val()) || 0;
        });
        $(".sum_qty_total").val(total_qty);
    
        // Total item count
        var count_tot_item = $('#mytbody').children('tr').length;
        $('#tot_count_serial').text(count_tot_item.toLocaleString('en-US'));
        $('[name="tot_count_serial"]').val(count_tot_item);
    }

    // auto input tax vat work
    $(function () {
        $('#carryin_cost').find('input[name="rent_other_expense"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#vatCal').find('input[name="total_vat"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#dis_input').find('input[name="discount_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#payment_input').find('input[name="payment_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#given_input').find('input[name="given_amt"]').on('input keypress keyup keydown', function () {
            calc()
        })

        $('#mulInputQty').find('input[name="delivery_qty"]').on('input keypress keyup keydown', function () {
            calc()
        })
    })

    // set defualt value
    $('#discount_amt').on('input change blur', function () {
        var value = $(this).val();
        if (value.trim().length === 0) {
            $(this).val('0');
            calc();
        }
    }).on('focus', function () {
        var value = $(this).val();
        if (value.trim() === '0') {
            $(this).val('');
        }
    });

    $('#payment_amt').on('input change blur', function () {
        var value = $(this).val();
        if (value.trim().length === 0) {
            $(this).val('0');
            calc();
        }
    }).on('focus', function () {
        var value = $(this).val();
        if (value.trim() === '0') {
            $(this).val('');
        }
    });

    // store_name from local storage
    $(document).ready(function () {
        // Get the select element
        var selectElement = document.getElementById('cash_point');

        // Attach an event listener to the select element
        selectElement.addEventListener('change', function (event) {
            // Get the selected store_name
            var selectedStoreName = event.target.options[event.target.selectedIndex].text;

            // Store the selected store_name in local storage
            localStorage.setItem('selectedStoreName', selectedStoreName);
        });

        // To retrieve the store_name from local storage
        var storedStoreName = localStorage.getItem('selectedStoreName');
        if (storedStoreName) {
            // Set the value of the select element if there's a stored value
            // Loop through options to find the matching store_name and set it as selected
            for (var i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].text === storedStoreName) {
                    selectElement.selectedIndex = i;
                    break;
                }
            }
        }
    });

    // add multiple input field add with value
    $(function () {
        //
        $('#check_out').click(function () {
            if ($('#POS-field table tbody tr').length <= 0) {
                toastr.warning("Add atleast 1 product first!..")
                return false;
            }
        })

        // Prevent form submission on Enter key press
        $('#pos-form').on('keydown', function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                return false;
            }
        });

        // ajax submit
        $('#UPDMDELICHALAN').on('submit', function (e) {
            e.preventDefault(); // Prevent default form submission
            var org_id = $('#id_org').val();

            // Check if any delivery_qty[] is 0
            var deliveryQtys = $('input[name="delivery_qty[]"]');
            var isInvalid = false;

            deliveryQtys.each(function() {
                if ($(this).val() == '0') {
                    isInvalid = true;
                    toastr.error('Delivery Qty. 0 (Zero) Not Allowed.');
                    return false; // Exit the loop
                }
            });

            // If there's an invalid value, stop the form submission
            if (isInvalid) {
                return;
            }

            $('#delivey_submission').prop('disabled', true).html('<i class="bx bx-loader-circle"></i> Processing...');
        
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'update_manual_delivery_chalan' %}",  // Your Django URL for updating chalan
                type: "POST",
                data: new FormData(this), // Pass the native DOM element directly
                processData: false, // Prevent jQuery from automatically transforming the FormData object
                contentType: false, // Prevent jQuery from overriding the Content-Type header
                success: function (response) {
                    if (response.status === 'success') {
                        toastr.success('Chalan created successfully!');

                        // Open the modal with the updated chalan data
                        var chalanUrl = "{% url 'manual_delivery_chalan_receipts' %}?id=" + response.chalan_id + "&org_id=" + org_id;
                        modal_lg("Manual Delivery Chalan", chalanUrl);

                        $('#modal_lg').on('hide.bs.modal', function () {
                            navigateTo("{% url 'delivery_chalan_services' %}");
                        });

                    } else {
                        toastr.error(response.errmsg || 'Failed to create chalan.');
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Error occurred while creating the chalan.');
                    console.log('Error:', error);
                },
                complete: function () {
                    setTimeout(function () {
                        $('#delivey_submission').prop('disabled', false).html('Save & Print');
                    }, 3000);
                }
            });
        });
    });

    // payment calc button
    function calcFun() {
        var calc_tot_bill = $('[name="total_amount"]').val()
        $('#payment_amt').text(parseFloat(calc_tot_bill).toLocaleString('en-US'))
        $('[name="payment_amt"]').val(parseFloat(calc_tot_bill))
        calc()
    }

    // Double Click dine func
    // Function to handle the primary operation when the button is clicked
    function handleCheckoutOperation() {
        console.log("Do the operation");
    }

    // Function to prevent multiple clicks within a specific time frame (e.g., 10 seconds)
    function preventDoubleClick(event, element, lastClickElement, lastClickTime) {
        const now = Date.now();
        
        if (element === lastClickElement && (now - lastClickTime) < 10000) {
            // Same element and less than 10 seconds between clicks
            console.log("Second click denied");
            event.preventDefault();
            event.stopPropagation();
            toastr.info("Second click denied. Please wait...");
            return false; // Return false to indicate the click is denied
        }
        
        return true; // Click allowed
    }

    // Initialize the variables for click tracking
    let lastClickElement = null;
    let lastClickTime = Date.now();
    // Double Click dine func end

    //loader 
    window.addEventListener("load", () => {
        const loader = document.querySelector(".loader");
        const loaderBody = document.querySelector(".loader-body");

        setTimeout(() => {
            loader.style.display = "none"; // Hide the loader
            loaderBody.style.display = "none"; // Hide the loader-body
        }, 1100); // Hide the loader after 0.75 seconds
    });

    // Function to run when the document is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        // radio button 
        // client
        var generalRadioButton = document.getElementById('id_general_bill');
        var clientRadioButton = document.getElementById('id_b2b_clients');

        // registration
        var registerRadioButton = document.getElementById('id_register');
        var nonRegRadioButton = document.getElementById('id_non_register');
        // ==============================================

        // client search body
        var clientSearchBody = document.getElementById('client_searchBody');
        var clientSalesTypeBody = document.getElementById('id_sales_type');

        // client Search Input
        var clientSearchInput = document.getElementById('client_searchInput');
        var b2bClientsInfo = document.getElementById('b2b_clients_info');
        // ==============================================

        var regSearchBody = document.getElementById('reg_searchBody');
        var regSearchInput = document.getElementById('reg_searchInput');
        // ==============================================


        //Clients body display block
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'block';
                clientSearchInput.style.display = 'block';
                b2bClientsInfo.style.display = 'block';
                clientSalesTypeBody.style.display = 'flex';
            }
        });

        //Clients body display none
        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                clientSearchBody.style.display = 'none';
                clientSearchInput.style.display = 'none';
                b2bClientsInfo.style.display = 'none';
                clientSalesTypeBody.style.display = 'none';
            }
        });


        //register body display block
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'block';
                regSearchInput.style.display = 'block';
            }
        });


        //register body display none
        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                regSearchBody.style.display = 'none';
                regSearchInput.style.display = 'none';
            }
        });
        
        //============================ button click wise value change ============================
        //client genaral butthon
        clientRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                generalRadioButton.value = "0";
                clientRadioButton.value = "1";
            }
        });

        generalRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                clientRadioButton.value = "0";
                generalRadioButton.value = "1";
            }
        });

        //register non register butthon
        registerRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the General Billing radio button to 0
                nonRegRadioButton.value = "0";
                registerRadioButton.value = "1";
            }
        });

        nonRegRadioButton.addEventListener('change', function () {
            if (this.checked) {
                // Set the value of the B2B Clients radio button to 1
                registerRadioButton.value = "0";
                nonRegRadioButton.value = "1";
            }
        });

        //saller buyer butthon
    });

    // id_non_register, id_register, id_general_bill, id_b2b_clients, id_buyer, id_seller click to change
    function toggleCheck(primaryId, secondaryId) {
        document.getElementById(primaryId).addEventListener('change', function () {
            document.getElementById(secondaryId).checked = false;
        });

        document.getElementById(secondaryId).addEventListener('change', function () {
            document.getElementById(primaryId).checked = false;
        });
    }

    toggleCheck('id_non_register', 'id_register');
</script>
{% endblock %}