{% load humanize %}
{% load static %}
<div class="container-fluid">
    <div id="creditprint">
        <section>
            <table class="table" style="width: 100%; margin-bottom: 0.2rem!important; margin-top: 0.2rem!important;">
                <tr>
                    <div class="receipt-logo">
                        <!-- <img class="com-receipt-logo" src="{{ ops_Data.id_org.org_logo.url }}" alt="logo"> -->
                    </div>
                </tr>
                <tr>
                    <center>
                        <label class="com-name">
                            <!-- Company Name Here -->
                            {{ org_data.org_name }}
                        </label>
                    </center>
                    <center class="sub-title_address">
                        <small>
                            <span class="com-address">
                                <span class="com-address-title">Address: </span>
                                <span class="com-address-name">{{ org_data.address }}</span>
                            </span>
                        </small>
                    </center>
                    <center class="sub-title2">
                        <small>
                            <span class="email-address-title">Email: </span>
                            <span class="com-address email-address-name">{{ org_data.email }}</span>
                            <span class="website-title">Website: </span>
                            <span class="website-name">{{ org_data.website }}</span>
                        </small>
                    </center>
                    <center class="sub-title3">
                        <small>
                            <span class="com-hotline">
                                <span class="com-hotline-title">Hotline: </span>
                                <span class="com-hotline-name">{{ org_data.phone }}, {{ org_data.hotline }}</span>
                                <span class="com-fax-title">Fax: </span>
                                <span class="com-fax-name">{{ org_data.fax }}</span>
                            </span>
                        </small>
                    </center>
                    <center class="sub-title3" style="margin-top: 0px;">
                        <small>
                            <span class="com-branch">
                                <span class="com-branch-title" style="font-size: 0.75rem; font-weight: bolder;">{{ branch_data.branch_name }}</span>
                            </span>
                        </small>
                    </center>
                    <center class="sub-title3" style="margin-top: 0.1rem;">
                        <small>
                            <span class="com-hotline">
                                <span class="com-hotline-title" style="font-size: 0.98rem;">
                                    Clients Credit Balance Report
                                </span>
                            </span>
                        </small>
                    </center>
                </tr>
            </table>
        </section>
        <section style="display: none;">
            <input type="hidden" id="id_supplier_id" name="supplier_value" value="{{ supplier.supplier_id }}" style="display: none;">
            <input type="hidden" id="id_branch_id" name="branch_value" value="{{ branch_data.branch_id }}" style="display: none;">
        </section>
        <section>
            <div class="requisition-info" style="margin-left: 7.2px; width: 97.9%; border: 1px solid;">
                <div class="row col-sm-12" style="font-size: 0.75rem; margin-top: 0.5rem;">
                    <div class="col-sm-6" style="display: flex;">
                        <label class="col-sm-3" style="text-align: right; font-weight: bolder;">Client Name:</label>
                        <div class="col-sm-8">
                            <span style="margin-left: 10px;">{{ supplier.supplier_name }}</span>
                        </div>
                    </div>
                    <!--  -->
                    <div class="col-sm-3" style="display: flex;">
                        <label class="col-sm-4" style="text-align: right; font-weight: bolder;">Phone:</label>
                        <div class="col-sm-8">
                            <span style="margin-left: 10px;">{{ supplier.phone }}</span>
                        </div>
                    </div>
                    <!--  -->
                    <div class="col-sm-3" style="display: flex;">
                        <label class="col-sm-4" style="text-align: right; font-weight: bolder;">Email:</label>
                        <div class="col-sm-8">
                            <span style="margin-left: 10px;">{{ supplier.supplier_email }}</span>
                        </div>
                    </div>
                    <!--  -->
                </div>
                <!--  -->
                <div class="row col-sm-12" style="font-size: 0.75rem; margin-top: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="col-sm-12" style="display: flex;">
                        <label class="col-sm-address" style="text-align: right; font-weight: bolder;">Address:</label>
                        <div class="col-sm-8">
                            <span style="margin-left: 10px;">{{ supplier.address }}</span>
                        </div>
                    </div>
                    <!--  -->
                </div>
                <!--  -->
            </div>
        </section>
        <!--  -->
        <section>
            <div class="card main-card">
                <div class="card-body card-body_item_setup">
                    <div style="overflow-x: auto;">
                        <table id="credit_trans_reportTB" class="table table-striped"
                            style="width: 100%; border: 1px solid; overflow-x: auto;">
                            <thead style="text-align: center;">
                                <tr style="font-size: 0.8rem; font-weight: bold;">
                                    <th style="width: 15%;">Trans ID</th>
                                    <th style="width: 20%;">Date</th>
                                    <th style="width: 30%;">Type of Payments</th>
                                    <th style="width: 15%;">Debit</th>
                                    <th style="width: 15%;">Credit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!--  -->
                                
                            </tbody>
                        </table>
                        <!--  -->
                        <table id="debit_credit_amt" class="table table-striped"
                            style="width: 100%; border: 1px solid rgb(211, 211, 211); margin-bottom: 0.2rem;">
                            <thead style="background: rgb(226, 226, 226);">
                                <tr style="font-size: 0.85rem">
                                    <th colspan="3" style="width: 68.5%; text-align: right;">
                                        Total Debit and Credit Amounts:
                                    </th>
                                    <th style="width: 15%; text-align: center;"><span id="total_debit_amt_rep"></span></th>
                                    <th style="width: 15%; text-align: center;"><span id="total_credit_amt_rep"></span></th>
                                </tr>
                            </thead>
                        </table>
                        <!--  -->
                        <table id="debit_credit_balance" class="table table-striped"
                            style="width: 100%; border: 1px solid rgb(211, 211, 211);">
                            <thead style="background: rgb(226, 226, 226);">
                                <tr style="font-size: 0.85rem">
                                    <th colspan="4" style="width: 69.5%; text-align: right;">Total Balance:</th>
                                    <th style="width: 31.5%; text-align: right;"><span id="total_balance_amt_rep"
                                            style="margin-right: 2rem;"></span></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <!--  -->
    </div>
    <hr>
    <div class="clear-fix py-3"></div>
    <!--  -->
    <div class="d-flex w-100 justify-content-end">
        <button class="btn btn-light bg-gradient border rounded-0 btn-sm me-1" type="button" id="supp_credit_Pnt">
            <i class='bx bxs-printer'></i>
            Print
        </button>
        <button class="btn btn-secondary bg-gradient border rounded-0 btn-sm" type="button" data-bs-dismiss="modal">
            <i class='bx bx-window-close'></i>
            Close
        </button>
    </div>
    <!--  -->
</div>
<script>

    $(document).ready(function () {
        function getCreditTransactionsReport(supplierId, branchId) {
            if (supplierId) {
                $.ajax({
                    url: "{% url 'get_credit_transactions' %}",
                    type: 'GET',
                    data: {
                        'supplier_id': supplierId,
                        'branch_id': branchId,
                    },
                    dataType: 'json',
                    success: function (response) {
                        // Clear the existing table body
                        $('#credit_trans_reportTB tbody').empty();
                        var totalDebitAmt = 0;
                        var totalCreditAmt = 0;
    
                        // Populate the table body with the new data
                        response.forEach(function (transaction, index) {
                            var debitPaymentId = 'id_debit_payment_' + index;
                            var creditPaymentId = 'id_credit_payment_' + index;
                            var row = $('<tr style="font-size: 0.8rem;">').append(
                                $('<td style="text-align: center;">').text(transaction.credit_id),
                                $('<td style="text-align: center;">').text(transaction.credit_pay_date),
                                $('<td style="text-align: left;">').text(transaction.type_of),
                                $('<td>').html('<input type="number" class="debit-payment-input" id="' + debitPaymentId + '" value="' + (transaction.debit_payment || '') + '" style="width: 100%; border: none; text-align: center; font-weight: 500; background: transparent;" readonly>'),
                                $('<td>').html('<input type="number" class="credit-payment-input" id="' + creditPaymentId + '" value="' + (transaction.credit_payment || '') + '" style="width: 100%; border: none; text-align: center; font-weight: 500; background: transparent;" readonly>'),
                            );
                            $('#credit_trans_reportTB tbody').append(row);
    
                            // Add debit payment to totalDebitAmt
                            if (!isNaN(transaction.debit_payment)) {
                                totalDebitAmt += parseFloat(transaction.debit_payment);
                            }
    
                            // Add credit payment to totalCreditAmt
                            if (!isNaN(transaction.credit_payment)) {
                                totalCreditAmt += parseFloat(transaction.credit_payment);
                            }
                        });
    
                        // Calculate the balance
                        var balance = totalDebitAmt - totalCreditAmt;
    
                        // Set the total debit and credit amounts
                        $('#total_debit_amt_rep').text(totalDebitAmt.toFixed(0));
                        $('#total_credit_amt_rep').text(totalCreditAmt.toFixed(0));
                        $('#total_balance_amt_rep').text(balance.toFixed(0));
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching credit transactions:', status, error);
                    }
                });
            } else {
                // Clear the table body
                $('#credit_trans_reportTB tbody').empty();
            }
        }
    
        var supplierId = $('#id_supplier_id').val();
        var branchId = $('#id_branch_id').val();
        getCreditTransactionsReport(supplierId, branchId);
    });

    //
    $(document).ready(function () {
        let companyInfo;
    
        // Make Ajax request to get user information
        $.ajax({
            type: 'GET',
            url: '/get_user_org_informations/',
            success: function (response) {
                // Store the companyInfo data
                companyInfo = response;
    
                // Now that you have the data, update the HTML
                updateCompanyInfoUI();
            },
            error: function (error) {
                console.error('Error fetching user information:', error);
            }
        });
    
        // Function to update the HTML with companyInfo
        function updateCompanyInfoUI() {
            // Check if companyInfo is defined
            if (companyInfo) {
                // Update the HTML content
                //$('.printed-by-name').text(`${companyInfo.first_name} ${companyInfo.last_name}`);
                $('.com-name').text(companyInfo.org_name);
                $('.com-address-name').text(companyInfo.address);
                $('.email-address-name').text(companyInfo.email);
                $('.website-name').text(companyInfo.website);
                $('.com-hotline-name').text(`${companyInfo.phone}, ${companyInfo.hotline}`);
                $('.com-fax-name').text(companyInfo.fax);
                // Display the organization logo
                if (companyInfo.org_logo) {
                    $('.com-receipt-logo').attr('src', companyInfo.org_logo);
                }
            } else {
                // Handle the case where companyInfo is not available
                console.error('Company information is not available.');
            }
        }

        //
        $('#supp_credit_Pnt').click(function () {
            var head = $('head').clone();
            var p = $('#creditprint').clone();
            var el = $("<div>");

            // Append custom styles to the head
            head.append('<style>body{background-color:unset !important}</style>');

            // Append title to the head
            el.find('title').text("Software By : TBOX, Contact: +8801309-994317");
            head.append('<style>.footer { position: fixed; bottom: 0; text-align: left; width: 100%; }</style>');

            const footerText = 'TBOX, Contact: +8801309-994317,';
            const now = new Date();
            const formattedDateTime = now.toLocaleString();
            const pageNumber = 1;

            // Append your footer content
            var footerContent =
                `<div class="footer">
                <span class="software-woner-title">Software By: </span>
                <span class="software-woner-name">${footerText}</span>
                <span class="printed-by-title">- Printed By: </span>
                <span class="printed-by-name">${companyInfo.first_name} ${companyInfo.last_name}</span>
                <span class="printed-on-title">- Printed on: </span>
                <span class="printed-on-date">${formattedDateTime}</span>
                <span class="printed-page-title">- Page </span>
                <span class="printed-page-no">${pageNumber}</span>
            </div>`;
            p.append(footerContent);

            // Append the modified head and content to the new window
            el.append(head);
            el.append(p);

            var nw = window.open('', '_blank', "width=800,height=800,left=300, top=200");
            nw.document.write(el.html());
            nw.document.close();

            setTimeout(() => {
                nw.print();
                setTimeout(() => {
                    nw.close();
                }, 250);
            }, 300);
        });
    });
</script>