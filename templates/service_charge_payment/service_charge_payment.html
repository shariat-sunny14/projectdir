{% extends 'base_form/main_base/main_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block extra_link %}
<!--========== CSS ==========-->
<link rel="stylesheet" href="{% static 'item_pos_style/css/item_pos_style.css' %}">
<link rel="stylesheet" href="{% static 'credit_management/css/credit_management.css' %}">
<link rel="stylesheet" href="{% static 'drivers_setup/css/drivers_setup.css' %}">
<style>
    /* Hide calendar and month (for year picker only) */
    .hide-calendar .ui-datepicker-calendar,
    .hide-calendar .ui-datepicker-month {
        display: none !important;
    }

    /* Hide Today and Done buttons */
    .hide-calendar .ui-datepicker-buttonpane {
        display: none !important;
    }
</style>
<!--========== from js file ==========-->
<script src="{% static 'drivers_setup/js/drivers_setup.js' %}"></script>
{% endblock %}
<!--========== CONTENTS start==========-->
{% block body %}
{% if user.is_superuser %}
<main>
    <section class="container-fluid" style="margin-top: 0.5rem; margin-bottom:0.5rem; background: #d9e9e3e3;">
        <section style="border: 1px solid rgba(0, 0, 0, .125); border-top: none; border-radius: 0.3rem;">
            <div style="border: 1px solid rgba(0, 0, 0, .125);
            margin-bottom: 0.5rem;
            border-left: none;
            border-right: none;
            border-top-left-radius: 0.3rem;
            border-top-right-radius: 0.3rem;
            background: #459778e3;">
                <!-- Main Heading -->
                <div class="row">
                    <div class="col col-md-4 col-md-6 dashboar-head" style="display:flex;">
                        <div class="d-sm-flex align-items-center mb-2"
                            style="height: 1.5rem; width: 100%; margin-left: 1rem;">
                            <i class='bx bx-folder-open text-white req-head-icon'></i>
                            <h1 class="h3 text-white req-head">Service Charge Payment Management</h1>
                            <!--  -->
                        </div>
                    </div>
                </div>
            </div>
            <!--  -->
            <form action="" method="" id="SERCHARPAYFORM" enctype="multipart/form-data">
                <input type="hidden" id="id_service_id" name="service_id" value="" autocomplete="off">
                <!--  -->
                <section>
                    <div class="row row_item_setup">
                        <!--  -->
                        <div class="col-md-12">
                            <div class="card main-card" style="background: #d9e9e3e3;">
                                <div class="card-body card-body_org_setup">
                                    <div class="row row_item_setup">
                                        <div class="col-md-4">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_org"
                                                            class="col-md-19 col-form-label font_size_filter required">
                                                            Org:
                                                        </label>
                                                        <div class="col-sm-75">
                                                            <select id="id_org" name="org_id" style="z-index: 0;"
                                                                class="form-select Selectionbox"
                                                                aria-label="Default select example" required>

                                                                {% for org in org_list %}
                                                                <option id="{{org.org_id}}" value="{{org.org_id}}">
                                                                    {{org.org_name}}
                                                                </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-md-2">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_service_year"
                                                            class="col-sm-35 col-form-label font_size_filter required">
                                                            Year:
                                                        </label>
                                                        <div class="col-sm-60">
                                                            <input type="text" class="form-control item_inputbox datepicker" style="text-align: center;" id="id_service_year" name="service_year" autocomplete="off" required>
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-md-25">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_service_amt"
                                                            class="col-sm-35 col-form-label font_size_filter required">
                                                            Ser. Amt:
                                                        </label>
                                                        <div class="col-sm-60">
                                                            <input type="text" class="form-control item_inputbox" style="text-align: center;" id="id_service_amt" name="service_amt" autocomplete="off" readonly required>
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-md-25">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_service_payment"
                                                            class="col-sm-35 col-form-label font_size_filter required">
                                                            Pay Amt:
                                                        </label>
                                                        <div class="col-sm-60">
                                                            <input type="text" class="form-control item_inputbox" style="text-align: center;" id="id_service_payment" name="service_payment" autocomplete="off" readonly required>
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--  -->
                        <div class="col-md-12">
                            <div class="card main-card" style="background: #d9e9e3e3;">
                                <div class="card-body card-body_org_setup">
                                    <div class="row row_item_setup">
                                        <div class="col-md-4">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_payment_trans_id"
                                                            class="col-md-19 col-form-label font_size_filter">
                                                            Trans. Id:
                                                        </label>
                                                        <div class="col-sm-75">
                                                            <input type="text" class="form-control item_inputbox" style="text-align: left;" id="id_payment_trans_id" name="payment_trans_id" autocomplete="off">
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="col-md-8">
                                            <div class="card main-card" style="background: #d9e9e3e3;">
                                                <div class="card-body item_setup_sub">
                                                    <div class="row cash_point_row">
                                                        <!--  -->
                                                        <label for="id_reference"
                                                            class="col-sm-8-8smody col-form-label font_size_filter">
                                                            Reference:
                                                        </label>
                                                        <div class="col-sm-89-4">
                                                            <input type="text" class="form-control item_inputbox" style="text-align: left;" id="id_reference" name="reference" autocomplete="off">
                                                        </div>
                                                        <!--  -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--  -->
                        <div class="col-sm-12">
                            <div class="card main-card" style="background: #d9e9e3e3;">
                                <div class="card-body card-body_org_setup">
                                    <div class="row row_item_setup">
                                        <div class="col-sm-12" style="display: flex; flex-direction: row; flex-wrap: wrap; align-content: center; align-items: center; justify-content: flex-start;">
                                            <label for="id_branch_name" class="col-sm-1mody col-form-label font_size_filter required">
                                                Month:
                                            </label>
                                            <div class="col-sm-9" style="display: flex;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="january" id="january" name="service_month[]">
                                                    <label class="form-check-label" for="january" style="padding-right: 8px; font-size: 13px;">
                                                        January
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="february" id="february" name="service_month[]">
                                                    <label class="form-check-label" for="february" style="padding-right: 8px; font-size: 13px;">
                                                        February
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="march" id="march" name="service_month[]">
                                                    <label class="form-check-label" for="march" style="padding-right: 8px; font-size: 13px;">
                                                        March
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="april" id="april" name="service_month[]">
                                                    <label class="form-check-label" for="april" style="padding-right: 8px; font-size: 13px;">
                                                        April
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="may" id="may" name="service_month[]">
                                                    <label class="form-check-label" for="may" style="padding-right: 8px; font-size: 13px;">
                                                        May
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="june" id="june" name="service_month[]">
                                                    <label class="form-check-label" for="june" style="padding-right: 8px; font-size: 13px;">
                                                        June
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="july" id="july" name="service_month[]">
                                                    <label class="form-check-label" for="july" style="padding-right: 8px; font-size: 13px;">
                                                        July
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="august" id="august" name="service_month[]">
                                                    <label class="form-check-label" for="august" style="padding-right: 8px; font-size: 13px;">
                                                        August
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="september" id="september" name="service_month[]">
                                                    <label class="form-check-label" for="september" style="padding-right: 8px; font-size: 13px;">
                                                        September
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="october" id="october" name="service_month[]">
                                                    <label class="form-check-label" for="october" style="padding-right: 8px; font-size: 13px;">
                                                        October
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="november" id="november" name="service_month[]">
                                                    <label class="form-check-label" for="november" style="padding-right: 8px; font-size: 13px;">
                                                        November
                                                    </label>
                                                </div>
                                                <!--  -->
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="december" id="december" name="service_month[]">
                                                    <label class="form-check-label" for="december" style="padding-right: 8px; font-size: 13px;">
                                                        December
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--  -->
                        {% if user.is_superuser %}
                        <div class="col-sm-12">
                            <div class="card main-card" style="background: #d9e9e3e3;">
                                <div class="card-body card-body_org_setup">
                                    <div class="row row_item_setup">
                                        <div class="col-sm-12" style="display: flex; flex-direction: row; flex-wrap: wrap; align-content: center; align-items: center; justify-content: flex-start;">
                                            <label for="id_branch_name" class="col-sm-1mody col-form-label font_size_filter required">
                                                Modes:
                                            </label>
                                            <div class="col-sm-9" style="display: flex;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" value="0" id="id_is_passing" name="is_passing" checked>
                                                    <label class="form-check-label" for="id_is_passing" style="padding-right: 8px; font-size: 13px;">
                                                        Is Passing
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" value="0" id="id_is_approved" name="is_approved">
                                                    <label class="form-check-label" for="id_is_approved" style="padding-right: 8px; font-size: 13px;">
                                                        Is Approved
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </section>
                <!-- submit button -->
                <div class="submit_button">
                    <button type="submit" value="submit" id="paymentSubmitBtn" class="btn btn-success btn-sm"
                        style="margin-right: 10px;">
                        Save Payment
                    </button>
                </div>
            </form>
            <!--  -->
        </section>
    </section>
    <!--  -->
    <section class="container-fluid" style="margin-top: 1rem; margin-bottom:0.5rem;">
        <section style="border: 1px solid rgba(0, 0, 0, .125); border-top: none; border-radius: 0.3rem;">
            <div style="border: 1px solid rgba(0, 0, 0, .125);
            margin-bottom: 0.5rem;
            border-left: none;
            border-right: none;
            border-top-left-radius: 0.3rem;
            border-top-right-radius: 0.3rem;
            background: #456f97e3;">
                <!-- Main Heading -->
                <div class="row">
                    <div class="col col-md-4 col-md-6 dashboar-head" style="display:flex;">
                        <div class="d-sm-flex align-items-center mb-2"
                            style="height: 1.5rem; width: 100%; margin-left: 1rem;">
                            <i class='bx bx-folder-open text-white req-head-icon'></i>
                            <h1 class="h3 text-white req-head">Service Charge Payment Management History/List</h1>
                            <!--  -->
                        </div>

                    </div>
                </div>
            </div>
            <!--  -->
            <!--  -->
            <section>
                <div class="card po_card"
                    style="margin-left: 0.5rem; margin-right: 0.5rem; margin-bottom: 1rem; background: whitesmoke;">
                    <div class="card-body">
                        <div class="report-filter">
                            <!-- Date Range Filter -->
                            <div class="date-range">
                                <div class="row date_range-body" style="display:flex; font-size: 0.8rem;">
                                    <div class="date_range-element col-sm-12" style="display:flex">
                                        <!--  -->
                                        <div class="row store_row col-sm-6"
                                            style="flex-grow: 1; display: flex; justify-content: flex-start; flex-direction: row; flex-wrap: nowrap; align-items: center;">
                                            <label for="id_filter_org" class="col-auto col-form-label">
                                                Org:
                                            </label>
                                            <div class="col-sm-8">
                                                <select id="id_filter_org" name="filter_org"
                                                    class="form-select store_Selectbox"
                                                    aria-label="Default select example">
                                                    {% for org in org_list %}
                                                    <option id="{{org.org_id}}" value="{{org.org_id}}">
                                                        {{org.org_name}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <!--  -->
                                        <div class="row store_row col-sm-6" style="flex-grow: 3; display: flex; justify-content: right;">
                                            <!--  -->
                                            <label for="id_service_year_filter" class="col-auto col-form-label font_size_filter required">
                                                Year:
                                            </label>
                                            <div class="col-sm-60">
                                                <input type="text" class="form-control item_inputbox datepicker" style="text-align: center;" id="id_service_year_filter" name="service_year_filter" autocomplete="off" required>
                                            </div>
                                            <!--  -->
                                        </div>
                                        <!--  -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!--  -->
            <section style="margin-left: 0.5rem; margin-right: 0.5rem;">
                <div class="module-table">
                    <table id="carrying_table" class="table table-striped table-hover"
                        style="width: 100%; border: 1px solid #6aa2a8;">
                        <thead class="text-center table-header_itemlist" style="font-size: 0.8rem;">
                            <tr>
                                <th style="text-align:center;">
                                    Service ID
                                </th>
                                <th style="text-align:center;">
                                    Creator Date
                                </th>
                                <th style="text-align:center;">
                                    Organization
                                </th>
                                <th style="text-align:center;">
                                    Service Month
                                </th>
                                <th style="text-align:center;">
                                    Service Amt.
                                </th>
                                <th style="text-align:center;">
                                    Service Payment
                                </th>
                                <th style="text-align:center;">
                                    Transaction ID
                                </th>
                                <th style="text-align:center;">
                                    Reference
                                </th>
                                <th style="text-align:center;">
                                    Status
                                </th>
                                <th style="text-align:center;">
                                    Option
                                </th>
                            </tr>
                        </thead>
                        <tbody id="servicepayTB" style="text-align:center; font-size: 0.85rem;">
                            <!--  -->

                        </tbody>

                        <!-- loader start -->
                        <div class="loader"></div>
                        <!-- loader end -->
                    </table>
                </div>
            </section>
        </section>
    </section>
</main>
{% else %}
<div class="container" style="margin-top: 5rem;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-warning text-center" role="alert">
                You do not have permission to access this page.
            </div>
        </div>
    </div>
</div>
{% endif %}
<!-- present date show scriptStart  -->
<script>
    /////////
    document.addEventListener('DOMContentLoaded', function () {
        const passingRadio = document.getElementById('id_is_passing');
        const approvedRadio = document.getElementById('id_is_approved');

        function updateValues() {
            if (passingRadio.checked) {
                passingRadio.value = "1";
                approvedRadio.value = "0";
            } else if (approvedRadio.checked) {
                passingRadio.value = "0";
                approvedRadio.value = "1";
            } else {
                // Optional: If none is selected (manually unselected via script)
                passingRadio.value = "0";
                approvedRadio.value = "0";
            }
        }

        passingRadio.addEventListener('change', function () {
            if (this.checked) {
                approvedRadio.checked = false;
            }
            updateValues();
        });

        approvedRadio.addEventListener('change', function () {
            if (this.checked) {
                passingRadio.checked = false;
            }
            updateValues();
        });

        // Initial run
        updateValues();
    });
    ////////////////////
    $(document).ready(function () {
        // Set current year on page load
        const currentYear = new Date().getFullYear();
        $('#id_service_year').val(currentYear);

        // Initialize the year-only datepicker
        $('#id_service_year').datepicker({
            changeYear: true,
            showButtonPanel: true,
            dateFormat: 'yy',
            onClose: function (dateText, inst) {
                const selectedYear = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                $(this).datepicker('setDate', new Date(selectedYear, 0, 1)).trigger('change'); // trigger change to reload
            },
            beforeShow: function (input, inst) {
                $(input).datepicker("widget").addClass("hide-calendar");
            }
        });

        function loadPaidMonths() {
            const org_id = $('#id_org').val();  // Corrected ID
            const service_year = $('#id_service_year').val();

            if (!org_id || !service_year) return;

            $.ajax({
                url: '/get_paid_service_months/',
                method: 'GET',
                data: {
                    org_id: org_id,
                    service_year: service_year
                },
                success: function (response) {
                    const paidMonths = response.paid_months;

                    $('input[name="service_month[]"]').each(function () {
                        const month = $(this).val().toLowerCase();

                        if (paidMonths.includes(month)) {
                            $(this).prop('checked', true).prop('disabled', true);
                        } else {
                            $(this).prop('checked', false).prop('disabled', false);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.log("Error loading paid months:", error);
                }
            });
        }

        // Load paid months after setting default year
        setTimeout(function () {
            loadPaidMonths();
        }, 300);  // slight delay to ensure datepicker is set

        // Reload when org or year changes
        $('#id_org, #id_service_year').on('change keyup paste', function () {
            loadPaidMonths();
        });
    });
    ///////////////////////
    $(document).ready(function () {

        function calculateServicePayment() {
            // Total checked and enabled months only
            const checkedMonths = $('input[name="service_month[]"]:checked:enabled').length;

            // Get service amount and convert to number
            const serviceAmt = parseFloat($('#id_service_amt').val()) || 0;

            // Calculate total
            const totalPayment = checkedMonths * serviceAmt;

            // Show result
            $('#id_service_payment').val(totalPayment.toFixed(0)); // round to whole number
        }

        // Recalculate whenever checkbox state changes
        $('input[name="service_month[]"]').on('change', calculateServicePayment);

        // Recalculate if service amount input changes
        $('#id_service_amt').on('input', calculateServicePayment);

        // Initial calculation on page load
        calculateServicePayment();
    });
    ////////////////////////////////
    $(document).ready(function () {
        function fetchServiceCharge() {
            const orgID = $('#id_org').val();
            const service_year = $('#id_service_year').val();

            if (orgID) {
                $.ajax({
                    url: "{% url 'get_service_charge_by_org' %}",
                    type: 'GET',
                    data: {
                        'org_id': orgID,
                        'service_year': service_year
                    },
                    success: function (response) {
                        $('#id_service_amt').val(response.service_charge);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching service charge:", error);
                        $('#id_service_amt').val('');
                    }
                });
            } else {
                $('#id_service_amt').val('');
            }
        }

        // Call when user changes organization
        $('#id_org').on('change', fetchServiceCharge);

        // Also call once on page load for pre-selected organization
        fetchServiceCharge();
    });
    //////////////////
    //
    $(function () {
        // Prevent Enter key from submitting the form
        $('#SERCHARPAYFORM').on('keydown', function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                return false;
            }
        });

        $('#SERCHARPAYFORM').submit(function (e) {
            e.preventDefault();

            // Check only checked and enabled checkboxes
            if ($('input[name="service_month[]"]:checked:enabled').length === 0) {
                toastr.info('Please select at least one unpaid (enabled) service month before submitting.');
                return false;
            }

            var formData = new FormData($(this)[0]);
            $('#paymentSubmitBtn').prop('disabled', true).html('<i class="bx bx-loader-circle"></i> Processing...');

            $.ajax({
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                url: "{% url 'save_service_charge_payment' %}",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                dataType: 'json',
                success: function (resp) {
                    if (resp.msg) {
                        toastr.success(resp.msg);
                        location.reload();
                    } else {
                        toastr.error(resp.errmsg || 'Error occurred');
                    }
                },
                complete: function () {
                    setTimeout(function () {
                        $('#paymentSubmitBtn').prop('disabled', false).html('Save Payment');
                    }, 1500);
                }
            });
        });
    });
    //
    // get user table data
    $(document).ready(function () {

        // Set current year on page load
        const currentYear = new Date().getFullYear();
        $('#id_service_year_filter').val(currentYear);

        // Initialize the year-only datepicker
        $('#id_service_year_filter').datepicker({
            changeYear: true,
            showButtonPanel: true,
            dateFormat: 'yy',
            onClose: function (dateText, inst) {
                const selectedYear = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                $(this).datepicker('setDate', new Date(selectedYear, 0, 1));
                $(this).val(selectedYear); // Set only year
                $(this).trigger('change'); // Trigger change so filterExpenses runs
            },
            beforeShow: function (input, inst) {
                $(input).datepicker("widget").addClass("hide-calendar");
            }
        });

        filterExpenses();

        $('#id_filter_org, #id_service_year_filter').on('change', function () {
            filterExpenses();
        });

        function filterExpenses() {
            var org_id = $('#id_filter_org').val() || '';
            var service_year = $('#id_service_year_filter').val() || '';

            var filterParams = {
                org_id: org_id,
                service_year: service_year
            };

            $.ajax({
                url: '/get_service_charge_payment_list/',
                type: 'GET',
                data: filterParams,
                dataType: 'json',
                beforeSend: function () {
                    startLoader();
                },
                success: function (data) {
                    if ($.fn.DataTable.isDataTable('#carrying_table')) {
                        $('#carrying_table').DataTable().destroy();
                    }

                    updateTable(data.service_val); // use correct key
                    $('#carrying_table').DataTable({ ordering: false });

                    endLoader();
                },
                error: function (error) {
                    console.error('Error fetching data:', error);
                    endLoader();
                }
            });
        }

        function updateTable(service_val) {
            var tableBody = $('#servicepayTB');
            tableBody.empty();

            $.each(service_val, function (index, item) {

                var approveStatus = item.is_approved ? 'Is Approved' : 'Is Passing';
                var approveColor = item.is_approved ? 'green' : 'red';

                var row = `
                    <tr style="height: 3rem;">
                        <td>${item.service_id || ''}</td>
                        <td>${item.creater_date || ''}</td>
                        <td>${item.org_name || ''}</td>
                        <td>${item.service_month || ''}-${item.service_year || ''}</td>
                        <td>${item.service_amt !== null ? parseFloat(item.service_amt).toFixed(2) : '0.00'}</td>
                        <td>${item.service_payment !== null ? parseFloat(item.service_payment).toFixed(2) : '0.00'}</td>
                        <td>${item.payment_trans_id || ''}</td>
                        <td>${item.reference || ''}</td>
                        <td style="color: ${approveColor}; font-weight: bold;">${approveStatus}</td>
                        <td>
                            <button class="btn btn-sm btn-success approve-btn" style="padding: .15rem .7rem;" data-is_approved="${item.is_approved}" 
                                data-service_id="${item.service_id}">
                                Approve
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" style="padding: .15rem .7rem;" data-is_approved="${item.is_approved}" 
                                data-service_id="${item.service_id}">
                                X
                            </button>
                        </td>
                    </tr>`;
                tableBody.append(row);
            });
        }
    });

    //
    $(document).ready(function () {

        $('#id_filter_org').change(function () {
            OrgWiseUpdateFilterOptions();
        });

        OrgWiseUpdateFilterOptions();

        function OrgWiseUpdateFilterOptions() {
            var selectedOrgId = $('#id_filter_org').val();

            // Branch option value
            $.ajax({
                url: '/get_branch_options/',
                method: 'GET',
                data: { org_id: selectedOrgId },
                success: function (data) {
                    $('#id_filter_branch').empty();
                    $.each(data.branch_list, function (index, branch) {
                        $('#id_filter_branch').append('<option value="' + branch.branch_id + '">' + branch.branch_name + '</option>');
                    });
                    $('#id_filter_branch').trigger('change');
                },
                error: function (error) {
                    console.error('Error fetching branch options:', error);
                }
            });
        }
    });

    // loader start
    function startLoader() {
        const loader = document.querySelector(".loader");
        loader.classList.remove("loader-hidden");
    }

    function endLoader() {
        const loader = document.querySelector(".loader");
        loader.classList.remove("loader-hidden");
        setTimeout(() => {
            loader.classList.add("loader-hidden");
        }, 500);
    }
    //loader end

    $(document).on('click', '.delete-btn', function () {
        lineloaderstart();
        const serviceid = $(this).data('service_id'); // Fetch opb_id dynamically
        const IsApproved = $(this).data('is_approved');
        if (IsApproved) {
            toastr.error('Cannot delete approved service charge payment.');
            lineloaderstop();
            return;
        }
        modal_md("Delete Confirmation", `{% url 'delete_service_charge_payment' %}?service_id=${serviceid}`);
        lineloaderstop();
    });
</script>

{% endblock %}